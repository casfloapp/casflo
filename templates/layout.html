<!DOCTYPE html>
<!-- [PERBAIKAN] Tag <html> ditambahkan untuk mode gelap -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casflo</title>
    
    <!-- [PERBAIKAN KUNCI] Skrip CDN Tailwind HARUS dimuat SEBELUM skrip konfigurasi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind
        tailwind.config = {
            darkMode: 'class' // Memberitahu Tailwind untuk mencari class="dark" di <html>
        }; // <-- [PERBAIKAN KUNCI] TITIK KOMA DITAMBAHKAN DI SINI

        // Skrip ini harus ada di <head> untuk mencegah layar putih berkedip (flickering)
        // saat mode gelap aktif.
        (function() {
            const settingsKey = 'casflo';
            let theme = 'system';
            try {
                const settings = localStorage.getItem(settingsKey);
                if (settings) {
                    theme = JSON.parse(settings).theme || 'system';
                }
            } catch (e) {
                // Biarkan default 'system'
            }
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Global & Halaman Utama */
        :root {
            --primary-blue: #4A47A3;
            --light-purple: #E6E6FA;
            --text-dark: #333;
            --text-light: #888;
            --expense-red: #E84545;
            --income-green: #51CF66;
            --bg-gray: #f4f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html { height: -webkit-fill-available; }
        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            touch-action: manipulation; 
        }
        .app-container { 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        }

        /* [BARU] Aturan CSS untuk Mode Gelap */
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark .app-container {
            background-color: #111827; /* dark:bg-gray-800 */
        }
        .dark .card {
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            box-shadow: none;
        }
        .dark .main-content {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .dark .transaction-list, .dark .empty-transaction-list, .dark .category-list-card,
        .dark .account-list {
            color: #d1d5db;
        }
        .dark .transaction-item, .dark .account-item {
            border-bottom-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .overview-card .stat-item .label, .dark .transaction-item .info .account, 
        .dark .transaction-item .details .notes, .dark .account-section-header,
        .dark .account-item .balance-info .currency, .dark .filter-bar {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .overview-card .date-selector, .dark .header-title, .dark .header-top .left .fa-search {
            color: white;
        }
        .dark .calendar-card, .dark .calendar-summary-tabs .tab {
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .calendar-summary-tabs .tab.active {
            color: var(--primary-blue);
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .dark .bottom-nav {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border-top: 1px solid #374151;
        }
        .dark .nav-item {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .nav-item.active {
            color: #ffffff; /* Tetap biru agar menonjol */
        }
        .dark .fab {
            background-color: #374151;
            color: #ffffff;
            border: 1px solid #4b5563;
        }
        .dark .more-grid .grid-item {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-header, .dark .analysis-header, .dark .more-header {
             background: var(--primary-blue); /* Tetap biru */
             cursor: pointer;
        }
        .dark .account-list {
             background-color: #374151;
        }
        .dark .stats-container .amount, .dark .account-item .details, .dark .account-item .balance-info .amount {
            color: white;
        }
        .dark .stats-container .main-balance .amount {
             color: white;
        }
        .dark .account-item .balance-info .amount.expense,
        .dark .overview-card .stat-item .amount.expense {
            color: var(--expense-red);
        }
        .dark .donut-chart-card, .dark .category-list-card {
            background-color: #374151;
        }
        .dark .donut-chart-center .amount {
            color: white;
        }
        .dark .add-view-container {
            background-color: #1f2937;
        }
        .dark .add-header, .dark .categories-section {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .dark .type-selector-header {
            background: #1f2937;
        }
        .dark .type-btn-header {
            color: #9ca3af;
        }
        .dark .type-btn-header.active {
            background: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dark .type-btn-header.expense.active { color: var(--expense-red); }
        .dark .type-btn-header.income.active { color: var(--income-green); }
        .dark .calculator-section {
            background: #1f2937; /* Latar gelap */
            border-top-color: #4b5563;
            /* Semua properti (position, height, dll) di-inherit dari .calculator-section utama */
        }
        .dark .amount-display, .dark .action-btn, .dark .calc-btn {
            background: #374151;
            color: #d1d5db;
            box-shadow: none;
        }
        .dark .action-btn.personal {
            background: #111827;
        }
        .dark .calc-btn.operator {
            background: #ccc;
        }
        .dark .category-item:hover {
            background: #4b5563;
        }
        
        /* [BARU] Sembunyikan summary harian saat di-masking */
        .balance-masked .transaction-list .list-header .summary {
            display: none;
        }

        /* ... Sisa CSS Global Anda ... */
        .main-header { background: var(--primary-blue); color: white; padding: 20px 20px 20px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; flex-shrink: 0; z-index: 10; 
        max-width: 480px;
        position: fixed;
        margin: 0 auto;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-top .left { display: flex; align-items: center; gap: 18px; }
        .view-toggle-group { 
            display: flex; 
            align-items: center; 
            background: rgba(255,255,255,0.1); 
            border-radius: 20px; 
            padding: 4px; 
            height: 43px;
            width: 150px; /* [PERBAIKAN] Paksa lebar agar sama dengan .skeleton-view-toggle */
            justify-content: center; /* [TAMBAHAN] Agar tombol di dalamnya tetap rapi di tengah */
        }
        .toggle-btn { background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 16px; display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; flex-grow: 1; justify-content: center; }
        .toggle-btn.active-view { background: rgba(255,255,255,0.1); }
        .toggle-btn span { display: inline-block; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out, margin-left 0.3s ease-in-out; max-width: 100px; opacity: 1; margin-left: 5px; overflow: hidden; }
        .toggle-btn:not(.active-view) span { max-width: 0; opacity: 0; margin-left: 0; }
        /*.toggle-btn:not(.active-view) { padding: 8px 10px; }*/
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .header-actions {
            display: flex;
            gap: 10px; /* Jarak antar tombol dompet */
            overflow-x: auto; /* Aktifkan scroll horizontal jika dompet banyak */
            padding-bottom: 0px; /* Beri ruang untuk scrollbar (opsional) */
        }
        /* Sembunyikan scrollbar */
        .header-actions::-webkit-scrollbar,
        .main-content::-webkit-scrollbar,
        .categories-section::-webkit-scrollbar { 
            display: none; /* WebKit (Chrome, Safari, iOS) */
        }
        .header-actions,
        .main-content,
        .categories-section { 
            -ms-overflow-style: none;  /* IE dan Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .action-box { 
            background: rgba(255,255,255,0.1); /* Latar belakang redup (default) */
            border-radius: 12px; 
            padding: 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-shrink: 0; /* Mencegah tombol menyusut */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .action-box .icon { 
            background: rgba(255,255,255,0.2); 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 8px; 
            font-size: 20px; /* Untuk emoji */
        }
        .action-box .text {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap; /* Jaga agar nama tidak turun baris */
            /* [KUNCI] Sembunyikan nama secara default */
            display: none; 
        }/* [BARU] CSS untuk tombol aksi ikon-saja */
        .action-box.icon-only {
            flex: 0 1 auto; /* Jangan memanjang, biarkan ukuran auto */
            gap: 0; /* Hapus jarak karena tidak ada teks */
        }
        .action-box.icon-only .icon {
             margin: 0; /* Hapus margin jika ada */
        }
        .action-box.active .text {
            display: block;
        }

        /* [KUNCI] Warna berbeda untuk yang aktif */
        .action-box.active {
            background: rgba(255,255,255,0.3); /* Lebih terang */
        }
        /* [AKHIR BARU] */

        .main-content { flex: 1; overflow-y: auto; padding: 0 20px; position: relative; z-index: 5; padding-bottom: 100px; padding-top: 170px;}
        .card { background: white; border-radius: 18px; margin-bottom: 20px; margin-top: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); padding: 18px; }
        .empty-transaction-list { text-align: center; color: #888; padding: 40px 0; }
        .view-hidden { display: none; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        
        /* PERBAIKAN: Tata letak untuk view Detail & Kalender disederhanakan */
        .view-hidden {
            display: none;
        }
        .overview-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overview-card .card-header .icon { width: 40px; height: 40px; background: var(--light-purple); color: var(--primary-blue); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .overview-card .date-selector { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .overview-card .date-selector i { cursor: pointer; }
        .overview-card .card-actions { display: flex; gap: 12px; }
        .overview-card .card-actions .icon { color: var(--text-light); }
        .overview-card .card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; padding-top: 5px; }
        .overview-card .stat-item .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .overview-card .stat-item .amount { font-size: 16px; font-weight: 700; }
        .amount.expense { color: var(--expense-red); }
        .amount.income { color: var(--income-green); }
        .overview-card .stat-item .amount { 
            /* font-size: 16px; */ /* Dihapus agar bisa dinamis */
            font-weight: 700;
            display: flex; /* [PERBAIKAN] Menggunakan flex untuk center */
            justify-content: center; /* [PERBAIKAN] Center horizontal */
            align-items: center; /* [PERBAIKAN] Center vertikal */
            min-height: 1.2em; /* Mencegah 'loncat' saat loading */
            line-height: 1.2; /* [PERBAIKAN] Untuk font dinamis */
        }
        .calendar-card .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 600; }
        .calendar-card .calendar-header i { cursor: pointer; }
        .calendar-card .calendar-header .month-year { font-size: 16px; }
        .calendar-card .calendar-header .btn-month-toggle { background-color: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; }
        .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day { font-size: 14px; padding: 5px 0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; cursor: pointer; }
        .calendar-grid .day.weekend { color: var(--expense-red); }
        .calendar-grid .day.selected .date-number { background-color: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .calendar-grid .day .day-summary { font-size: 8px; color: white; background-color: var(--expense-red); border-radius: 5px; padding: 1px 3px; position: absolute; bottom: 0; }
        .calendar-summary-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid var(--bg-gray); padding-bottom: 20px; }
        .calendar-summary-tabs .tab { background: none; border: 1px solid #ddd; border-radius: 20px; padding: 6px 15px; font-size: 13px; color: var(--text-light); cursor: pointer; }
        .calendar-summary-tabs .tab.active { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-purple); }
        .calendar-summary-amounts { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .calendar-summary-amounts .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .calendar-summary-amounts .amount { 
            /* font-size: 16px; */ /* Dihapus agar dinamis */
            font-weight: 700;
            display: flex; /* [BARU] */
            justify-content: center; /* [BARU] */
            align-items: center; /* [BARU] */
            min-height: 1.2em; /* [BARU] */
            line-height: 1.2; /* [BARU] */
        }
        .calendar-summary-amounts .amount.expense { color: var(--expense-red); }
        .calendar-summary-amounts .amount.income { color: var(--income-green); } /* [BARU] */
        .transaction-list .list-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding-bottom: 8px; /* [PERBAIKAN] Memberi jarak ke item di bawahnya */
        }
        .transaction-list .list-header .date-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .transaction-list .list-header .summary { 
            font-size: 13px; 
            color: var(--text-light); 
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
        }
        .transaction-item { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 12px 0; /* [PERBAIKAN] Hapus padding horizontal (kiri/kanan) */
            border-bottom: 1px solid var(--bg-gray); 
        }
        .transaction-item:last-child { border-bottom: none; }
        /* [PERBAIKAN] Aturan di bawah ini DIHAPUS karena menyebabkan jarak atas tidak rata */
        /* .transaction-item:first-of-type { padding-top: 5px; } */
        .transaction-item .icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .category { font-weight: 600; font-size: 15px; }
        .transaction-item .details .notes { font-size: 12px; color: var(--text-light); }
        .transaction-item .info { text-align: right; }
        .transaction-item .info .amount { font-weight: 700; color: var(--expense-red); font-size: 15px; }
        .transaction-item .info .account { font-size: 12px; color: var(--text-light); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; color: var(--primary-blue); z-index: 15; text-decoration: none; }
        .fab i { font-size: 22px; }
        .bottom-nav { border-top-left-radius: 25px;border-top-right-radius: 25px;position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        .add-view { display: flex; flex-direction: column; height: 100svh;display: flex;
        flex-direction: column;
        height: 100vh;
        height: 100svh;
        background-color: white;
        max-width: 480px;
        margin: 0 auto;}
        .add-header { padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background-color: white; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .type-selector-header { display: flex; background: #f8f9fa; border-radius: 25px; padding: 3px; }
        .type-btn-header { padding: 8px 16px; border: none; background: transparent; border-radius: 22px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-light); }
        .type-btn-header.active { background: white; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .type-btn-header.expense.active { color: var(--expense-red); }
        .type-btn-header.income.active { color: var(--income-green); }
        .categories-section {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            min-height: 0;
            
            /* [FIX] Sesuaikan dengan tinggi kalkulator */
            padding-bottom: 50dvh;
            @supports not (padding-bottom: 50dvh) {
                padding-bottom: 50vh; /* Fallback */
            }
        }
        .category-group { margin-bottom: 20px; }
        .group-title { font-size: 12px; color: var(--text-light); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .category-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; }
        .category-item:hover { background: #f8f9fa; }
        .category-item.selected { background: var(--primary-blue); color: white; }
        .category-item.selected .category-icon { background: rgba(255,255,255,0.2) !important; color: white !important; }
        .category-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 20px; }
        .category-name { font-size: 11px; text-align: center; }
        .calculator-section { background: #f8f9fa; padding: 15px; border-top: 1px solid #e9ecef; flex-shrink: 0; display: grid; grid-template-rows: repeat(6, 1fr);}
        .amount-container { 
            display: flex; 
            gap: 8px;
            /* position: relative; */ /* <-- HAPUS BARIS INI */
        }
        .account-card { aspect-ratio: 1 / 1; height: 100%; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 102, 234, 0.3); }
        .account-card i { color: white; font-size: 24px; }
        .top-action-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; /* [FIX] Kembalikan ke 8px */
            grid-row: 1; /* [PENTING] Pastikan ini 1 */
        }
        
        .action-btn { background: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 24px; }
        .action-btn.personal { background: #f8f9fa; color: #6c757d; }
        .action-btn.today { background: #e3f2fd; color: #1976d2; }
        .action-btn.add { background: var(--income-green); color: white; }
        .action-btn.check { background: var(--income-green); color: white; }
        .action-btn.equals { background: var(--primary-blue); color: white; }
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; /* [FIX] Kembalikan ke 8px */
            grid-auto-rows: 1fr;
            grid-row: 2; /* [PENTING] Pastikan ini 2 */
        }
        .calc-btn { background: white; border: none; border-radius: 10px; font-size: 24px; font-weight: 600; cursor: pointer; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .calc-btn .fas { font-size: 24px; }
        .calc-btn.operator { background: #f1f3f5; color: #495057; }
        .calc-btn.delete { background: #ffe3e3; color: var(--expense-red); }
        .wallet-header { background: white; padding: 20px; font-size: 18px; font-weight: 600; text-align: center;}
        .total-balance-card .label { font-size: 14px; color: var(--text-light); margin-bottom: 5px; text-align: center; }
        .total-balance-card .amount { font-size: 32px; font-weight: 700; text-align: center; color: var(--primary-blue); }
        .account-list-card .card-title { font-weight: 600; margin-bottom: 15px; }
        .wallet-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--bg-gray); }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item .icon-wrapper { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .wallet-item .details { flex-grow: 1; font-weight: 500; }
        .wallet-item .balance { font-weight: 600; }
        /* [BARU] CSS untuk Grup Transaksi yang Bisa Di-collapse */
        .transaction-list .list-header {
            cursor: pointer;
            user-select: none; /* Mencegah teks terseleksi saat diklik */
        }
        .transaction-list .list-header .date-info i {
            transition: transform 0.2s ease-in-out;
        }
        .transaction-group.collapsed .list-header .date-info i {
            transform: rotate(-90deg); /* Putar ikon chevron saat ditutup */
        }
        .transaction-items-container {
            max-height: 1000px; /* Tinggi maks untuk animasi (bisa angka berapa saja) */
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out, transform 0.3s ease-out;
            opacity: 1;
            transform: translateY(0);
        }
        .transaction-group.collapsed .transaction-items-container {
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
        }
        /* [AKHIR BARU] */
        /* [BARU] CSS untuk Modal Pengganti Dompet */
        .wallet-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Sembunyi secara default */
            align-items: flex-end; /* Muncul dari bawah */
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .wallet-modal-overlay.visible {
            display: flex;
        }
        .wallet-modal-content {
            background: white;
            color: #333;
            width: 100%;
            max-width: 480px;
            padding: 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            animation: slideUp 0.3s ease-out;
            max-height: 50vh;
            overflow-y: auto;
        }
        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .wallet-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        .wallet-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
        }
        .wallet-list-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        .wallet-list-item:hover {
            background-color: #f4f5f9;
        }
        .wallet-list-item.active {
            background-color: var(--light-purple);
            color: var(--primary-blue);
            font-weight: 700;
        }
        /* Mode Gelap untuk Modal */
        .dark .wallet-modal-content {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-list-item:hover {
            background-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .wallet-list-item.active {
            background-color: var(--primary-blue);
            color: white;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* [AKHIR BARU] */
        /* [BARU] CSS untuk Masking Saldo (Mata) */
        #toggleMaskBtn {
            transition: background-color 0.2s, opacity 0.2s;
            border-radius: 50%; /* Bulatkan hover */
        }
        #toggleMaskBtn:hover {
            opacity: 0.7;
        }
        /* Status 'Aktif' saat masking menyala */
        .balance-masked #toggleMaskBtn {
            background-color: rgba(0,0,0,0.2); 
        }

        /* Logika untuk menukar ikon mata */
        .icon-eye-closed,
        .balance-masked .icon-eye-open {
            display: none;
        }
        .balance-masked .icon-eye-closed {
            display: inline-block;
        }

       /* Logika untuk menyembunyikan nominal */
        .balance-masked .data-maskable-amount {
            color: transparent !important; /* Sembunyikan teks asli, biarkan spasinya */
            position: relative; /* Konteks untuk pseudo-element */
            transition: all 0.1s;
            /* Ukuran font asli (dihapus dari sini, biarkan inherit) */
        }
        .balance-masked .data-maskable-amount::before {
            content: "Rp******"; /* Tampilkan teks masking */
            color: var(--text-dark); /* Tampilkan lagi teks masking */
            position: absolute;
            left: 0;
            right: 0;
            /* Biarkan text-align di-inherit dari parent (center di card, right di list) */
        }
        /* Jaga warna merah untuk nominal pengeluaran */
        .balance-masked .data-maskable-amount.expense::before {
            color: var(--expense-red);
        }
        .balance-masked .data-maskable-amount.income::before {
            color: var(--income-green);
        }
        
        /* Aturan untuk mode gelap */
        .dark .balance-masked .data-maskable-amount::before {
            color: #d1d5db;
        }
        .dark .balance-masked .data-maskable-amount.expense::before {
            color: var(--expense-red);
        }
        
        /* Aturan masking untuk daftar transaksi dinamis */
        .balance-masked .transaction-item .info .amount {
            color: transparent !important;
            position: relative;
        }
        .balance-masked .transaction-item .info .amount::before {
            content: "Rp******";
            position: absolute;
            right: 0; /* Hanya perlu 'right' untuk daftar */
        }
        /* Jaga warna hijau/merah di daftar transaksi */
        .balance-masked .transaction-item .info .amount[data-masked-color="income"]::before {
            color: var(--income-green);
        }
        .balance-masked .transaction-item .info .amount[data-masked-color="expense"]::before {
            color: var(--expense-red);
        }
        .dark .balance-masked .transaction-item .info .amount[data-masked-color="income"]::before {
            color: var(--income-green);
        }
        .dark .balance-masked .transaction-item .info .amount[data-masked-color="expense"]::before {
            color: var(--expense-red);
        }
        .balance-masked .transaction-list .list-header .summary .data-maskable-amount::before {
            left: auto; /* Hapus 'left: 0' */
            right: 0;   /* Terapkan 'right: 0' */
        }
        /* [BARU] CSS untuk Modal Detail Transaksi */
        .tx-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Sembunyi secara default */
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }
        .tx-modal-overlay.visible {
            display: flex;
        }
        .tx-modal-content {
            background: white;
            color: var(--text-dark);
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            animation: slideUp 0.3s ease-out;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .tx-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
        }
        .tx-modal-header button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-light);
            padding: 5px;
        }
        .tx-modal-header .tx-modal-actions {
            display: flex;
            gap: 20px;
        }
        .tx-modal-header .tx-modal-actions button {
            color: var(--primary-blue);
        }
        .tx-modal-header .tx-modal-actions #tx-modal-delete-btn {
            color: var(--expense-red);
        }
        .tx-modal-body {
            padding: 20px 25px 30px 25px;
        }
        .tx-modal-category {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }
        /* Gunakan style .category-icon yang sudah ada */
        .tx-modal-category #tx-modal-icon {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }
        .tx-modal-category #tx-modal-category-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .tx-modal-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .tx-modal-details .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-gray);
        }
        .tx-modal-details .detail-item span:first-child {
            color: var(--text-light);
        }
        .tx-modal-details .detail-item span:last-child {
            font-weight: 500;
        }
        .tx-modal-details .detail-item.notes {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            border-bottom: none;
        }
        
        /* Mode Gelap untuk Modal Detail */
        .dark .tx-modal-content {
            background-color: #374151;
            color: #d1d5db;
        }
        .dark .tx-modal-header {
            background-color: #1f2937;
        }
        .dark .tx-modal-category #tx-modal-category-name {
            color: white;
        }
        .dark .tx-modal-details .detail-item {
            border-bottom-color: #4b5563;
        }
        .dark .tx-modal-details .detail-item span:first-child {
            color: #9ca3af;
        }
        .dark .tx-modal-details .detail-item.notes span:first-child {
            color: #9ca3af;
        }
        .dark .tx-modal-details .detail-item.notes span:last-child {
            color: #d1d5db;
        }
        /* [AKHIR BARU] */
        /* [AKHIR CSS MODAL] */
        
        /* Tipe 1: Spinner Inline (untuk teks/angka) */
        .inline-spinner {
            display: none; /* Sembunyi by default */
            width: 1rem;   /* 16px */
            height: 1rem;  /* 16px */
            border: 2px solid var(--primary-blue);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }
        /* Penyesuaian untuk di dalam header */
        .header-title .inline-spinner {
            border-color: #fff;
            border-top-color: transparent;
        }
        .dark .header-title .inline-spinner {
             border-color: #fff;
             border-top-color: transparent;
        }

        .div-preloader-container {
            display: none; /* Sembunyi by default */
            /* [MODIFIKASI] Ubah ke position: absolute */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Penuhi seluruh card */
            min-height: 200px; 
            /* display: flex; <-- BARIS INI DIHAPUS */
            align-items: center;
            justify-content: center;
            z-index: 5; /* Pastikan di atas konten */
            background: var(--bg-gray); /* Samarkan dengan bg body */
            border-radius: 18px;
        }
        .dark .div-preloader-container {
            background: #111827; /* Samarkan dengan bg body gelap */
            border-radius: 18px;
        }
        
        .skeleton-theme-toggle {
            width: 43px;  /* [PERBAIKAN] Samakan dengan tinggi .view-toggle-group */
            height: 43px; /* [PERBAIKAN] Samakan dengan tinggi .view-toggle-group */
            background: rgba(255,255,255,0.1);
            border-radius: 50%; /* Sama dengan rounded-full */
            flex-shrink: 0; /* Mencegah elemen menyusut */
        }
        .skeleton-view-toggle {
            /* Ukuran dari skeleton Anda sebelumnya, ini sudah pas */
            width: 150px; 
            height: 43px; /* Sama dengan h-8 (tinggi 2.5rem/40px di .toggle-btn dikurangi padding) */
            background: rgba(255,255,255,0.1);
            border-radius: 20px; /* Sama dengan rounded-20px di .view-toggle-group */
            flex-shrink: 0;
        }
        .theme-toggle {
            width: 43px;
            height: 43px;
            flex-shrink: 0; /* Mencegah elemen menyusut */
        }

        /* 2. Atur logika show/hide BARU */
        
        /* Saat loading, sembunyikan konten asli */
        .right.loading .theme-toggle,
        .right.loading .view-toggle-group {
            display: none;
        }
        
        /* Saat TIDAK loading, sembunyikan skeleton */
        .right:not(.loading) .skeleton-theme-toggle,
        .right:not(.loading) .skeleton-view-toggle {
            display: none;
        }
        
        /* Hapus aturan .skeleton-placeholder yang lama (sudah tidak dipakai) */
        .right .skeleton-placeholder,
        .right.loading .skeleton-placeholder {
            display: none !important;
        }

        .div-spinner {
            display: inline-block;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border: 4px solid #e0e0e0; /* Warna dasar spinner */
            border-top-color: var(--primary-blue); /* Warna utama spinner */
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Penyesuaian Mode Gelap untuk Spinner Div */
        .dark .div-spinner {
            border-color: #4b5563; /* Warna dasar gelap */
            border-top-color: var(--primary-blue); /* Warna utama tetap sama */
        }
        
        /* [MODIFIKASI] Logika untuk menyembunyikan konten asli saat loading */
        
        /* Saat .loading, sembunyikan .real-content */
        .loading .real-content { display: none; }

        /* Tampilkan spinner yang sesuai */
        .loading .inline-spinner { display: inline-block; }
        .loading .div-preloader-container { display: flex; }
        /* [AKHIR BARU] */

        /* [BARU] CSS untuk Tombol Tanggal di Halaman Create */
        .action-btn.today {
            font-size: 13px; /* Ukuran font agar muat */
            font-weight: 600;
            padding: 0 5px; /* Padding horizontal */
            line-height: 1.2;
            text-align: center;
        }

        /* [BARU] CSS untuk Modal Kalender Tanggal */
        #date-modal-content {
            padding: 15px;
        }
        #date-modal-content .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-weight: 600;
            padding: 0 10px;
        }
        #date-modal-content .calendar-header i { cursor: pointer; }
        #date-modal-content .calendar-header .month-year { font-size: 18px; }
        #date-modal-content .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 15px;
            font-weight: 500;
        }
        #date-modal-content .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        #date-modal-content .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px; /* Beri jarak antar tanggal */
        }
        #date-modal-content .calendar-grid .day {
            font-size: 14px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 38px;
            width: 38px; /* Buat jadi kotak */
            cursor: pointer;
            border-radius: 50%; /* Bulatkan */
            margin: 0 auto;
        }
        #date-modal-content .calendar-grid .day:hover {
            background-color: #f0f0f0;
        }
        .dark #date-modal-content .calendar-grid .day:hover {
            background-color: #4b5563;
        }
        #date-modal-content .calendar-grid .day.weekend { color: var(--expense-red); }
        #date-modal-content .calendar-grid .day.selected {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 700;
        }
        #date-modal-content .calendar-grid .day.today .date-number {
             /* Tanda untuk hari ini */
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 2px;
        }
        .dark #date-modal-content .calendar-grid .day.today .date-number {
            border-bottom-color: white;
        }
        #date-modal-content .calendar-grid .day.selected.today .date-number {
            border-bottom: none; /* Hapus tanda jika dipilih */
        }
        /*... (style mode gelap) ...*/
        .dark .category-item:hover {
            background: #4b5563;
        }

        /* ... (style mode gelap) ... */
        .dark .category-item:hover {
            background: #4b5563;
        }

        /* [BARU] CSS UNTUK MODAL DIALOG KUSTOM */
        .dialog-modal-body {
            padding: 20px 25px 20px 25px;
        }
        .dialog-modal-body .dialog-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .dark .dialog-modal-body .dialog-title {
            color: white;
        }
        .dialog-modal-body .dialog-text {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            white-space: pre-wrap; /* Agar \n (baris baru) berfungsi */
        }
        .dark .dialog-modal-body .dialog-text {
            color: #d1d5db;
        }
        
        .dialog-modal-actions {
            display: flex;
            gap: 10px;
            padding: 0 25px 25px 25px;
            margin-top: 25px;
        }
        .dialog-modal-btn {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }
        .dialog-modal-btn.cancel {
            background-color: var(--bg-gray);
            color: var(--text-dark);
        }
        .dark .dialog-modal-btn.cancel {
            background-color: #4b5563;
            color: white;
        }
        .dialog-modal-btn.confirm {
            background-color: var(--primary-blue);
            color: white;
        }
        .dialog-modal-btn.confirm.destructive {
            background-color: var(--expense-red);
            color: white;
        }
        .form-card .submit-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* [BARU] Style untuk pilihan Icon di Modal */
        .icon-selection-container-modal {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .icon-input-modal {
            width: 60px !important;
            text-align: center;
            font-size: 24px !important;
            padding: 5px 10px !important;
            /* Style di bawah ini diambil dari .input-field di create-wallet.html */
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: var(--bg-gray);
        }
        .dark .icon-input-modal {
            background-color: #4b5563;
            border-color: #4b5563;
            color: white;
        }
        .emoji-presets-modal {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .emoji-btn-modal {
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-gray);
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .emoji-btn-modal {
            background-color: #4b5563;
            border-color: #374151;
        }
        .emoji-btn-modal:hover {
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .form-card .submit-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .icon-selection-container-modal {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .icon-input-modal {
            width: 60px !important;
            text-align: center;
            font-size: 24px !important;
            padding: 5px 10px !important;
            /* Style di bawah ini diambil dari .input-field di create-wallet.html */
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: var(--bg-gray);
        }
        .dark .icon-input-modal {
            background-color: #4b5563;
            border-color: #4b5563;
            color: white;
        }
        .emoji-presets-modal {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .emoji-btn-modal {
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-gray);
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .emoji-btn-modal {
            background-color: #4b5563;
            border-color: #374151;
        }
        .emoji-btn-modal:hover {
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .loading-spinner { display: none; }
        .loading-spinner.active {
            display: inline-block;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            animation: spin 1s ease-in-out infinite;
        }
        .modal-overlay{
            display: none;
        }
        /* GANTI CSS UNTUK .type-selector-header dan .type-btn-header */
.type-selector-header {
    display: flex;
    background: transparent; /* Hapus background abu-abu */
    border-radius: 0;
    padding: 0;
    gap: 10px; /* Beri jarak antar pills */
}
.type-btn-header {
    padding: 8px 16px;
    border: 1px solid #ddd; /* Border abu-abu */
    background: transparent;
    border-radius: 22px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--text-light);
    transition: all 0.2s ease;
}
.type-btn-header.active {
    background: white; /* Ini akan di-override */
    color: white;
    box-shadow: none; /* Hapus shadow */
    border-color: transparent; /* Hapus border */
}
.type-btn-header.expense.active {
    background-color: var(--expense-red);
    color: white;
    border-color: var(--expense-red);
}
.type-btn-header.income.active {
    background-color: var(--income-green);
    color: white;
    border-color: var(--income-green);
}
.dark .type-btn-header {
    border-color: #4b5563; /* dark:border-gray-600 */
    color: #9ca3af; /* dark:text-gray-400 */
}
.dark .type-btn-header.expense.active,
.dark .type-btn-header.income.active {
    color: white; /* Warna sudah diatur di atas */
}
/* GANTI CSS UNTUK .type-selector-header dan .type-btn-header */
.type-selector-header {
    display: flex;
    background: transparent; /* Hapus background abu-abu */
    border-radius: 0;
    padding: 0;
    gap: 10px; /* Beri jarak antar pills */
}
.type-btn-header {
    padding: 8px 16px;
    border: 1px solid #ddd; /* Border abu-abu */
    background: transparent;
    border-radius: 22px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--text-light);
    transition: all 0.2s ease;
}
.type-btn-header.active {
    background: white; /* Ini akan di-override */
    color: white;
    box-shadow: none; /* Hapus shadow */
    border-color: transparent; /* Hapus border */
}
.type-btn-header.expense.active {
    background-color: var(--expense-red);
    color: white;
    border-color: var(--expense-red);
}
.type-btn-header.income.active {
    background-color: var(--income-green);
    color: white;
    border-color: var(--income-green);
}
.dark .type-btn-header {
    border-color: #4b5563; /* dark:border-gray-600 */
    color: #9ca3af; /* dark:text-gray-400 */
}
.dark .type-btn-header.expense.active,
.dark .type-btn-header.income.active {
    color: white; /* Warna sudah diatur di atas */
}
/* GANTI CSS UNTUK .action-btn */
.action-btn {
    background: #f0f0f0; /* Latar abu-abu muda */
    color: #555; /* Teks gelap */
    font-size: 20px; /* Kecilkan ikon sedikit */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.dark .action-btn {
    background: #374151; /* dark:bg-gray-700 */
    color: #d1d5db; /* dark:text-gray-300 */
    box-shadow: none;
}

/* [BARU] Tombol akun (menggantikan .personal) */
.action-btn.account {
    background: #f0f0f0;
    color: var(--primary-blue);
    font-size: 24px; /* Ikon akun sedikit lebih besar */
}
.dark .action-btn.account {
    background: #374151;
}

/* HAPUS .action-btn.personal (sudah diganti .account) */
/* .action-btn.personal { ... } */

/* MODIFIKASI Tombol Aksi lain */
.action-btn.today {
    background: #E6E6FA; /* var(--light-purple) */
    color: var(--primary-blue);
    font-size: 13px;
    font-weight: 600;
}
.dark .action-btn.today {
    background: #4b5563; /* dark:border-gray-600 */
    color: white;
}
.action-btn.add {
    background: #51CF66; /* var(--income-green) */
    color: white;
}
.action-btn.check {
    background: #51CF66; /* var(--income-green) */
    color: white;
}
.action-btn.equals {
    background: var(--primary-blue);
    color: white;
}
/* GANTI CSS UNTUK .calculator-section dan .calc-btn */
.calculator-section {
    background: #FFFFFF; /* Latar putih */
    padding: 15px;
    border-top: 1px solid #e0e0e0; /* Garis tipis */
    flex-shrink: 0;
    display: grid;
    grid-template-rows: repeat(6, 1fr);
}
.dark .calculator-section {
    background: #1f2937; /* Latar gelap */
    border-top-color: #4b5563;
}

.calc-btn {
    background: white; /* Tombol angka putih */
    color: var(--text-dark);
    font-size: 28px; /* Perbesar angka */
    box-shadow: none; /* Hapus shadow */
    border: 1px solid #f0f0f0; /* Border tipis */
}
.dark .calc-btn {
    background: #374151; /* dark:bg-gray-700 */
    color: #d1d5db;
    border-color: #4b5563;
}

.calc-btn.operator {
    background: #f8f9fa; /* Latar abu-abu */
    color: var(--primary-blue); /* Warna biru */
    font-size: 24px;
    border-color: #f0f0f0;
}
.dark .calc-btn.operator {
    background: #4b5563;
    color: #E6E6FA; /* light purple */
    border-color: #4b5563;
}

.calc-btn.delete {
    background: #ffe3e3; /* Merah muda */
    color: var(--expense-red);
    border-color: #f0f0f0;
}
.dark .calc-btn.delete {
    background: #5c2c2c; /* Merah gelap */
    color: var(--expense-red);
    border-color: #4b5563;
}

.note-input-wrapper {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 10px;
    padding: 10px 10px;
    gap: 10px;
    border: 1px solid #f0f0f0;
    
    width: 100%; /* [DIUBAH] Menjadi lebar penuh */

    min-width: 0;       
    overflow: hidden;   /* [DIUBAH] Sembunyikan overflow, tidak perlu scroll */
    cursor: pointer;
    transition: background-color 0.2s;
}
.note-input-wrapper i {
    color: var(--text-light);
    font-size: 14px;
}
.note-input-wrapper input {
    border: none;
    outline: none;
    background: transparent;
    font-size: 15px;
    width: 100%;
    color: var(--text-dark);
}
.note-input-wrapper input::placeholder {
    color: var(--text-light);
}
.dark .note-input-wrapper {
    background: #374151; /* dark:bg-gray-700 */
    box-shadow: none;
}
.dark .note-input-wrapper input {
    color: white;
}
.dark .note-input-wrapper input::placeholder {
    color: #9ca3af; /* dark:text-gray-400 */
}

/* MODIFIKASI .amount-display */
        .amount-display {
            font-size: 28px; /* Ukuran font maks, JS akan mengatur sisanya */

            width: 100%; /* [DIUBAH] Menjadi lebar penuh */
            
            min-width: 0;     
            overflow: hidden; /* [DIUBAH] Sembunyikan overflow */
            white-space: nowrap; 
            /* text-overflow: ellipsis; */ /* Hapus ini agar angka tidak terpotong "..." */

            /* Properti styling (dikembalikan dari aturan lama) */
            background: white; 
            padding: 0 10px; 
            border-radius: 10px; 
            text-align: right; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            border: 1px solid #f0f0f0; 
        }
/* ====================================================== */
/* [PERBAIKAN FINAL] CSS UNTUK NOTES-VIEW (PENGGANTI MODAL) */
/* ====================================================== */
.calculator-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    
    max-width: 480px; 
    margin: 0 auto;
    height: 410px;
    
    padding: 15px; /* [FIX] Kembalikan padding 15px */
    
    background:#FFFFFF;
    border-top: 1px solid #e0e0e0;
    display: grid;
    /*gap: 8px; /* [FIX] Kembalikan gap 8px */
    overflow: hidden;
    box-sizing: border-box;
    
    grid-template-rows: auto 1fr; 
    
    /* [KUNCI] Tambahkan padding-bottom untuk Home Bar iPhone */
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
}

/* [HAPUS] Hapus #calc-content-wrapper */
/* View Kalkulator (Default) */
#calculator-view {
    display: grid; 
    /* [PERBAIKAN] 1 baris untuk amount/catatan, 1 baris untuk sisa grid tombol */
    grid-template-rows: auto 1fr; 
    gap: 8px; 
    height: 100%;
    box-sizing: border-box; 
    grid-row: 2;
    overflow: hidden;
}

#calculator-view .amount-container {
    grid-row: 1; /* Baris 1: Amount/Catatan */
    display: flex;
    flex-direction: column; /* [DIUBAH] Menjadi tumpukan vertikal */
    gap: 8px;
    /* Tinggi akan otomatis (auto) */
}

/* [PERBAIKAN] HAPUS aturan untuk .top-action-bar dan .calc-grid di dalam #calculator-view */
/*
#calculator-view .top-action-bar { ... Dihapus ... }
#calculator-view .calc-grid { ... Dihapus ... }
*/

/* [PERBAIKAN] CSS BARU untuk grid 5x4 yang digabung */
.unified-calc-grid {
    grid-row: 2; /* Baris 2: Semua tombol */
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 kolom */
    grid-template-rows: repeat(5, 1fr);    /* 5 baris */
    gap: 8px;
    height: 100%; /* Memenuhi sisa ruang */
}

/* View Catatan (Default Tersembunyi) */
#notes-view {
    display: none; 
    flex-direction: column;
    height: 100%;
    width: 100%;
    background: white;
    /* [BARU] Pastikan ini menutupi SEMUA baris di .calculator-section */
    grid-row: 1 / span 2; 
}
.dark #notes-view {
    background: #1f2937;
}

/* Logika Tampilan Saat Catatan Aktif */
.calculator-section.notes-active {
    padding: 0; /* [BARU] Hapus padding saat notes-view aktif */
}
.calculator-section.notes-active #calculator-view {
    display: none; 
}
.calculator-section.notes-active #notes-view {
    display: flex; /* Tampilkan view catatan */
}

/* Styling di dalam Notes View */
.notes-view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px; /* Padding untuk header catatan */
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
    background-color: white;
}
.dark .notes-view-header {
    background-color: #1f2937;
    border-bottom-color: #4b5563;
}
.notes-view-header h3 {
    font-weight: 600;
    font-size: 16px;
    text-align: center;
    flex-grow: 1;
}
.notes-view-header .notes-view-save {
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    color: var(--primary-blue);
    flex-basis: 50px;
    text-align: right;
}

.notes-view-body {
    display: flex;
    flex-direction: column;
    padding: 15px;
    overflow: hidden;
    flex-grow: 1;
}
.notes-view-body textarea {
    min-height: 80px; /* Textarea pendek */
    flex-shrink: 0;
    border: none;
    outline: none;
    width: 100%;
    font-size: 16px;
    line-height: 1.6;
    padding: 10px;
    background-color: var(--bg-gray);
    border-radius: 10px;
    resize: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.dark .notes-view-body textarea {
    background-color: #374151;
    color: white;
}

.suggestion-pills-container {
    flex-grow: 1; /* Ambil sisa ruang */
    overflow-y: auto; /* Area sugesti bisa scroll */
    padding-top: 15px;
}
.suggestion-pills-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 10px;
    text-transform: uppercase;
}
.suggestion-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.suggestion-pills button {
    background: var(--light-purple);
    color: var(--primary-blue);
    border: none;
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}
.dark .suggestion-pills button {
    background-color: #4b5563;
    color: #E6E6FA;
}

/* CSS untuk Tampilan Catatan di Kalkulator (Tidak Berubah) */
.note-input-wrapper {
    cursor: pointer;
    transition: background-color 0.2s;
}
.note-input-wrapper:hover {
    background-color: #f0f0f0;
}
.notes-preview-text {
            font-size: 15px;
            color: var(--text-dark);
            white-space: nowrap; /* Teks tidak boleh turun baris */
            padding-right: 10px; 
            
            /* [PERBAIKAN BARU UNTUK ELLIPSIS] */
            display: block;           /* [DIUBAH] Aktifkan baris ini */
            overflow: hidden;         /* [DIUBAH] Aktifkan baris ini */
            text-overflow: ellipsis;  /* [DIUBAH] Aktifkan baris ini */
        }
.notes-preview-text:empty::before {
    content: attr(data-placeholder);
    color: var(--text-light);
}
.dark .note-input-wrapper:hover {
    background-color: #374151;
}
.dark .notes-preview-text {
    color: white;
}
.dark .notes-preview-text:empty::before {
    color: #9ca3af;
}

/* [MODIFIKASI] Hapus 'grid-row' dari .calc-grid */
.calc-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px; 
    grid-auto-rows: 1fr;
}
        @media (min-width: 480px) {
            body { background-color: #e9ecef; }
            .app-container { max-width: 480px; margin: 0 auto; height: 100vh; }
            .add-view { max-width: 480px; }
            .calculator-section { padding: 5px; }
            .amount-display { font-size: 36px; }
            .calc-btn, .action-btn { font-size: 28px; min-height: 50px; border-radius: 12px; }
            .calc-btn .fas { font-size: 28px; }
            .dark body { background-color: #111827; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        {{PAGE_CONTENT}}
    </div>

    <div id="wallet-modal-overlay" class="wallet-modal-overlay" onclick="closeWalletSwitcher()">
        <div class="wallet-modal-content" onclick="event.stopPropagation()">
            <div class="wallet-modal-header">
                <h3>Pilih Dompet</h3>
                <button class="wallet-modal-close" onclick="closeWalletSwitcher()">&times;</button>
            </div>
            <div id="wallet-list-container">
                </div>
        </div>
    </div>
    <div id="tx-modal-overlay" class="tx-modal-overlay" onclick="closeTransactionModal()">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div class="tx-modal-header">
                <button class="tx-modal-close" onclick="closeTransactionModal()"><i class="fas fa-times"></i></button>
                <div class="tx-modal-actions">
                    <button id="tx-modal-delete-btn"><i class="fas fa-trash"></i></button>
                    <button id="tx-modal-edit-btn"><i class="fas fa-edit"></i></button>
                </div>
            </div>
            <div class="tx-modal-body">
                <div class="tx-modal-category">
                    <span id="tx-modal-icon" class="category-icon" style="background: var(--light-purple);"></span>
                    <span id="tx-modal-category-name">Nama Kategori</span>
                </div>
                <div class="tx-modal-amount" id="tx-modal-amount">-Rp8.000</div>
                <div class="tx-modal-details">
                    <div class="detail-item">
                        <span>Tanggal:</span>
                        <span id="tx-modal-date">5/11/2025 15.40.19</span>
                    </div>
                    <div class="detail-item">
                        <span>Akun:</span>
                        <span id="tx-modal-account">akun bawaan</span>
                    </div>
                    <div class="detail-item">
                        <span>Buku:</span>
                        <span id="tx-modal-wallet">Manda</span>
                    </div>
                    <div class="detail-item notes">
                        <span>Catatan:</span>
                        <span id="tx-modal-notes">Belanja</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="date-modal-overlay" class="tx-modal-overlay" onclick="closeDateModal()">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div id="date-modal-content"></div>
        </div>
    </div>

<div id="invite-modal-overlay" class="tx-modal-overlay" onclick="closeInviteModal()">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div class="tx-modal-header">
                <h3 id="invite-modal-title" style="font-weight: 600;">Undang Anggota</h3>
                <button class="tx-modal-close" onclick="closeInviteModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="tx-modal-body" style="padding-top: 15px;">
                <p class="text-sm text-slate-500 dark:text-slate-400" style="margin-bottom: 15px; font-size: 14px;">
                    Ke buku: <strong id="invite-modal-wallet-name">Nama Buku</strong>
                </p>
                
                <form id="modal-invite-form">
                    <input type="hidden" id="invite-modal-wallet-id">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="invite-modal-email" class="mb-2 text-sm font-bold text-slate-600 dark:text-slate-200" style="display: block; font-size: 13px; font-weight: 500; color: var(--text-light); margin-bottom: 8px;">Email Anggota</label>
                        <input type="email" id="invite-modal-email" class="input-field" placeholder="" required 
                               style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: var(--bg-gray); font-size: 14px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="invite-modal-role" class="mb-2 text-sm font-bold text-slate-600 dark:text-slate-200" style="display: block; font-size: 13px; font-weight: 500; color: var(--text-light); margin-bottom: 8px;">Peran</label>
                        <select id="invite-modal-role" class="select-field" 
                                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: var(--bg-gray); font-size: 14px; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22currentColor%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%20%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em;">
                            <option value="ADMIN">Admin (Bisa tambah/edit/hapus)</option>
                            <option value="VIEWER">Viewer (Hanya bisa melihat)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="invite-modal-label" class="mb-2 text-sm font-bold text-slate-600 dark:text-slate-200" style="display: block; font-size: 13px; font-weight: 500; color: var(--text-light); margin-bottom: 8px;">Label (Opsional)</label>
                        <input type="text" id="invite-modal-label" class="input-field" placeholder="cth: Istri, Suami, Anak, Bendahara, Dll" 
                               style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: var(--bg-gray); font-size: 14px;">
                    </div>
                    
                    <button type="submit" class="submit-btn" 
                            style="width: 100%; background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        <span class="loading-spinner" style="border-top-color: #fff; border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent; width: 1.2rem; height: 1.2rem; margin-right: 8px;"></span>
                        <span>Kirim Undangan</span>
                    </button>
                    
                    <div id="modal-invite-message" style="font-size: 13px; margin-top: 10px; text-align: center;"></div>
                </form>
            </div>
        </div>
    </div>
<div id="dialog-modal-overlay" class="tx-modal-overlay" onclick="closeDialog(false)">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div class="dialog-modal-body">
                <h3 id="dialog-modal-title">Judul Dialog</h3>
                <p id="dialog-modal-text">Ini adalah teks untuk dialog...</p>
            </div>
            <div class="dialog-modal-actions">
                <button id="dialog-modal-cancel-btn" class="dialog-modal-btn cancel">Batal</button>
                <button id="dialog-modal-confirm-btn" class="dialog-modal-btn confirm">OK</button>
            </div>
        </div>
    </div>
</div>
    </div>

<div id="edit-book-modal-overlay" class="tx-modal-overlay" onclick="closeEditBookModal()">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div class="tx-modal-header">
                <h3 id="edit-book-modal-title" style="font-weight: 600;">Edit Buku</h3>
                <button class="tx-modal-close" onclick="closeEditBookModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="tx-modal-body" style="padding-top: 15px;">
                
                <form id="modal-edit-book-form">
                    <input type="hidden" id="edit-book-id">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="edit-book-icon" style="display: block; font-size: 13px; font-weight: 500; color: var(--text-light); margin-bottom: 8px;">Ikon</label>
                        <div class="icon-selection-container-modal">
                            <input class="icon-input-modal" id="edit-book-icon" value="" maxlength="2" required />
                            <div class="emoji-presets-modal">
                                <button type="button" class="emoji-btn-modal" onclick="selectEditIcon('')"></button>
                                <button type="button" class="emoji-btn-modal" onclick="selectEditIcon('')"></button>
                                <button type="button" class="emoji-btn-modal" onclick="selectEditIcon('')"></button>
                                <button type="button" class="emoji-btn-modal" onclick="selectEditIcon('')"></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="edit-book-name" style="display: block; font-size: 13px; font-weight: 500; color: var(--text-light); margin-bottom: 8px;">Nama Buku</label>
                        <input type="text" id="edit-book-name" class="input-field" required 
                               style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: var(--bg-gray); font-size: 14px;">
                    </div>
                    
                    <button type="submit" class="submit-btn" id="edit-book-submit-btn" 
                        style="width: 100%; background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                       <span id="edit-book-btn-text">Simpan Perubahan</span>
                    </button>
                    
                    <div id="edit-book-spinner" style="display: none; text-align: center; padding-top: 12px;">
                        <span class="loading-spinner active" style="border-top-color: var(--primary-blue); border-left-color: var(--primary-blue); border-right-color: transparent; border-bottom-color: transparent; width: 1.5rem; height: 1.5rem;"></span>
                    </div>
                    
                    <div id="modal-edit-book-message" style="font-size: 13px; margin-top: 10px; text-align: center;"></div>
                </form>
            </div>
        </div>
    </div>
<div id="delete-book-modal-overlay" class="modal-overlay">
    <div class="modal-content-small">
        <h3 class="modal-title">Hapus Buku Ini?</h3>
        <p class="modal-text">
            PERINGATAN: Anda akan menghapus buku ini.
            <br>
            <br>
            <strong>SEMUA</strong> data transaksi, akun, dan anggota di dalamnya akan hilang <strong>selamanya</strong>.
            <br>
            <br>
            Apakah Anda yakin?
        </p>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeDeleteBookModal()">Batal</button>
            <button class="btn btn-danger" id="confirm-delete-book-btn">Hapus Buku</button>
        </div>
    </div>
</div>

<script>
const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = '/login';
        }
        // === [BARU] BAGIAN 0: LOGIKA MODE GELAP/TERANG ===
        const settingsKey = 'casflo'; 
        const htmlEl = document.documentElement;

        // === [BARU] BAGIAN 0.5: API HELPER ===
        /**
         * Fungsi helper untuk memanggil API Anda dengan otentikasi.
         * @param {string} endpoint - Path API (cth: '/wallets')
         * @param {object} options - Opsi 'fetch' (method, body, dll.)
         * @returns {Promise<any>} - Properti 'data' dari respons JSON
         */
        async function fetchApi(endpoint, options = {}) {
            const token = localStorage.getItem('sessionToken');
            if (!token) {
                console.log("Token tidak ditemukan, mengarahkan ke login.");
                navigate('/login');
                throw new Error('Sesi tidak valid');
            }

            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // [PENTING] Sesuai middleware 'protect'
            };

            const config = {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            };

            // Ganti 'https://api.casflo.id' dengan URL API Anda jika berbeda
            const response = await fetch(`https://api.casflo.id/api/v1${endpoint}`, config);

            if (response.status === 401) { // Token expired atau invalid
                localStorage.removeItem('sessionToken');
                console.log("Sesi 401, token dihapus.");
                navigate('/login');
                throw new Error('Sesi kedaluwarsa');
            }

            if (!response.ok) {
                const errorResult = await response.json();
                console.error("API Error:", errorResult);
                throw new Error(errorResult.error?.message || 'Gagal mengambil data dari API');
            }
            
            // API Anda selalu mengembalikan { success: true, data: ... }
            const result = await response.json(); 
            return result.data; 
        }
        /**
         * [BARU] Helper global untuk format mata uang & set font size
         * @param {HTMLElement} wrapper - Elemen pembungkus (.loading atau parent)
         * @param {HTMLElement} element - Elemen teks (.real-content)
         * @param {number} value - Angka yang akan diformat
         * @param {'total'|'income'|'expense'} type - Tipe data
         */
        function formatAndSetDisplay(wrapper, element, value, type) {
            if (!element || !wrapper) return;

            let sign = '';
            // Tanda minus hanya untuk pengeluaran atau total negatif
            if (type === 'expense' || (type === 'total' && value < 0)) {
                // [PERBAIKAN] Hapus baris 'sign = "-";'
            }
            
            // [PERBAIKAN] Hapus '${sign}' dari string di bawah
            const amountString = `Rp${Math.abs(value).toLocaleString('id-ID')}`;

            // Atur font size dinamis
            if (amountString.length > 13) { // > 1 Miliar (misal: -Rp100.000.000)
                element.style.fontSize = "13px";
            } else if (amountString.length > 10) { // > 10 Juta (misal: -Rp10.000.000)
                element.style.fontSize = "14px";
            } else {
                element.style.fontSize = "16px"; // default
            }

            // Atur warna
            wrapper.classList.remove('expense', 'income'); // Reset warna
            if (type === 'total') {
                if (value < 0) wrapper.classList.add('expense'); // Merah jika total minus
            } else if (type === 'income') {
                wrapper.classList.add('income');
            } else if (type === 'expense') {
                wrapper.classList.add('expense');
            }
            
            element.textContent = amountString;
            wrapper.classList.remove('loading');
        }

        // --- [AKHIR BAGIAN 0.5] ---

        /**
         * [BARU] Fungsi helper untuk menyesuaikan font size nominal secara dinamis
         */
     /**
         * [BARU] Fungsi helper untuk menyesuaikan font size nominal secara dinamis
         */
        function adjustAmountFontSize() {
            const amountDisplay = document.getElementById('amountDisplay');
            if (!amountDisplay) return;

            const maxFontSize = 32; // Ukuran font maksimum (dalam px)
            const minFontSize = 18; // Ukuran font minimum (dalam px)
            let currentFontSize = maxFontSize;

            // 1. Reset font size ke maksimum dulu
            amountDisplay.style.fontSize = maxFontSize + 'px';

            // 2. Cek apakah teksnya meluap (scrollWidth > clientWidth)
            // Kita beri sedikit padding (misal 10px) agar tidak terlalu mepet
            while (amountDisplay.scrollWidth > (amountDisplay.clientWidth - 10) && currentFontSize > minFontSize) {
                // Jika meluap, kecilkan font size
                currentFontSize--;
                amountDisplay.style.fontSize = currentFontSize + 'px';
            }
        }
        /**
         * [BARU] Helper global untuk format mata uang & set font size
         * @param {HTMLElement} wrapper - Elemen pembungkus (.loading atau parent)
         * @param {HTMLElement} element - Elemen teks (.real-content)
         * @param {number} value - Angka yang akan diformat
         * @param {'total'|'income'|'expense'} type - Tipe data
         */
       function formatAndSetDisplay(wrapper, element, value, type) {
            if (!element || !wrapper) return;

            // [PERBAIKAN] Logika 'sign' dihapus
            
            // [PERBAIKAN] Tanda ${sign} dihapus dari sini
            const amountString = `Rp${Math.abs(value).toLocaleString('id-ID')}`;
            
            // [PERBAIKAN] Ukuran font diperkecil agar muat ratusan juta
            if (amountString.length > 13) { // > 100 Juta (cth: Rp100.000.000)
                element.style.fontSize = "12px";
            } else if (amountString.length > 10) { // > 1 Juta (cth: Rp1.000.000)
                element.style.fontSize = "13px";
            } else {
                element.style.fontSize = "14px"; // Ukuran default baru
            }

            // Atur warna
            wrapper.classList.remove('expense', 'income'); // Reset warna
            if (type === 'total') {
                if (value < 0) wrapper.classList.add('expense'); // Merah jika total minus
            } else if (type === 'income') {
                wrapper.classList.add('income');
            } else if (type === 'expense') {
                wrapper.classList.add('expense');
            }
            
            element.textContent = amountString;
            wrapper.classList.remove('loading');
        }
        // --- [AKHIR BAGIAN 0.5] ---
// --- [AKHIR BAGIAN 0.5] ---

        // [BARU] Fungsi-fungsi untuk Modal Pengganti Dompet
        const walletModal = document.getElementById('wallet-modal-overlay');
        const walletListContainer = document.getElementById('wallet-list-container');
        
        async function openWalletSwitcher() {
            if (!walletModal || !walletListContainer) return;

            try {
                const currentWalletId = localStorage.getItem('currentWalletId');
                // 1. Ambil daftar dompet terbaru dari API
                const wallets = await fetchApi('/wallets');
                
                // 2. Bersihkan daftar sebelumnya
                walletListContainer.innerHTML = ''; 

                // 3. Isi daftar dengan dompet yang ada
                wallets.forEach(wallet => {
                    const item = document.createElement('div');
                    item.className = 'wallet-list-item';
                    
                    const icon = wallet.icon || ''; // Ambil icon, beri default ''
                    item.innerHTML = `<span style="font-size: 20px; width: 30px; text-align: center; margin-right: 15px;">${icon}</span> <span>${wallet.name}</span>`;

                    // Tandai dompet yang sedang aktif
                    if (wallet.id === currentWalletId) {
                        item.classList.add('active');
                    }
                    // Tambahkan aksi klik
                    item.onclick = () => selectWallet(wallet.id, wallet.name, icon); 
                    walletListContainer.appendChild(item);
                });
                
                // 4. Tampilkan modal
                walletModal.classList.add('visible');

            } catch (error) {
                console.error("Gagal membuka pengganti dompet:", error);
                showDialog({ title: 'Error', text: 'Gagal memuat daftar dompet.' });
            }
        }

        function closeWalletSwitcher() {
            if (walletModal) {
                walletModal.classList.remove('visible');
            }
        }
        /**
         * [FUNGSI BARU] Me-render tombol-tombol dompet di header
         */
        async function renderWalletActions() {
            const container = document.getElementById('wallet-actions-container');
            if (!container) return;

            try {
                const currentWalletId = localStorage.getItem('currentWalletId');
                const wallets = await fetchApi('/wallets');

                container.innerHTML = ''; // Bersihkan kontainer

                // Urutkan dompet: yang aktif jadi pertama
                wallets.sort((a, b) => {
                    if (a.id === currentWalletId) return -1;
                    if (b.id === currentWalletId) return 1;
                    return 0;
                });

                // 1. Render setiap dompet sebagai tombol
                wallets.forEach(wallet => {
                    const walletBox = document.createElement('div');
                    walletBox.className = 'action-box';
                    if (wallet.id === currentWalletId) {
                        walletBox.classList.add('active');
                    }
                    
                    const icon = wallet.icon || '';
                    const name = wallet.name;

                    walletBox.innerHTML = `
                        <div class="icon">${icon}</div>
                        <span class="text">${name}</span>
                    `;
                    
                    walletBox.onclick = () => selectWallet(wallet.id, wallet.name, icon);
                    container.appendChild(walletBox);
                });

                // 2. Render tombol "Baru"
                const newWalletBtn = document.createElement('div');
                newWalletBtn.className = 'action-box icon-only';
                newWalletBtn.id = 'createNewWalletBtn'; // ID lama tetap ada
                newWalletBtn.style.cursor = 'pointer';
                newWalletBtn.innerHTML = `<div class="icon"><i class="fas fa-plus"></i></div>`;
                newWalletBtn.onclick = () => navigate('/create-wallet');
                container.appendChild(newWalletBtn);

            } catch (error) {
                console.error("Gagal me-render wallet actions:", error);
                container.innerHTML = '<div class="action-box"><span class="text" style="display:block; color: white;">Gagal memuat dompet</span></div>';
            }
        }

        async function loadOverviewData(startDate, endDate) { // <-- [PERBAIKAN] Tambah parameter
            const walletId = localStorage.getItem('currentWalletId');
            if (!walletId) return;

            // Ambil elemen wrapper dan teks
            const totalWrapper = document.getElementById('totalAmountWrapper');
            const incomeWrapper = document.getElementById('incomeAmountWrapper');
            const expenseWrapper = document.getElementById('expenseAmountWrapper');
            
            // Variabel yang benar
            const caltotalEl = document.getElementById('totalAmount');
            const calincomeEl = document.getElementById('incomeAmount');
            const calexpenseEl = document.getElementById('expenseAmount');

            // [PERBAIKAN] Tambahkan 'loading' class secara manual
            totalWrapper?.classList.add('loading');
            incomeWrapper?.classList.add('loading');
            expenseWrapper?.classList.add('loading');

            try {
                // [PERBAIKAN] Kirim tanggal ke API
                const summary = await fetchApi(`/wallets/${walletId}/summary?startDate=${startDate}&endDate=${endDate}`);
                
                const monthlyTotal = (summary.monthly_income || 0) - (summary.monthly_expense || 0);

                // [PERBAIKAN] Panggil helper global dengan variabel yang benar
                formatAndSetDisplay(totalWrapper, caltotalEl, monthlyTotal, 'total');
                formatAndSetDisplay(incomeWrapper, calincomeEl, summary.monthly_income, 'income');
                formatAndSetDisplay(expenseWrapper, calexpenseEl, summary.monthly_expense, 'expense');

            } catch (error) {
                console.error("Gagal memuat summary:", error);
                // [PERBAIKAN] Handle error dengan variabel yang benar
                if(caltotalEl) caltotalEl.textContent = "Error";
                if(calincomeEl) calincomeEl.textContent = "Error";
                if(calexpenseEl) calexpenseEl.textContent = "Error";
                if (totalWrapper) totalWrapper.classList.remove('loading');
                if (incomeWrapper) incomeWrapper.classList.remove('loading');
                if (expenseWrapper) expenseWrapper.classList.remove('loading');
            }
        }
       
        function selectWallet(walletId, walletName, walletIcon) {
            // 0. Jika dompet yang diklik sudah aktif, tidak perlu lakukan apa-apa
            if (localStorage.getItem('currentWalletId') === walletId) {
                closeWalletSwitcher(); // Cukup tutup modal (jika terbuka)
                return;
            }

            // 1. Simpan pilihan baru ke localStorage
            localStorage.setItem('currentWalletId', walletId);
            localStorage.setItem('currentWalletName', walletName);
            localStorage.setItem('currentWalletIcon', walletIcon || '');
            
            // 2. Tutup modal (jika terbuka)
            closeWalletSwitcher();
            
            // 3. [PERBAIKAN KUNCI] Update UI tanpa me-muat ulang halaman

            // 3a. Render ulang tombol header
            // Ini akan otomatis mengurutkan ulang (geser ke kiri) dan mengubah warna
            renderWalletActions(); 

            // 3b. Update nama di dropdown atas (yang di samping ikon pencarian)
            const walletNameEl = document.getElementById('currentWalletNameDisplay');
            if (walletNameEl) walletNameEl.textContent = walletName;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const startDate = new Date(year, month, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
            loadOverviewData(startDate, endDate);

            // 3d. Muat ulang daftar transaksi (spinner akan muncul dan hilang lagi)
            updateMainView();
        }
        // ... (setelah fungsi selectWallet)

        // [BARU] Helper untuk Collapsible Groups
        const COLLAPSED_KEY = 'casflo_collapsed_groups';
        function getCollapsedGroups() {
            try {
                const collapsed = localStorage.getItem(COLLAPSED_KEY);
                return collapsed ? JSON.parse(collapsed) : [];
            } catch (e) {
                return []; // Jika JSON rusak, reset
            }
        }
        function saveCollapsedGroups(groups) {
            localStorage.setItem(COLLAPSED_KEY, JSON.stringify(groups));
        }
        
        /**
         * Dipanggil saat header tanggal diklik
         * @param {string} dateKey - Kunci unik untuk grup tanggal (misal: "Tue Nov 05 2025")
         * @param {HTMLElement} headerElement - Elemen .list-header yang diklik
         */
        function toggleGroupCollapse(dateKey, headerElement) {
            const group = headerElement.closest('.transaction-group');
            if (!group) return;

            const isCollapsed = group.classList.toggle('collapsed');
            let collapsedGroups = getCollapsedGroups();
            
            if (isCollapsed) {
                // Baru saja DITUTUP, tambahkan ke daftar
                if (!collapsedGroups.includes(dateKey)) {
                    collapsedGroups.push(dateKey);
                }
            } else {
                // Baru saja DIBUKA, hapus dari daftar
                collapsedGroups = collapsedGroups.filter(key => key !== dateKey);
            }
            saveCollapsedGroups(collapsedGroups);
        }
        // [AKHIR FUNGSI COLLAPSE]


        const txModal = document.getElementById('tx-modal-overlay');

        function openTransactionModal(tx) {
            if (!txModal) return;

            // 1. Simpan ID untuk aksi (delete/edit)
            currentTransactionId = tx.id;

            // 2. Isi data modal
            document.getElementById('tx-modal-icon').textContent = tx.icon || tx.category.charAt(0);
            document.getElementById('tx-modal-category-name').textContent = tx.category;
            
            const amountEl = document.getElementById('tx-modal-amount');
            // Pastikan amount adalah angka sebelum toLocaleString
            const amount = Number(tx.amount) || 0;
            const amountString = `${tx.type === 'expense' ? '-' : '+'}Rp${amount.toLocaleString('id-ID')}`;
            amountEl.textContent = amountString;
            amountEl.style.color = tx.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)';

            // Format tanggal dari "YYYY-MM-DD"
            const date = new Date(tx.date + 'T00:00:00'); // Tambahkan T00:00 untuk menghindari masalah zona waktu
            document.getElementById('tx-modal-date').textContent = date.toLocaleDateString('id-ID', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
            
            document.getElementById('tx-modal-account').textContent = tx.account;
            document.getElementById('tx-modal-notes').textContent = tx.notes;
            document.getElementById('tx-modal-wallet').textContent = localStorage.getItem('currentWalletName') || '...';
            
            // 3. Tampilkan modal
            txModal.classList.add('visible');
        }

function closeTransactionModal() {
            if (txModal) {
                txModal.classList.remove('visible');
                currentTransactionId = null; // Hapus ID saat modal ditutup
            }
        }

        // [PERBAIKAN] Fungsi yang hilang, sekarang ditambahkan
        async function handleDeleteTransaction(txId) {
            // Gunakan ID from parameter (swipe) atau dari global (modal)
            const transactionIdToDelete = txId || currentTransactionId;
            if (!transactionIdToDelete) return;

            const confirmed = await showDialog({
                title: 'Hapus Transaksi',
                text: 'Apakah Anda yakin ingin menghapus transaksi ini?',
                confirmText: 'Hapus',
                cancelText: 'Batal',
                isDestructive: true
            });
            if (!confirmed) return;

            const walletId = localStorage.getItem('currentWalletId');
            
            try {
                console.log(`Menghapus transaksi: ${transactionIdToDelete}...`);

                await fetchApi(`/wallets/${walletId}/transactions/${transactionIdToDelete}`, {
                    method: 'DELETE'
                });

                console.log('Transaksi berhasil dihapus.');
                closeTransactionModal(); // Tutup modal (jika terbuka)
                updateMainView();      // Muat ulang list
                
            } catch (error) {
                console.error('Gagal menghapus transaksi:', error);
                showDialog({ title: 'Error', text: 'Gagal menghapus: ' + error.message });
            }
        }

        // [PERBAIKAN] Hanya satu fungsi edit yang benar
        function handleEditTransaction(txId) {
            const transactionIdToEdit = txId || currentTransactionId;
            if (!transactionIdToEdit) return;

            const tx = transactions.find(t => t.id === transactionIdToEdit);
            
            if (tx) {
                sessionStorage.setItem('tx_for_edit', JSON.stringify(tx));
                closeTransactionModal(); // Tutup modal (jika terbuka)
                navigate('/create');
            } else {
                showDialog({ title: 'Error', text: 'Gagal menemukan data transaksi untuk diedit.' });
            }
        }
        // === [BARU] FUNGSI-FUNGSI MODAL TANGGAL ===
const dateModal = document.getElementById('date-modal-overlay');

function selectDate() {
    // Fungsi ini dipanggil dari create.html
    // Atur tanggal modal ke tanggal yang sedang dipilih
    modalCalendarDate = new Date(selectedTransactionDate.getTime());
    renderDateModalCalendar();
    if(dateModal) dateModal.classList.add('visible');
}

function closeDateModal() {
    if(dateModal) dateModal.classList.remove('visible');
}

function dateModalNav(direction) {
    modalCalendarDate.setMonth(modalCalendarDate.getMonth() + direction);
    renderDateModalCalendar();
}

function handleDateSelect(day, month, year) {
    selectedTransactionDate = new Date(year, month, day);
    updateCreateDateButton(); // Update teks tombol
    closeDateModal(); // Tutup modal
}

function updateCreateDateButton() {
    const display = document.getElementById('create-date-display');
    if (!display) return;

    const today = new Date();
    const yesterday = new Date(today.getTime() - 86400000);

    if (selectedTransactionDate.toDateString() === today.toDateString()) {
        display.textContent = 'TODAY';
    } else if (selectedTransactionDate.toDateString() === yesterday.toDateString()) {
        display.textContent = 'KEMARIN';
    } else {
        // Format: DD/MM
        display.textContent = selectedTransactionDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' });
    }
}

function renderDateModalCalendar() {
    const content = document.getElementById('date-modal-content');
    if (!content) return;

    const year = modalCalendarDate.getFullYear();
    const month = modalCalendarDate.getMonth();

    let header = `
        <div class="calendar-header">
            <i class="fas fa-chevron-left" onclick="dateModalNav(-1)"></i>
            <span class="month-year">${monthNames[month]} ${year}</span>
            <i class="fas fa-chevron-right" onclick="dateModalNav(1)"></i>
        </div>
        <div class="calendar-weekdays">
            <div class="day-name weekend">Min</div><div class="day-name">Sen</div><div class="day-name">Sel</div>
            <div class="day-name">Rab</div><div class="day-name">Kam</div><div class="day-name">Jum</div>
            <div class="day-name weekend">Sab</div>
        </div>
        <div class="calendar-grid" id="date-modal-grid"></div>
    `;
    content.innerHTML = header;

    const calendarGrid = document.getElementById('date-modal-grid');
    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();

    for (let i = 0; i < firstDayOfMonth; i++) {
        calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); // Sel kosong
    }

    for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'day';

        const date = new Date(year, month, i);
        const dayOfWeek = date.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');

        // Cek apakah ini hari ini
        if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayEl.classList.add('today');
        }

        // Cek apakah ini tanggal yang dipilih
        if (i === selectedTransactionDate.getDate() && month === selectedTransactionDate.getMonth() && year === selectedTransactionDate.getFullYear()) {
            dayEl.classList.add('selected');
        }

        dayEl.innerHTML = `<span class="date-number">${i}</span>`;
        dayEl.onclick = () => handleDateSelect(i, month, year);
        calendarGrid.appendChild(dayEl);
    }
}
// === [AKHIR FUNGSI MODAL TANGGAL] ===


        // [BARU] Fungsi untuk mengambil data awal (dompet & akun) saat aplikasi dimuat
       // [PERBAIKAN] Fungsi ini sekarang memprioritaskan dompet di localStorage
 

       // [PERBAIKAN KATEGORI] Ganti total fungsi ini
       async function initializeAppData() {
            try {
                // 1. Cek apakah sudah ada dompet yang dipilih sebelumnya
                const preferredWalletId = localStorage.getItem('currentWalletId');

                // 2. Ambil semua dompet milik user
                const wallets = await fetchApi('/wallets');
                if (!wallets || wallets.length === 0) {
                    console.warn('User tidak punya dompet. Mengarahkan ke /create-wallet');
                    window.location.href = '/create-wallet'; 
                    return;
                }

                // 3. Tentukan dompet aktif
                let activeWallet;
                if (preferredWalletId) {
                    // Cari dompet yang tersimpan di localStorage dari daftar API
                    activeWallet = wallets.find(w => w.id === preferredWalletId);
                }

                // Jika tidak ada dompet yang tersimpan (atau tidak valid), gunakan dompet pertama
                if (!activeWallet) {
                    activeWallet = wallets[0];
                }
                
                // 4. Simpan dompet aktif yang valid ke localStorage
                localStorage.setItem('currentWalletId', activeWallet.id);
                localStorage.setItem('currentWalletName', activeWallet.name); 
                localStorage.setItem('currentWalletIcon', activeWallet.icon || ''); // <-- TAMBAHKAN BARIS INI
                console.log(`Dompet aktif diatur: ${activeWallet.name} (${activeWallet.id})`);

                // 5. [INI BAGIAN KUNCINYA] Ambil akun dan kategori untuk dompet aktif
                const [accounts, categories] = await Promise.all([
                    fetchApi(`/wallets/${activeWallet.id}/accounts`),
                    fetchApi(`/wallets/${activeWallet.id}/categories`)
                ]);

                // 6. Simpan Akun ke Global
                allAccounts = accounts;
                if (!accounts || accounts.length === 0) {
                    console.error('ERROR: Dompet ini tidak memiliki akun!');
                    // Di aplikasi nyata, ini idealnya tidak terjadi
                } else {
                    // Tetapkan akun default (utamakan ASET)
                    const defaultAccount = accounts.find(a => a.type === 'ASSET') || accounts[0];
                    selectedAccountId = defaultAccount.id; // Set var global
                    console.log(`Akun aktif diatur: ${defaultAccount.name} (${defaultAccount.id})`);
                }

                // 7. Simpan Kategori ke Global
                allCategories = categories; // <--- INI AKAN MENGISI ARRAY
                console.log(`Berhasil memuat ${allCategories.length} kategori.`);
                // [AKHIR BAGIAN KUNCI]


                // 8. Panggil 'runPageInit' SETELAH semua data siap
                runPageInit(location.pathname);

            } catch (error) {
                console.error("Gagal inisialisasi data aplikasi:", error);
                if (error.message !== 'Sesi kedaluwarsa') {
                    alert("Gagal inisialisasi data: " + error.message);
                }
            }
        }
        function getSettings() {
            try {
                const settings = localStorage.getItem(settingsKey);
                // Default jika tidak ada settings: { theme: 'system' }
                return settings ? JSON.parse(settings) : { theme: 'system' };
            } catch (e) {
                return { theme: 'system' }; // Fallback jika JSON rusak
            }
        }

        function saveSettings(settingsObject) {
            try {
                // Ambil settings yang ada, lalu gabungkan dengan yang baru
                const existingSettings = getSettings();
                const newSettings = { ...existingSettings, ...settingsObject };
                localStorage.setItem(settingsKey, JSON.stringify(newSettings));
            } catch (e) {
                console.error("Gagal menyimpan settings:", e);
            }
        }
        /**
         * [BARU] Menerapkan/menghapus kelas 'balance-masked' ke kontainer utama
         */
        function applyMaskingState(isMasked) {
            const container = document.getElementById('app-container');
            if (container) {
                // Terapkan 'balance-masked' jika isMasked true, hapus jika false
                container.classList.toggle('balance-masked', isMasked);
            }
        }

        /**
         * [BARU] Dipanggil saat ikon mata diklik
         */
        function toggleBalanceMasking() {
            // 1. Ambil settings saat ini
            let settings = getSettings();
            
            // 2. Invert nilainya (jika tidak ada, anggap false -> jadi true)
            const newMaskedState = !settings.isBalanceMasked;
            
            // 3. Simpan state baru ke localStorage
            saveSettings({ isBalanceMasked: newMaskedState });
            
            // 4. Terapkan state baru ke UI
            applyMaskingState(newMaskedState);
            console.log(`Masking saldo: ${newMaskedState}`);
        }
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else if (theme === 'light') {
                htmlEl.classList.remove('dark');
            } else {
                // Mode 'system' (default)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            }
        }

        // Terapkan tema segera saat skrip ini dimuat
        let currentSettings = getSettings();
        applyTheme(currentSettings.theme);
        
        // Fungsi ini dipanggil oleh init...Page()
        function attachThemeToggle(selector) {
            const themeToggleBtn = document.querySelector(selector);
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const isCurrentlyDark = htmlEl.classList.contains('dark');
                    const newTheme = isCurrentlyDark ? 'light' : 'dark';
                    applyTheme(newTheme); 
                    saveSettings({ theme: newTheme }); // Simpan pilihan baru
                });
            }
        }
        // --- [AKHIR BAGIAN 0] ---


        // === BAGIAN 1: VARIABEL & FUNGSI GLOBAL ===
        let currentDate = new Date();
        let selectedDate = new Date();
        let transactions = []; // Data dummy, ganti dengan API call
        let currentView = 'overview';
        let calendarFilter = 'expense';
        // Variabel global untuk 'create.html'
        let currentType = 'expense';
        let selectedCategory = null;
        let calcValue = '0';
        let waitingForEquals = false;
        let currentNotes = '';
        const NOTE_SUGGESTIONS_KEY = 'casflo_note_suggestions';

        let allCategories = [];
        let allAccounts = [];
        let selectedAccountId = null; // Kita akan kelola ini secara global
        let currentTransactionId = null; // [BARU] Untuk modal detail
        let selectedTransactionDate = new Date(); // [BARU] Default ke hari ini
        let modalCalendarDate = new Date(); // [BARU] Untuk navigasi di modal

        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        const OPEN_BOOKS_KEY = 'casflo_open_books';
        function getOpenBooks() {
            try {
                const openBooks = localStorage.getItem(OPEN_BOOKS_KEY);
                return openBooks ? JSON.parse(openBooks) : [];
            } catch (e) {
                return [];
            }
        }
        function saveOpenBooks(booksArray) {
            localStorage.setItem(OPEN_BOOKS_KEY, JSON.stringify(booksArray));
        }
        let dialogResolve = null;

        /**
         * [BARU] Menutup modal dialog dan me-resolve promise
         */
        function closeDialog(value) {
            document.getElementById('dialog-modal-overlay')?.classList.remove('visible');
            if (dialogResolve) {
                dialogResolve(value); // Mengirimkan 'true' atau 'false'
                dialogResolve = null; // Reset
            }
        }

        /**
         * [BARU] Pengganti kustom untuk alert() dan confirm()
         * @param {object} options - { title, text, confirmText, cancelText, isDestructive }
         * @returns {Promise<boolean>} - true jika 'confirm' diklik, false jika 'cancel'
         */
        function showDialog(options) {
            const modal = document.getElementById('dialog-modal-overlay');
            const titleEl = document.getElementById('dialog-modal-title');
            const textEl = document.getElementById('dialog-modal-text');
            const confirmBtn = document.getElementById('dialog-modal-confirm-btn');
            const cancelBtn = document.getElementById('dialog-modal-cancel-btn');

            if (!modal || !titleEl || !textEl || !confirmBtn || !cancelBtn) {
                // Fallback jika elemen modal tidak ada
                console.error("Modal dialog tidak ditemukan. Menggunakan confirm bawaan.");
                return Promise.resolve(confirm(options.text));
            }

            titleEl.textContent = options.title || 'Konfirmasi';
            textEl.textContent = options.text || '';
            confirmBtn.textContent = options.confirmText || 'OK';
            
            // Tampilkan/sembunyikan tombol Batal
            if (options.cancelText) {
                cancelBtn.textContent = options.cancelText;
                cancelBtn.style.display = 'block';
            } else {
                cancelBtn.style.display = 'none'; // Mode "Alert"
            }
            
            // Atur warna tombol Konfirmasi (merah jika destruktif)
            confirmBtn.classList.toggle('destructive', options.isDestructive === true);

            // Tampilkan modal
            modal.classList.add('visible');

            // Buat Promise baru yang akan menunggu respons user
            return new Promise((resolve) => {
                dialogResolve = resolve; // Simpan fungsi resolve secara global
                
                // Hapus listener lama agar tidak menumpuk
                confirmBtn.onclick = null; 
                cancelBtn.onclick = null;

                // Tambahkan listener baru
                confirmBtn.onclick = () => closeDialog(true);
                cancelBtn.onclick = () => closeDialog(false);
            });
        }
        function appendToCalc(value) {
            const operators = ['+', '-', '*', '/'];
            
            if (operators.includes(value)) {
                waitingForEquals = true;
                changeButtonToEquals();
            }
            
            // [PERBAIKAN] Mencegah duplikat titik/koma
            if (value === '.' && calcValue.includes('.')) {
                return; // Jangan lakukan apa-apa jika sudah ada titik
            }

            if (calcValue === '0' && !operators.includes(value) && value !== '.') {
                calcValue = value;
            } else {
                const lastChar = calcValue.slice(-1);
                if (operators.includes(lastChar) && operators.includes(value)) {
                    calcValue = calcValue.slice(0, -1) + value;
                } else {
                    calcValue += value;
                }
            }
            updateDisplay();
        }
        function adjustFontSize() {
            const amountDisplay = document.getElementById("amountDisplay");
            
            // 1. Tentukan ukuran font maks & min
            const maxFontSize = 28; // misal 28px
            const minFontSize = 20; // misal 20px
            let currentFontSize = maxFontSize;

            // 2. Reset ke ukuran font terbesar dulu
            amountDisplay.style.fontSize = `${currentFontSize}px`;

            // 3. Cek apakah teksnya 'overflow' (kepanjangan)
            // scrollWidth = lebar total teks
            // clientWidth = lebar kotak yang terlihat
            while (amountDisplay.scrollWidth > amountDisplay.clientWidth && currentFontSize > minFontSize) {
                
                // 4. Jika kepanjangan, kecilkan font-nya 1px
                currentFontSize--;
                amountDisplay.style.fontSize = `${currentFontSize}px`;
            }
        }

        function deleteLast() { calcValue = calcValue.slice(0, -1) || '0'; checkWaitingForEquals(); updateDisplay(); }
        function handleActionClick() { 
            if (waitingForEquals) {
                calculateResult(); 
            } else if (currentTransactionId) {
                updateTransaction(); // [UBAH INI]
            } else {
                saveTransaction(); 
            }
        }
        function selectType(type) { currentType = type; document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active')); document.getElementById(type + 'Btn').classList.add('active'); selectedCategory = null; loadCategories(); }
        function updateDisplay() {
            const amountDisplay = document.getElementById('amountDisplay');
            if (!amountDisplay) return;

            // ... (logika formatting angka) ...
            let parts = calcValue.split('.');
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            let displayValue;
            if (parts.length > 1) {
                displayValue = integerPart + ',' + (parts[1] || '');
            } else {
                displayValue = integerPart;
            }
            
            amountDisplay.textContent = displayValue;

            // [PERBAIKAN DITAMBAHKAN DI SINI]
            adjustAmountFontSize(); // Panggil fungsi scaling
        }
        function checkWaitingForEquals() { const hasOperator = ['+', '-', '*', '/'].some(op => calcValue.includes(op)); if (!hasOperator) { waitingForEquals = false; changeButtonToCheck(); } }
        function changeButtonToEquals() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn equals'; actionBtn.innerHTML = '<i class="fas fa-equals"></i>'; }}
        function changeButtonToCheck() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn check'; actionBtn.innerHTML = '<i class="fas fa-check"></i>'; }}
        function calculateResult() { try { let expression = calcValue.replace(//g, '*').replace(//g, '/'); const result = eval(expression); calcValue = String(result); waitingForEquals = false; changeButtonToCheck(); updateDisplay(); } catch (e) { calcValue = '0'; updateDisplay(); } }
        function clearCalc() { calcValue = '0'; waitingForEquals = false; changeButtonToCheck(); updateDisplay(); }
        function loadCategories() {
            // [PERBAIKAN] Filter dari 'allCategories' global, sesuaikan 'type'
            const typeToFilter = currentType.toUpperCase(); // 'expense' -> 'EXPENSE'
            const categories = allCategories.filter(cat => cat.type === typeToFilter);

            const recommendedGrid = document.getElementById('recommendedGrid');
            const uncategorizedGrid = document.getElementById('uncategorizedGrid');
            if(!recommendedGrid || !uncategorizedGrid) return;
            
            recommendedGrid.innerHTML = '';
            uncategorizedGrid.innerHTML = '';
            
            // Logika slice dan render tetap sama
            categories.slice(0, 4).forEach(cat => recommendedGrid.appendChild(createCategoryElement(cat)));
            categories.slice(4).forEach(cat => uncategorizedGrid.appendChild(createCategoryElement(cat)));
        }
        
/* ====================================================== */
/* FUNGSI-FUNGSI UNTUK NOTES-VIEW */
/* ====================================================== */
const notesModalInput = document.getElementById('notes-modal-input');

function openNotesView() {
    const calcSection = document.getElementById('main-calculator-section'); 
    if (!calcSection || !notesModalInput) {
        console.error("Gagal menemukan #main-calculator-section atau #notes-modal-input");
        return;
    }

    // 1. Isi textarea dengan catatan yang ada
    notesModalInput.value = currentNotes;
    
    // 2. Tampilkan view dengan menambah kelas
    calcSection.classList.add('notes-active');
    
    // 3. Muat sugesti dinamis
    loadNoteSuggestions(); 

    // 4. [KUNCI] Fokus ke textarea untuk memunculkan keyboard
    notesModalInput.focus();
}

function closeNotesView(shouldSave = false) {
    const calcSection = document.getElementById('main-calculator-section');
    if (!calcSection || !notesModalInput) return;

    if (shouldSave) {
        // 1. Ambil teks dari modal dan simpan ke global
        currentNotes = notesModalInput.value;
        
        // 2. Update tampilan preview di kalkulator
        const preview = document.getElementById('notes-display-preview');
        if (preview) {
            preview.textContent = currentNotes;
        }
    }
    
    // 3. Sembunyikan view dengan menghapus kelas
    calcSection.classList.remove('notes-active');
    
    // 4. Hapus fokus untuk sembunyikan keyboard
    notesModalInput.focus();
}

function addSuggestion(text) {
    if (!notesModalInput) return;
    
    if (notesModalInput.value.trim() === '') {
        notesModalInput.value = text;
    } else {
        notesModalInput.value += ` ${text}`;
    }
    notesModalInput.focus();
}

function saveNoteSuggestion(note) {
    if (!note || note.trim().length < 3) return; 

    try {
        const rawData = localStorage.getItem(NOTE_SUGGESTIONS_KEY);
        const suggestions = rawData ? JSON.parse(rawData) : [];
        
        const uniqueSuggestions = new Set(suggestions);
        
        uniqueSuggestions.delete(note.trim()); 
        uniqueSuggestions.add(note.trim());
        
        let newList = Array.from(uniqueSuggestions);
        if (newList.length > 10) {
            newList = newList.slice(newList.length - 10);
        }
        
        localStorage.setItem(NOTE_SUGGESTIONS_KEY, JSON.stringify(newList));

    } catch (e) {
        console.error("Gagal menyimpan sugesti catatan:", e);
    }
}

function loadNoteSuggestions() {
    const container = document.getElementById('suggestion-pills-container');
    if (!container) return;

    container.innerHTML = '';
    let suggestions = [];
    try {
        const rawData = localStorage.getItem(NOTE_SUGGESTIONS_KEY);
        suggestions = rawData ? JSON.parse(rawData) : [];
    } catch (e) {
        suggestions = [];
    }

    if (suggestions.length === 0) {
        suggestions = ['Sarapan', 'Belanja Bulanan', 'Transport', 'Makan Siang'];
    }

    suggestions.reverse().forEach(note => {
        const btn = document.createElement('button');
        btn.textContent = note;
        btn.onclick = () => addSuggestion(note);
        container.appendChild(btn);
    });
}
/* ====================================================== */
/* AKHIR BLOK FUNGSI CATATAN */
/* ====================================================== */
        
        function createCategoryElement(category) {
            const div = document.createElement('div');
            div.className = 'category-item';
            div.onclick = () => selectCategory(category, div);
            
            // [PERBAIKAN] Gunakan 'category.icon' dari database.
            // Jika icon-nya null, gunakan huruf pertama sebagai cadangan.
            const icon = category.icon || category.name.charAt(0).toUpperCase();
            const defaultColor = 'var(--light-purple)'; // Warna default

            div.innerHTML = `<div class="category-icon" style="background: ${defaultColor}">${icon}</div><div class="category-name">${category.name}</div>`;
            
            // [TAMBAHKAN INI] Cek jika kategori ini adalah yang sedang dipilih
            if (selectedCategory && category.id === selectedCategory.id) {
                div.classList.add('selected');
            }
            return div;
        }
        
        
        function selectCategory(category, element) { selectedCategory = category; document.querySelectorAll('.category-item').forEach(item => item.classList.remove('selected')); element.classList.add('selected'); }
        async function saveTransaction() {
            try {
                const amount = parseFloat(calcValue); 
                if (isNaN(amount) || amount <= 0) {
                    showDialog({ title: 'Input Tidak Valid', text: 'Masukkan jumlah yang valid.' });
                    return;
                }
                if (!selectedCategory) {
                    showDialog({ title: 'Input Tidak Lengkap', text: 'Pilih kategori terlebih dahulu.' });
                    return;
                }

                // 1. Dapatkan Token & Data Penting dari localStorage
                //    (Kita asumsikan data ini disimpan setelah login/saat memilih dompet)
                const token = localStorage.getItem('sessionToken');
                
                // [PENTING] Anda perlu cara untuk menyimpan dan mengambil walletId dan accountId yang sedang aktif
                // Untuk contoh ini, kita asumsikan ID-nya di-hardcode atau diambil dari localStorage
                const walletId = localStorage.getItem('currentWalletId'); // GANTI INI: Anda harus implementasikan logika untuk ini
                const accountId = selectedAccountId;


                if (!token) {
                    alert('Sesi tidak ditemukan. Silakan login ulang.');
                    navigate('/login');
                    return;
                }
                if (!walletId || !accountId) {
                    alert('Dompet atau akun aktif tidak ditemukan. Silakan muat ulang.');
                    // Di aplikasi nyata, Anda akan mengambil data ini dari API terlebih dahulu
                    // Untuk sementara, kita bisa hentikan di sini
                    console.error("currentWalletId atau selectedAccountId tidak ditemukan di localStorage.");
                    return; 
                }

                // 2. Siapkan Payload (Body) sesuai spesifikasi API Anda
                // Endpoint mengharapkan format YYYY-MM-DD untuk tanggal
                const transactionDate = selectedTransactionDate.toISOString().split('T')[0];
                //const notes = document.getElementById('transaction-notes').value;
                
                const payload = {
                    wallet_id: walletId,
                    type: currentType.toUpperCase(), // API mengharapkan 'EXPENSE' atau 'INCOME'
                    amount: amount, // API Anda di 'queries.js' sudah menangani konversi ke sen
                    category_id: selectedCategory.id,
                    description: currentNotes || selectedCategory.name,
                    transaction_date: transactionDate,
                };

                // API 'queries.js' Anda mengharapkan 'from_account_id' atau 'to_account_id'
                if (currentType === 'expense') {
                    payload.from_account_id = accountId;
                } else {
                    payload.to_account_id = accountId;
                }
                saveNoteSuggestion(currentNotes);
                // (Opsional) Tampilkan loading state di tombol
                changeButtonToLoading(true); // Anda perlu membuat fungsi ini

                // 3. Kirim data ke API
                const response = await fetch(`https://api.casflo.id/api/v1/wallets/${walletId}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // [WAJIB] Kirim token otentikasi
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'Gagal menyimpan transaksi');
                }

                // 4. Sukses!
                console.log('Transaksi berhasil disimpan:', result.data);
                
                // Reset kalkulator & navigasi kembali ke halaman utama
                clearCalc(); 
                currentNotes = ''; // Reset catatan global
                const notesPreview = document.getElementById('notes-display-preview');
                if (notesPreview) notesPreview.textContent = ''; // Reset preview
                navigate('/');

            } catch (error) {
                console.error('Error saving transaction:', error);
                showDialog({ title: 'Error', text: `Terjadi kesalahan: ${error.message}` });
            } finally {
                // (Opsional) Hilangkan loading state
                changeButtonToLoading(false); // Anda perlu membuat fungsi ini
            }
        }
        // ... (setelah fungsi saveTransaction)

        // [BARU] Fungsi untuk UPDATE transaksi
        async function updateTransaction() {
            try {
                const amount = parseFloat(calcValue);
                if (isNaN(amount) || amount <= 0) {
                    showDialog({ title: 'Input Tidak Valid', text: 'Masukkan jumlah yang valid.' });
                    return;
                }
                if (!selectedCategory) {
                    showDialog({ title: 'Input Tidak Lengkap', text: 'Pilih kategori terlebih dahulu.' });
                    return;
                }

                const token = localStorage.getItem('sessionToken');
                const walletId = localStorage.getItem('currentWalletId');
                const accountId = selectedAccountId;

                if (!token || !walletId || !accountId || !currentTransactionId) {
                    console.error("Data update tidak lengkap", { token, walletId, accountId, currentTransactionId });
                    showDialog({ title: 'Error', text: 'Data tidak lengkap untuk memperbarui transaksi.' });
                    return;
                }

                const transactionDate = selectedTransactionDate.toISOString().split('T')[0];
                //const notes = document.getElementById('transaction-notes').value;
                
                const payload = {
                    wallet_id: walletId,
                    type: currentType.toUpperCase(),
                    amount: amount, // Sudah dalam Rupiah
                    category_id: selectedCategory.id,
                    description: currentNotes || selectedCategory.name,
                    transaction_date: transactionDate,
                };

                if (currentType === 'expense') {
                    payload.from_account_id = accountId;
                } else {
                    payload.to_account_id = accountId;
                }

                changeButtonToLoading(true);
                saveNoteSuggestion(currentNotes);

                // Panggil API PUT yang baru kita buat
                const response = await fetch(`https://api.casflo.id/api/v1/wallets/${walletId}/transactions/${currentTransactionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'Gagal memperbarui transaksi');
                }

                console.log('Transaksi berhasil diperbarui:', result.data);
                
                clearCalc(); 
                currentTransactionId = null; // Reset mode edit
                navigate('/'); 

            } catch (error) {
                console.error('Error updating transaction:', error);
                showDialog({ title: 'Error', text: `Terjadi kesalahan: ${error.message}` });
            } finally {
                changeButtonToLoading(false);
            }
        }
        
        // (Opsional) Fungsi helper untuk loading state
        function changeButtonToLoading(isLoading) {
            const actionBtn = document.getElementById('actionBtn');
            if (!actionBtn) return;
            
            if (isLoading) {
                actionBtn.disabled = true;
                actionBtn.innerHTML = '<span class="loading-spinner-tombol"></span>'; // Anda perlu CSS untuk .loading-spinner-tombol
            } else {
                actionBtn.disabled = false;
                // Kembalikan ke tombol 'check' atau 'equals'
                checkWaitingForEquals(); 
            }
        }
        // --- [PERBAIKAN KALENDER] Fungsi Halaman Utama ---
        function setView(viewName) {
            currentView = viewName;
            localStorage.setItem('preferredView', viewName);
            const overviewCard = document.getElementById('overviewCard');
            const calendarCard = document.getElementById('calendarCard');
            const detailToggleBtn = document.getElementById('detailToggleBtn');
            const calendarToggleBtn = document.getElementById('calendarToggleBtn');

            if (detailToggleBtn) detailToggleBtn.classList.toggle('active-view', viewName === 'overview');
            if (calendarToggleBtn) calendarToggleBtn.classList.toggle('active-view', viewName === 'calendar');

            if (viewName === 'overview') {
                if (overviewCard) overviewCard.classList.remove('view-hidden');
                if (calendarCard) calendarCard.classList.add('view-hidden');
            } else {
                if (overviewCard) overviewCard.classList.add('view-hidden');
                if (calendarCard) calendarCard.classList.remove('view-hidden');
                renderCalendar(); 
            }
        }
        function updateMonthDisplay() { 
            const display = document.getElementById('currentMonthDisplay');
            const calendarDisplay = document.getElementById('calendarMonthYear');
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            if (display) {
                display.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;
            }
            if (calendarDisplay) {
                 calendarDisplay.textContent = `${monthNames[month]} ${year}`;
            }

            // [BARU] Sembunyikan spinner tanggal
            const dateWrapper = document.getElementById('dateSelectorWrapper');
            if (dateWrapper) {
                dateWrapper.classList.remove('loading');
            }

            updateMainView(); 
        }
        function goToPrevMonth() { 
            document.getElementById('dateSelectorWrapper')?.classList.add('loading');
            // [PERBAIKAN] Tampilkan spinner di daftar transaksi SEGERA
            document.getElementById('transactionListContainer')?.classList.add('loading');
            
            currentDate.setMonth(currentDate.getMonth() - 1); 
            if(currentView === 'calendar') { renderCalendar(); } 
            updateMonthDisplay(); 
        }
        function goToNextMonth() { 
            document.getElementById('dateSelectorWrapper')?.classList.add('loading');
            // [PERBAIKAN] Tampilkan spinner di daftar transaksi SEGERA
            document.getElementById('transactionListContainer')?.classList.add('loading');
            
            currentDate.setMonth(currentDate.getMonth() + 1); 
            if(currentView === 'calendar') { renderCalendar(); } 
            updateMonthDisplay(); 
        }
        function setCalendarFilter(filter) { 
            calendarFilter = filter;
            if (document.getElementById('tabPengeluaran')) document.getElementById('tabPengeluaran').classList.toggle('active', filter === 'expense');
            if (document.getElementById('tabPenghasilan')) document.getElementById('tabPenghasilan').classList.toggle('active', filter === 'income');
            if (document.getElementById('tabTotal')) document.getElementById('tabTotal').classList.toggle('active', filter === 'total');
            renderCalendar();
        }
        function renderCalendar() { 
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            console.log("Merender kalender...");
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const date = new Date(year, month, i);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                dayEl.innerHTML = `<span class="date-number">${i}</span>`;
                
                let dailyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getDate() === i && tDate.getMonth() === month && tDate.getFullYear() === year;
                });
                if (calendarFilter === 'expense') { dailyTransactions = dailyTransactions.filter(t => t.type === 'expense'); } 
                else if (calendarFilter === 'income') { dailyTransactions = dailyTransactions.filter(t => t.type === 'income'); }
                
                const dailyTotal = dailyTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? -t.amount : t.amount), 0);
                
                if(dailyTotal !== 0){ 
                    const summaryEl = document.createElement('span'); 
                    summaryEl.className = 'day-summary'; 
                    summaryEl.style.backgroundColor = dailyTotal < 0 ? 'var(--expense-red)' : 'var(--income-green)'; 
                    if (calendarFilter === 'total' && dailyTotal > 0) summaryEl.style.backgroundColor = 'var(--income-green)'; 
                    summaryEl.textContent = `${dailyTotal < 0 ? '-' : ''}${Math.abs(dailyTotal/1000).toFixed(0)}k`; 
                    dayEl.appendChild(summaryEl); 
                }
                calendarGrid.appendChild(dayEl);
            }
        }
function renderTransactionList(filteredTransactions) { 
            const transactionListEl = document.getElementById('transactionListContent');
            if (!transactionListEl) return;
            transactionListEl.innerHTML = '';
            
            const collapsedGroups = getCollapsedGroups();
            
            const grouped = filteredTransactions.reduce((acc, tx) => {
                const dateKey = new Date(tx.date).toDateString();
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(tx);
                return acc;
            }, {});

            if (Object.keys(grouped).length === 0) {
                transactionListEl.innerHTML = `<div class="empty-transaction-list">Belum ada transaksi di bulan ini</div>`;
                return;
            }

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            for (const dateKey of sortedDates) {
                const txsOnThisDate = grouped[dateKey];
                const date = new Date(dateKey);
                
                const totalExpenseOnDate = txsOnThisDate
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const groupEl = document.createElement('div');
                groupEl.className = 'transaction-group card';

                const listHeader = document.createElement('div');
                listHeader.className = 'list-header';
                
                listHeader.innerHTML = `<div class="date-info"><i class="fas fa-chevron-down fa-xs"></i><span>${date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: '2-digit' })}</span></div><div class="summary"><span>Pengeluaran:</span> <span class="data-maskable-amount expense">Rp${(totalExpenseOnDate).toLocaleString('id-ID')}</span></div>`;
                
                listHeader.onclick = () => toggleGroupCollapse(dateKey, listHeader);
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'transaction-items-container';

                if (collapsedGroups.includes(dateKey)) {
                    groupEl.classList.add('collapsed');
                }
                
                groupEl.appendChild(listHeader);

                // [PERBAIKAN DIMULAI DI SINI]
                // [PERBAIKAN DIMULAI DI SINI]
                txsOnThisDate.forEach(t => {
                    // 1. Buat elemen item transaksi
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item'; // Hanya kelas ini
                    itemEl.style.cursor = 'pointer'; // Tambahkan cursor pointer
                    
                    const categoryName = t.category || 'Tanpa Kategori';
                    const icon = t.icon || categoryName.charAt(0).toUpperCase();
                    
                    // 2. Isi HTML-nya
                    itemEl.innerHTML = `
                        <div class="icon" style="background-color: ${t.color};"><span>${icon}</span></div>
                        <div class="details"><div class="category">${categoryName}</div><div class="notes">${t.notes}</div></div>
                        <div class="info">
                            <div class="amount data-maskable-amount" 
                                 style="color: ${t.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)'}"
                                 data-masked-color="${t.type}">
                                ${t.type === 'expense' ? '-' : '+'}Rp${(t.amount).toLocaleString('id-ID')}
                            </div>
                            <div class="account">${t.account}</div>
                        </div>`;

                    // 3. Tambahkan listener klik yang sederhana
                    itemEl.onclick = () => {
                        openTransactionModal(t); // Langsung buka modal
                    };

                    // 4. Append item langsung ke kontainer
                    itemsContainer.appendChild(itemEl);
                });
                // [PERBAIKAN SELESAI]
                
                groupEl.appendChild(itemsContainer);
                transactionListEl.appendChild(groupEl);
            }
        }
       // [PERBAIKAN] Fungsi diubah menjadi async untuk mengambil data dari API
        // [PERBAIKAN] Fungsi diubah menjadi async untuk mengambil data dari API
        async function updateMainView() { 
            console.log("Memuat data Transaksi untuk", currentDate.toISOString().slice(0, 7));
            
            const walletId = localStorage.getItem('currentWalletId');
            if (!walletId) {
                console.warn("updateMainView: Menunggu walletId...");
                return;
            }

            // [PERBAIKAN] Pindahkan definisi variabel ke SINI
            const transactionListContainer = document.getElementById('transactionListContainer');

            // Tentukan rentang tanggal untuk filter API
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            // Format YYYY-MM-DD
            const startDate = new Date(year, month, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

            try {
                // [MODIFIKASI] Tampilkan lagi spinner list
                if (transactionListContainer) {
                    transactionListContainer.classList.add('loading');
                }

                // Ambil transaksi dari API, BUKAN dari array global
                // [MEMANGGIL API] GET /api/v1/wallets/:walletId/transactions
                const fetchedTransactions = await fetchApi(
                    `/wallets/${walletId}/transactions?startDate=${startDate}&endDate=${endDate}`
                );
                
                // [PENTING] Konversi data API ke format yang diharapkan oleh renderTransactionList()
                // BLOK BARU YANG BENAR:
                transactions = fetchedTransactions.map(tx => {
                    // API mengirim: 'EXPENSE' (amount positif) atau 'INCOME' (amount negatif)
                    const isExpense = tx.category_type === 'EXPENSE'; 
                    return {
                        id: tx.id,
                        type: isExpense ? 'expense' : 'income',
                        amount: Math.abs(tx.amount), // Ini sudah Rupiah
                        category: tx.category_name,
                        notes: tx.description || 'Tanpa catatan',
                        account: tx.account_name, 
                        icon: tx.category_icon, // [PERBAIKAN] Gunakan ikon dari API
                        color: 'var(--light-purple)', // Warna default

                        // [PERBAIKAN BUG] Tambahkan T00:00:00 untuk menghindari error timezone
                        date: tx.transaction_date + 'T00:00:00', 

                        category_id: tx.category_id, // [TAMBAHKAN INI]
                        account_id: tx.account_id   // [TAMBAHKAN INI]
                    };
                });
                loadOverviewData(startDate, endDate);
                // [DIHAPUS] Logika untuk overview card (total, income, expense) dihapus dari sini

                // [MODIFIKASI] Logika ini tetap diperlukan untuk Tampilan Kalender
                // [MODIFIKASI] Logika ini tetap diperlukan untuk Tampilan Kalender
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const total = income - expense;
                
                // [BARU] Ambil elemen & wrapper kalender
                const calTotalEl = document.getElementById('calendarTotalAmount');
                const calIncomeEl = document.getElementById('calendarIncomeAmount');
                const calExpenseEl = document.getElementById('calendarExpenseAmount');
                
                // Wrapper-nya adalah parent <div> dari elemen di atas
                if (calTotalEl) formatAndSetDisplay(calTotalEl.parentElement, calTotalEl, total, 'total');
                if (calIncomeEl) formatAndSetDisplay(calIncomeEl.parentElement, calIncomeEl, income, 'income');
                if (calExpenseEl) formatAndSetDisplay(calExpenseEl.parentElement, calExpenseEl, expense, 'expense');
                renderTransactionList(transactions.sort((a, b) => new Date(b.date) - new Date(a.date)));
                
                // [MODIFIKASI] Sembunyikan spinner list setelah selesai
                if (transactionListContainer) {
                    transactionListContainer.classList.remove('loading');
                }

                if(currentView === 'calendar') renderCalendar();
            
            } catch (error) {
                console.error("Gagal memuat transaksi:", error);
                if (error.message !== 'Sesi kedaluwarsa') {
                   showDialog({ title: 'Error', text: "Gagal memuat transaksi: " + error.message });
                }
                // [MODIFIKASI] Jika gagal, tetap sembunyikan loading
                if (transactionListContainer) {
                    transactionListContainer.classList.remove('loading');
                    // [PERBAIKAN] Kosongkan dulu, baru isi pesan error
                    const transactionListEl = document.getElementById('transactionListContent');
                    if (transactionListEl) {
                        transactionListEl.innerHTML = `<div class="empty-transaction-list">Gagal memuat transaksi.</div>`;
                    }
                }
            }
        }// === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        // Fungsi helper untuk update ikon akun di halaman /create
        function updateAccountIcon(accountId) {
            const account = allAccounts.find(acc => acc.id === accountId);
            if (!account) return;

            const accountCard = document.querySelector('.account-card');
            if (accountCard) {
                // Tampilkan 2 huruf inisial nama akun
                const initial = account.name.substring(0, 2).toUpperCase();
                accountCard.innerHTML = `<span style="font-size: 1.2rem; font-weight: 600;">${initial}</span>`;
            }
        }

        // Implementasi fungsi selectAccount()
        function selectAccount() {
            if (allAccounts.length === 0) return; // Belum dimuat

            // 1. Cari indeks akun yang sedang dipilih
            const currentIndex = allAccounts.findIndex(acc => acc.id === selectedAccountId);
            // 2. Dapatkan indeks berikutnya, kembali ke 0 jika sudah di akhir
            const nextIndex = (currentIndex + 1) % allAccounts.length;
            
            const nextAccount = allAccounts[nextIndex];
            selectedAccountId = nextAccount.id; // 3. Set akun baru secara global

            // 4. Update UI
            updateAccountIcon(selectedAccountId);
            console.log(`Akun diubah ke: ${nextAccount.name}`);
        }

        // === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        async function initMainPage() {
        console.log("Halaman Utama diinisialisasi.");
        document.getElementById('detailToggleBtn')?.addEventListener('click', () => setView('overview'));
        document.getElementById('calendarToggleBtn')?.addEventListener('click', () => setView('calendar'));
        document.getElementById('prevMonthBtn')?.addEventListener('click', goToPrevMonth);
        document.getElementById('nextMonthBtn')?.addEventListener('click', goToNextMonth);
        document.getElementById('calendarPrevMonthBtn')?.addEventListener('click', goToPrevMonth);
        document.getElementById('calendarNextMonthBtn')?.addEventListener('click', goToNextMonth);
        document.getElementById('tabPengeluaran')?.addEventListener('click', () => setCalendarFilter('expense'));
        document.getElementById('tabPenghasilan')?.addEventListener('click', () => setCalendarFilter('income'));
        document.getElementById('tabTotal')?.addEventListener('click', () => setCalendarFilter('total'));
        document.getElementById('mainBookIconBtn')?.addEventListener('click', openWalletSwitcher);
        document.getElementById('toggleMaskBtn')?.addEventListener('click', toggleBalanceMasking);
        //document.getElementById('walletSwitcherBtn')?.addEventListener('click', openWalletSwitcher);
        // HAPUS createNewWalletBtn listener, karena tombol itu dibuat dinamis oleh renderWalletActions

        // [PERBAIKAN] Logika inisialisasi yang baru:
        // const walletName = localStorage.getItem('currentWalletName');
        // if (walletName) {
        //     // 1. Update nama di dropdown atas
        //     const walletNameEl = document.getElementById('currentWalletNameDisplay');
        //     if (walletNameEl) walletNameEl.textContent = walletName;
        //     const headerParent = document.getElementById('walletSwitcherBtn');
        //     if (headerParent) headerParent.classList.remove('loading');
        // }

        // 2. Render tombol-tombol ikon dompet
        await renderWalletActions();


        const savedView = localStorage.getItem('preferredView');
        if (document.getElementById('detailToggleBtn')) { 
            setView(savedView || 'overview');
        }
        
        // 4. Muat daftar transaksi
        if (document.getElementById('currentMonthDisplay')) {
            updateMonthDisplay(); // Ini akan memicu updateMainView (transaction list)
        }

        attachThemeToggle('.theme-toggle'); 
            
        // [BARU] Tampilkan tombol header kanan setelah semua siap
        document.getElementById('header-right-side')?.classList.remove('loading');
    }
  // GANTI FUNGSI LAMA DENGAN INI
function initCreatePage() {
    // [MODIFIKASI] Ambil elemen preview
    const notesPreview = document.getElementById('notes-display-preview');
    const txToEditJSON = sessionStorage.getItem('tx_for_edit');

    if (txToEditJSON) {
        // === MODE EDIT ===
        const tx = JSON.parse(txToEditJSON);

        currentTransactionId = tx.id; 
        currentType = tx.type;
        calcValue = String(tx.amount);
        selectedAccountId = tx.account_id;
        selectedCategory = allCategories.find(c => c.id === tx.category_id);
        selectedTransactionDate = new Date(tx.date); 
        currentNotes = tx.notes || ''; // [MODIFIKASI] Simpan ke var global

        document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active'));
        document.getElementById(currentType + 'Btn').classList.add('active');

        loadCategories(); 
        updateDisplay(); 
        updateAccountIcon(selectedAccountId); 
        if (notesPreview) notesPreview.textContent = currentNotes; // [MODIFIKASI] Update preview

        sessionStorage.removeItem('tx_for_edit');

    } else {
        // === MODE BUAT BARU ===
        currentTransactionId = null; 
        currentType = 'expense';
        selectedCategory = null;
        selectedTransactionDate = new Date(); 
        currentNotes = ''; // [MODIFIKASI] Reset var global
        clearCalc();
        loadCategories(); 
        updateAccountIcon(selectedAccountId); 
        if (notesPreview) notesPreview.textContent = ''; // [MODIFIKASI] Kosongkan preview
    }

    updateCreateDateButton();
    console.log(`Halaman Create dimuat (Mode: ${currentTransactionId ? 'Edit' : 'Baru'})`);
}
        function initWalletPage() { 
            console.log("Halaman dompet dimuat."); 
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }
        
        function initAnalysisPage() {
            console.log("Halaman Analisis dimuat.");

            const activePill = document.querySelector('.header-tabs .active-pill');
            const tabButtons = document.querySelectorAll('.header-tabs .tab-button');
            if (!activePill || !tabButtons.length) return;

            function movePill(targetButton) {
                requestAnimationFrame(() => {
                    if (targetButton) {
                        activePill.style.width = `${targetButton.offsetWidth}px`;
                        activePill.style.left = `${targetButton.offsetLeft}px`;
                    }
                });
            }

            function handleTabClick(event) {
                const clickedButton = event.currentTarget;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                movePill(clickedButton);

                const mode = clickedButton.dataset.mode;
                if (mode === 'pengeluaran') {
                    animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)');
                } else if (mode === 'penghasilan') {
                    animateChart(85, 850000000, 'Penghasilan', 'var(--income-green)');
                } else {
                    animateChart(0, 0, mode.charAt(0).toUpperCase() + mode.slice(1), '#ccc');
                }
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            // [PERBAIKAN KUNCI] Beri jeda sesaat sebelum menghitung posisi awal.
            // Ini memberi waktu bagi browser untuk menyelesaikan render animasi CSS.
            const initialActiveTab = document.querySelector('.header-tabs .tab-button.active');
            if (initialActiveTab) {
                setTimeout(() => {
                    movePill(initialActiveTab);
                }, 50); // Jeda 50 milidetik biasanya sudah cukup.
            }
            
            // Menambahkan listener untuk memperbaiki posisi saat layar dirotasi
            window.addEventListener('resize', () => {
                const currentActiveTab = document.querySelector('.header-tabs .tab-button.active');
                if (currentActiveTab) {
                    movePill(currentActiveTab);
                }
            });
            
                        function animateChart(percentage, totalAmount, label, color) {
                const segment = document.getElementById('chart-segment');
                const amountEl = document.getElementById('chart-total-amount');
                const labelEl = document.getElementById('chart-center-label');
                if (!segment || !amountEl || !labelEl) return;
                labelEl.textContent = label;
                segment.style.stroke = color;
                const radius = segment.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                segment.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (percentage / 100) * circumference;
                segment.style.strokeDashoffset = offset;
                let currentAmount = 0;
                const steps = 100;
                const increment = totalAmount / steps;
                if(window.chartCounter) clearInterval(window.chartCounter);
                window.chartCounter = setInterval(() => {
                    currentAmount += increment;
                    if (currentAmount >= totalAmount) {
                        currentAmount = totalAmount;
                        clearInterval(window.chartCounter);
                    }
                    amountEl.textContent = 'Rp' + Math.floor(currentAmount).toLocaleString('id-ID');
                }, 10);
            }


            setTimeout(() => {
                animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)'); 
            }, 100);
        }

        function initMorePage() {
            currentType = 'expense';
            selectedCategory = null;
            clearCalc();
            loadCategories();
            console.log("Halaman More dimuat.");
        
            const logoutButton = document.getElementById('logout-btn');
        
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => { // <--- [PERBAIKAN] Tambahkan 'async' di sini
                    console.log("Tombol Logout diklik.");
                    
                    const confirmed = await showDialog({ // <--- SEKARANG VALID
                        title: 'Logout',
                        text: 'Apakah Anda yakin ingin logout?',
                        confirmText: 'Logout',
                        cancelText: 'Batal',
                        isDestructive: true
                    });
                    
                    if (confirmed) {
                        // 1. Hapus session token dari localStorage
                        localStorage.removeItem('sessionToken');
                        
                        // 2. Arahkan pengguna kembali ke halaman login (reload penuh)
                        window.location.href = '/login';
                    }
                });
            }

            const gridItems = document.querySelectorAll('.more-grid .grid-item');
            if (gridItems.length > 0) {
                gridItems.forEach((item, index) => {
                    // Terapkan penundaan (delay) untuk setiap item
                    // 50ms * index = 0ms, 50ms, 100ms, dst.
                    setTimeout(() => {
                        item.classList.add('visible');
                    }, index * 50); // Penundaan 50ms per item
                });
            }

        }

// === [FUNGSI-FUNGSI BARU UNTUK books.html] ===

/**
         * [DIUBAH] Mengambil HANYA BUKU (bukan anggota)
         */
       async function loadAllWalletsAndMembers() {
            const listSection = document.getElementById('book-list-section');
            if (!listSection) return;

            listSection.innerHTML = `<div style="text-align: center; padding: 40px 0;">
                                          <span class="div-spinner" style="display: inline-block;"></span>
                                     </div>`;

            try {
                const myUser = await fetchApi('/auth/users/me'); 
                const wallets = await fetchApi('/wallets'); 

                listSection.innerHTML = ''; // Bersihkan spinner

                if (!wallets || wallets.length === 0) {
                    listSection.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light);">Anda belum memiliki buku.</div>`;
                    return;
                }
                
                // Render daftar buku
                for (const wallet of wallets) {
                    const card = document.createElement('div');
                    card.className = 'book-list-card'; 

                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'book-card-header';
                    
                    const canInvite = (wallet.role === 'OWNER' || wallet.role === 'ADMIN');
                    
                    const inviteBtnHtml = canInvite 
                        ? `<button class="book-action-btn invite" title="Undang Anggota" onclick="openInviteModal('${wallet.id}', '${wallet.name}')"><i class="fas fa-user-plus"></i></button>`
                        : '';

                    // [PERBAIKAN 1 & 3] Onclick memanggil toggleMemberList BARU
                    const icon = wallet.icon || ''; // Ambil ikon, beri default 
                    
                    // [INI BAGIAN YANG DIPERBAIKI]
                    // Sekarang tombol edit memanggil 'openEditBookModal' dengan 3 argumen
                    cardHeader.innerHTML = `
                        <div class="book-card-header-title">
                            <div class="book-icon-box">${icon}</div>
                            <h3 class="list-title">${wallet.name}</h3>
                        </div>
                        <div class="book-actions">
                            <button class="book-action-btn collabs" title="Lihat Anggota" onclick="toggleMemberList(this, '${wallet.id}', '${wallet.role}', '${myUser.id}')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            ${inviteBtnHtml}
                            <button class="book-action-btn" title="Ubah Nama" onclick="openEditBookModal('${wallet.id}', '${wallet.name}', '${icon}')"><i class="fas fa-edit"></i></button>
                            <button class="book-action-btn delete" title="Hapus Buku" onclick="handleDeleteBook('${wallet.id}', '${wallet.role}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    // [AKHIR BAGIAN YANG DIPERBAIKI]
                    
                    const memberListDiv = document.createElement('div');
                    memberListDiv.className = 'book-member-list'; // (hidden by default)
                    memberListDiv.innerHTML = `
                        <div class="member-list-loader" style="text-align: center; padding: 15px;">
                            <span class="inline-spinner" style="display: inline-block; border-color: var(--primary-blue); border-top-color: transparent;"></span>
                        </div>`;

                    card.appendChild(cardHeader); 
                    card.appendChild(memberListDiv);
                    listSection.appendChild(card);
                }

            } catch (error) {
                listSection.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--expense-red);">Gagal memuat buku: ${error.message}</div>`;
            }
        }
// === [FUNGSI-FUNGSI BARU UNTUK books.html] ===

        // [BARU] Fungsi untuk membuka modal undangan
        function openInviteModal(walletId, walletName) {
            const modal = document.getElementById('invite-modal-overlay');
            if (!modal) return;

            // Isi data buku ke modal
            document.getElementById('invite-modal-wallet-name').textContent = walletName;
            document.getElementById('invite-modal-wallet-id').value = walletId;
            
            // Bersihkan form & pesan error
            const form = document.getElementById('modal-invite-form');
            form.reset();
            const messageEl = document.getElementById('modal-invite-message');
            messageEl.textContent = '';
            messageEl.className = '';
            
            // Reset tombol submit
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.querySelector('span:not(.loading-spinner)').style.display = 'inline';
            submitBtn.querySelector('.loading-spinner').style.display = 'none';

            modal.classList.add('visible');
        }

        // [BARU] Fungsi untuk menutup modal undangan
        function closeInviteModal() {
            const modal = document.getElementById('invite-modal-overlay');
            if (modal) {
                modal.classList.remove('visible');
            }
        }
        // [BARU] Fungsi-fungsi untuk Modal Konfirmasi Hapus Buku
        const deleteBookModal = document.getElementById('delete-book-modal-overlay');
        const confirmDeleteBookBtn = document.getElementById('confirm-delete-book-btn');
        let currentWalletToDeleteId = null; // Menyimpan ID buku yang akan dihapus

        /**
         * Membuka modal konfirmasi hapus buku
         * @param {string} walletId - ID buku yang akan dihapus
         */
        function openDeleteBookModal(walletId) {
            currentWalletToDeleteId = walletId;
            if (deleteBookModal) {
                deleteBookModal.classList.add('visible');
            }
        }

        /**
         * Menutup modal konfirmasi hapus buku
         */
        function closeDeleteBookModal() {
            currentWalletToDeleteId = null;
            if (deleteBookModal) {
                deleteBookModal.classList.remove('visible');
            }
        }
        async function deleteWallet(walletId, walletName) {
            // [DIUBAH] Panggil modal kustom, bukan window.confirm
            openDeleteBookModal(walletId); 
            // Semua logika penghapusan sekarang ada di handleDeleteBookConfirmed()
        }

        /**
         * Menangani aksi hapus buku setelah konfirmasi
         */
        async function handleDeleteBookConfirmed() {
            if (!currentWalletToDeleteId) return; // Pastikan ada ID yang akan dihapus

            // Nonaktifkan tombol dan tampilkan spinner (opsional, bisa ditambahkan)
            confirmDeleteBookBtn.disabled = true; 
            confirmDeleteBookBtn.textContent = 'Menghapus...'; // Ganti teks sementara

            try {
                // Panggil API untuk menghapus buku
                await fetchApi(`/wallets/${currentWalletToDeleteId}`, {
                    method: 'DELETE'
                });

                closeDeleteBookModal();
                showDialog({ title: 'Berhasil', text: 'Buku berhasil dihapus!', type: 'success' });
                // Muat ulang daftar dompet atau arahkan ke halaman lain jika perlu
                loadAllWalletsAndMembers(); // Muat ulang daftar buku
                
                // [BARU] Perbarui wallet di local storage jika yang dihapus adalah buku yang sedang aktif
                if (localStorage.getItem('currentWalletId') === currentWalletToDeleteId) {
                    localStorage.removeItem('currentWalletId'); // Hapus yang lama
                    // Jika ada buku lain, set buku pertama sebagai aktif
                    const firstWallet = await fetchApi('/wallets'); 
                    if (firstWallet && firstWallet.length > 0) {
                        selectWallet(firstWallet[0].id, firstWallet[0].name, firstWallet[0].icon);
                    } else {
                        // Jika tidak ada buku sama sekali, arahkan ke onboarding/buat buku baru
                        // Atur sesuai alur aplikasi Anda jika tidak ada buku
                        console.log("Tidak ada buku tersisa, perlu alur pembuatan buku baru.");
                        renderWalletActions(); // Ini akan menampilkan pesan "Buat Buku Baru"
                    }
                } else {
                    renderWalletActions(); // Cukup update tampilan header dompet jika yang dihapus bukan yang aktif
                }

            } catch (error) {
                console.error("Gagal menghapus buku:", error);
                showDialog({ title: 'Error', text: error.message || 'Gagal menghapus buku.' });
            } finally {
                // Reset tombol dan variabel
                confirmDeleteBookBtn.disabled = false;
                confirmDeleteBookBtn.textContent = 'Hapus Buku'; 
                currentWalletToDeleteId = null;
            }
        }

        // Event listener untuk tombol konfirmasi di modal
        confirmDeleteBookBtn.addEventListener('click', handleDeleteBookConfirmed);
        
        // [PERBAIKAN PERFORMA - FUNGSI DIUBAH TOTAL]
async function toggleMemberList(buttonElement, walletId, walletRole, myUserId = null) { // [DIUBAH]
            const card = buttonElement.closest('.book-list-card');
            if (!card) return;
            
            const memberListDiv = card.querySelector('.book-member-list');
            if (!memberListDiv) return;

            const isLoaded = memberListDiv.dataset.loaded === 'true';
            const isVisible = memberListDiv.classList.contains('visible');
            const openBooks = getOpenBooks(); // [BARU] Ambil status tersimpan

            if (!isVisible && !isLoaded) {
                // === KASUS 1: BELUM DIMUAT & TERTUTUP -> BUKA & MUAT DATA ===
                buttonElement.classList.add('active'); // Putar ikon
                memberListDiv.classList.add('visible'); // Tampilkan div (untuk spinner)
                
                // [BARU] Simpan state Buka ke localStorage
                if (!openBooks.includes(walletId)) {
                    openBooks.push(walletId);
                    saveOpenBooks(openBooks);
                }
                
                try {
                    // PANGGIL API DI SINI
                    const members = await fetchApi(`/wallets/${walletId}/members`);
                    memberListDiv.innerHTML = ''; // Hapus spinner
                    
                    if (!members || members.length === 0) {
                        memberListDiv.innerHTML = `<div class="member-item" style="border:none; color: var(--text-light); font-size: 14px;">Hanya Anda.</div>`;
                    } else {
                        // Jika ada anggota, tambahkan border di header
                        card.querySelector('.book-card-header').classList.add('with-members');
                        
                        members.forEach(member => {
                            const item = document.createElement('div');
                            item.className = 'member-item';
                            let avatarHtml = '';
                            if (member.avatar_url) {
                                avatarHtml = `<img src="${member.avatar_url}" alt="${member.full_name}">`;
                            } else {
                                avatarHtml = `<span>${member.full_name.charAt(0).toUpperCase()}</span>`;
                            }
                            const isOwner = member.role === 'OWNER';
                            const isMe = myUserId && member.id === myUserId;
                            const canDelete = (walletRole === 'OWNER' && !isOwner); 
                            const labelHtml = member.label ? `<div class="email" style="font-style: italic; color: var(--primary-blue);">${member.label}</div>` : '';

                            item.innerHTML = `
                                <div class="avatar">${avatarHtml}</div>
                                <div class="details">
                                    <div class="name">${member.full_name} ${isMe ? '(Anda)' : ''}</div>
                                    <div class="email">${member.email}</div>
                                    ${labelHtml} 
                                </div>
                                <div class="role-info">
                                    <span class="role-tag">${member.role}</span>
                                    <button class="delete-member-btn" ${!canDelete ? 'disabled' : ''} onclick="handleDeleteMember('${walletId}', '${member.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            memberListDiv.appendChild(item);
                        });
                    }
                    memberListDiv.dataset.loaded = 'true'; // Tandai sudah dimuat
                } catch (e) {
                    memberListDiv.querySelector('.member-list-loader').innerHTML = `<span style="color: var(--expense-red);">Gagal memuat anggota.</span>`;
                }

            } else {
                // === KASUS 2: SUDAH DIMUAT -> TINGGAL BUKA/TUTUP ===
                buttonElement.classList.toggle('active');
                const isNowVisible = memberListDiv.classList.toggle('visible'); // [BARU] Tangkap status baru
                
                // [BARU] Simpan state baru ke localStorage
                if (isNowVisible) {
                    // Baru saja dibuka
                    if (!openBooks.includes(walletId)) {
                        openBooks.push(walletId);
                    }
                } else {
                    // Baru saja ditutup
                    const index = openBooks.indexOf(walletId);
                    if (index > -1) {
                        openBooks.splice(index, 1);
                    }
                }
                saveOpenBooks(openBooks);
            }
        }

async function handleDeleteMember(walletId, userId) { 
            if (!userId || !walletId) return;

            const confirmed = await showDialog({
                title: 'Hapus Anggota',
                text: 'Anda yakin ingin menghapus anggota ini dari buku ini?',
                confirmText: 'Hapus',
                cancelText: 'Batal',
                isDestructive: true
            });
            if (!confirmed) return;

            // Gunakan pesan global di halaman
            const messageEl = document.getElementById('invite-message');
            messageEl.textContent = 'Menghapus...';
            messageEl.className = '';

            try {
                await fetchApi(`/wallets/${walletId}/members/${userId}`, {
                    method: 'DELETE'
                });

                messageEl.textContent = 'Anggota berhasil dihapus.';
                messageEl.className = 'success';

                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 3000);
                
                // [PENTING] Muat ulang HANYA daftar anggota buku itu
                const card = document.querySelector(`.book-action-btn.invite[onclick*="'${walletId}'"]`).closest('.book-list-card');
                if (card) {
                    const memberListDiv = card.querySelector('.book-member-list');
                    memberListDiv.dataset.loaded = 'false';
                    memberListDiv.innerHTML = `
                        <div class="member-list-loader" style="text-align: center; padding: 15px;">
                            <span class="inline-spinner" style="display: inline-block; border-color: var(--primary-blue); border-top-color: transparent;"></span>
                        </div>`;
                    const collabsBtn = card.querySelector('.book-action-btn.collabs');
                    
                    // Kita panggil ulang toggleMemberList
                    // Kita bisa kirim 'null' untuk myUser.id karena itu hanya untuk menampilkan label '(Anda)'
                    // yang tidak kritis saat me-refresh list.
                    if (collabsBtn.classList.contains('active')) {
                         toggleMemberList(collabsBtn, walletId, 'OWNER', null);
                    }
                }

            } catch (error) {
                messageEl.textContent = `Gagal menghapus: ${error.message}`;
                messageEl.className = 'error';
                
                // [BARU] Sembunyikan pesan error setelah 3 detik
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 3000);
            }

        }
        /**
         * [DIUBAH] Mengambil HANYA BUKU (bukan anggota)
         */
        async function loadAllWalletsAndMembers() {
            const listSection = document.getElementById('book-list-section');
            if (!listSection) return;

            listSection.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light);"><span class="inline-spinner" style="display: inline-block; border-color: var(--primary-blue); border-top-color: transparent;"></span><span style="margin-left: 10px;">Memuat daftar buku...</span></div>`;

            try {
                const myUser = await fetchApi('/auth/users/me'); // [DIKEMBALIKAN]
                const wallets = await fetchApi('/wallets');
                const openBooks = getOpenBooks();

                listSection.innerHTML = ''; // Bersihkan spinner

                if (!wallets || wallets.length === 0) {
                    listSection.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light);">Anda belum memiliki buku.</div>`;
                    return;
                }
                
                // Render daftar buku
                for (const wallet of wallets) {
                    const card = document.createElement('div');
                    card.className = 'book-list-card'; 

                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'book-card-header';
                    
                    const canInvite = (wallet.role === 'OWNER' || wallet.role === 'ADMIN');
                    
                    const inviteBtnHtml = canInvite 
                        ? `<button class="book-action-btn invite" title="Undang Anggota" onclick="openInviteModal('${wallet.id}', '${wallet.name}')"><i class="fas fa-user-plus"></i></button>`
                        : '';

                    // [PERBAIKAN 1 & 3] Onclick memanggil toggleMemberList BARU
                    const icon = wallet.icon || ''; // Ambil ikon, beri default 
                    const isInitiallyOpen = openBooks.includes(wallet.id);
                    
                    cardHeader.innerHTML = `
                        <div class="book-card-header-title">
                            <div class="book-icon-box">${icon}</div>
                            <h3 class="list-title">${wallet.name}</h3>
                        </div>
                        <div class="book-actions">
                            <button class="book-action-btn collabs ${isInitiallyOpen ? 'active' : ''}" title="Lihat Anggota" onclick="toggleMemberList(this, '${wallet.id}', '${wallet.role}', '${myUser.id}')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            ${inviteBtnHtml}
                            <button class="book-action-btn" title="Ubah Nama" onclick="openEditBookModal('${wallet.id}', '${wallet.name}', '${icon}')"><i class="fas fa-edit"></i></button>
                            <button class="book-action-btn delete" title="Hapus Buku" onclick="handleDeleteBook('${wallet.id}', '${wallet.role}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    
                    // [PERBAIKAN 1] Buat div member list KOSONG dengan loader
                    const memberListDiv = document.createElement('div');
                    memberListDiv.className = 'book-member-list'; // (hidden by default)
                    // Tambahkan spinner loader
                    memberListDiv.innerHTML = `
                        <div class="member-list-loader" style="text-align: center; padding: 15px;">
                            <span class="inline-spinner" style="display: inline-block; border-color: var(--primary-blue); border-top-color: transparent;"></span>
                        </div>`;

                    card.appendChild(cardHeader); 
                    card.appendChild(memberListDiv); // memberListDiv ditambahkan (hidden)
                    listSection.appendChild(card);
                }
                // [BARU] Loop kedua untuk memuat data buku yang disimpan terbuka
                // Kita lakukan ini setelah semua elemen ada di DOM
                const openBookCards = document.querySelectorAll('.book-action-btn.collabs.active');
                openBookCards.forEach(btn => {
                    // Ambil argumen dari onclick
                    const onclickAttr = btn.getAttribute('onclick');
                    // "toggleMemberList(this, 'walletId', 'walletRole', 'myUserId')"
                    const args = onclickAttr.match(/'([^']+)'/g).map(s => s.replace(/'/g, ''));
                    // args akan menjadi ['walletId', 'walletRole', 'myUserId']
                    
                    // Panggil fungsi secara manual untuk memuat data
                    toggleMemberList(btn, args[0], args[1], args[2]);
                });

            } catch (error) {
                listSection.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--expense-red);">Gagal memuat buku: ${error.message}</div>`;
            }
        }

        window.selectEditIcon = function(icon) {
            document.getElementById('edit-book-icon').value = icon;
        }

        window.selectWalletIcon = function(icon) {
            const input = document.getElementById('wallet-icon');
            if (input) {
                input.value = icon;
            }
        }
        
        /* [BARU] Helper untuk tombol emoji di modal Edit */
        window.selectEditIcon = function(icon) {
            document.getElementById('edit-book-icon').value = icon;
        }

        function openEditBookModal(walletId, currentName, currentIcon) {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (!modal) return;

            // Isi form dengan data yang ada
            document.getElementById('edit-book-id').value = walletId;
            document.getElementById('edit-book-name').value = currentName;
            document.getElementById('edit-book-icon').value = currentIcon || '';
            
            // Bersihkan pesan error/sukses
            document.getElementById('modal-edit-book-message').textContent = '';
            
            // Reset tombol submit
            const submitBtn = modal.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            
            const btnText = modal.querySelector('#edit-book-btn-text');
            if (btnText) btnText.style.display = 'inline';
            
            const spinner = modal.querySelector('#edit-book-spinner');
            if (spinner) spinner.classList.remove('active');

            modal.classList.add('visible');
        }

        /* [BARU] Fungsi untuk menutup modal Edit Buku */
        function closeEditBookModal() {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        /* [BARU] Fungsi untuk submit edit buku */
        async function handleModalEditSubmit(event) {
            event.preventDefault();
            const form = event.target;
            
            const walletId = document.getElementById('edit-book-id').value;
            const newName = document.getElementById('edit-book-name').value;
            const newIcon = document.getElementById('edit-book-icon').value || '';
            
            const messageEl = document.getElementById('modal-edit-book-message');
            const submitBtn = form.querySelector('button[type="submit"]'); // Tombolnya
            const btnText = document.getElementById('edit-book-btn-text'); // Teks di dalam tombol
            const btnSpinner = document.getElementById('edit-book-spinner'); // Spinner di dalam tombol

            if (!walletId || !newName) return;

            // Tampilkan loading (Spinner akan muncul karena CSS dari Langkah 1)
            submitBtn.disabled = true;
            if (btnText) btnText.style.display = 'none';
            if (btnSpinner) btnSpinner.classList.add('active'); 
            messageEl.textContent = '';
            messageEl.className = '';

            try {
                // Kirim data (nama DAN ikon) ke API
                await fetchApi(`/wallets/${walletId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        name: newName,
                        icon: newIcon 
                    }) 
                });

                // SUKSES:
                messageEl.textContent = 'Buku berhasil diperbarui.';
                messageEl.className = 'success';
                loadAllWalletsAndMembers(); // Muat ulang daftar di background
                
                // Biarkan spinner tetap berputar, lalu tutup modal
                setTimeout(() => {
                    closeEditBookModal();
                    
                    // Reset tombol SETELAH modal ditutup
                    submitBtn.disabled = false;
                    if (btnText) btnText.style.display = 'inline';
                    if (btnSpinner) btnSpinner.classList.remove('active');
                }, 1000); // Tutup setelah 1 detik

            } catch (error) {
                // GAGAL:
                messageEl.textContent = `Gagal memperbarui: ${error.message}`;
                messageEl.className = 'error';
                
                // Reset tombol jika gagal
                submitBtn.disabled = false;
                if (btnText) btnText.style.display = 'inline';
                if (btnSpinner) btnSpinner.classList.remove('active');
            }
        }

        async function handleDeleteBook(walletId, userRoleInWallet) {
            if (userRoleInWallet !== 'OWNER') {
                showDialog({ title: 'Aksi Ditolak', text: 'Hanya OWNER yang dapat menghapus buku.' });
                return;
            }
            
            const confirmed = await showDialog({
                title: 'Hapus Buku',
                text: 'PERINGATAN: Anda akan menghapus buku ini.\nSEMUA data transaksi, akun, dan anggota di dalamnya akan hilang selamanya.\n\nApakah Anda yakin?',
                confirmText: 'Ya, Hapus',
                cancelText: 'Batal',
                isDestructive: true
            });
            if (!confirmed) return;

            const messageEl = document.getElementById('invite-message');
            messageEl.textContent = 'Menghapus buku...';
            messageEl.className = '';

            try {
                await fetchApi(`/wallets/${walletId}`, {
                    method: 'DELETE' 
                });

                // Cek apakah buku yang dihapus adalah buku yang sedang aktif
                if (localStorage.getItem('currentWalletId') === walletId) {
                    localStorage.removeItem('currentWalletId');
                    localStorage.removeItem('currentWalletName');
                    localStorage.removeItem('currentWalletIcon');
                }

                messageEl.textContent = 'Buku berhasil dihapus.';
                messageEl.className = 'success';
                loadAllWalletsAndMembers(); // Muat ulang daftar
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 3000);

            } catch (error) {
                messageEl.textContent = `Gagal menghapus buku: ${error.message}`;
                messageEl.className = 'error';

                // [BARU] Sembunyikan pesan error setelah 3 detik
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = '';
                }, 3000);
            }
        }
        /**
         * [DIUBAH] Menangani submit form undangan (versi MODAL)
         */
  async function handleModalInviteSubmit(event) {
            event.preventDefault();
            const form = event.target;
            
            const email = document.getElementById('invite-modal-email').value;
            const role = document.getElementById('invite-modal-role').value;
            const label = document.getElementById('invite-modal-label').value;
            const walletId = document.getElementById('invite-modal-wallet-id').value;
            
            const messageEl = document.getElementById('modal-invite-message');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('span:not(.loading-spinner)');
            const btnSpinner = submitBtn.querySelector('.loading-spinner');

            if (!walletId) {
                messageEl.textContent = 'ID Buku tidak ditemukan. Coba lagi.';
                messageEl.className = 'error';
                return;
            }

            // Tampilkan Loader
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            messageEl.textContent = '';
            messageEl.className = '';

            try {
                const result = await fetchApi(`/wallets/${walletId}/members`, {
                    method: 'POST',
                    body: JSON.stringify({ email, role, label }) 
                });

                messageEl.textContent = 'Berhasil mengundang!';
                messageEl.className = 'success';
                form.reset(); 
                
                // [PERBAIKAN KUNCI] Muat ulang daftar anggota
                const card = document.querySelector(`.book-action-btn.invite[onclick*="'${walletId}'"]`).closest('.book-list-card');
                if (card) {
                    const memberListDiv = card.querySelector('.book-member-list');
                    memberListDiv.dataset.loaded = 'false';
                    memberListDiv.innerHTML = `
                        <div class="member-list-loader" style="text-align: center; padding: 15px;">
                            <span class="inline-spinner" style="display: inline-block; border-color: var(--primary-blue); border-top-color: transparent;"></span>
                        </div>`;
                    const collabsBtn = card.querySelector('.book-action-btn.collabs');
                    // [INI PERBAIKANNYA] Kirim 'null' karena myUser tidak ada di sini
                    toggleMemberList(collabsBtn, walletId, 'OWNER', null); 
                }
                
                // [PERBAIKAN] Tutup modal lebih cepat (1 detik)
                setTimeout(() => {
                    closeInviteModal();
                    // Reset tombol SETELAH modal ditutup
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                }, 1000); // Tutup setelah 1 detik

            } catch (error) {
                messageEl.textContent = error.message; 
                messageEl.className = 'error';
                // Reset tombol jika error
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        }
        /**
         * [DIUBAH] Inisialisasi Halaman Buku
         */
        function initBooksPage() {
            console.log("Halaman Buku (Global) diinisialisasi.");

            // Muat semua buku (TANPA anggota)
            loadAllWalletsAndMembers();

            // [PERBAIKAN KUNCI] Pasang listener ke form MODAL
            const inviteForm = document.getElementById('modal-invite-form');
            if (inviteForm) {
                // Hapus listener lama jika ada (untuk mencegah duplikat)
                inviteForm.removeEventListener('submit', handleModalInviteSubmit);
                // Tambahkan listener baru
                inviteForm.addEventListener('submit', handleModalInviteSubmit);
            }

            // [BARU] Pasang listener ke form MODAL EDIT
            const editForm = document.getElementById('modal-edit-book-form');
            if (editForm) {
                editForm.removeEventListener('submit', handleModalEditSubmit);
                editForm.addEventListener('submit', handleModalEditSubmit);
            }
        }
        
        /* [BARU] Helper untuk tombol emoji di modal Edit */
        window.selectEditIcon = function(icon) {
            document.getElementById('edit-book-icon').value = icon;
        }

        /* [BARU] Fungsi untuk membuka modal Edit Buku */
        function openEditBookModal(walletId, currentName, currentIcon) {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (!modal) return;

            // Isi form dengan data yang ada
            document.getElementById('edit-book-id').value = walletId;
            document.getElementById('edit-book-name').value = currentName;
            document.getElementById('edit-book-icon').value = currentIcon || '';
            
            // Bersihkan pesan error/sukses
            document.getElementById('modal-edit-book-message').textContent = '';
            
            // Reset tombol submit
            const submitBtn = modal.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            
            const btnText = modal.querySelector('#edit-book-btn-text');
            if (btnText) btnText.style.display = 'inline';
            
            const spinner = modal.querySelector('#edit-book-spinner');
            if (spinner) spinner.classList.remove('active'); // Pastikan spinner 'active' bukan 'display: none'

            modal.classList.add('visible');
        }

        /* [BARU] Fungsi untuk menutup modal Edit Buku */
        function closeEditBookModal() {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

/* [GANTI FUNGSI INI] Fungsi untuk submit edit buku */
        async function handleModalEditSubmit(event) {
            event.preventDefault();
            const form = event.target;
            
            const walletId = document.getElementById('edit-book-id').value;
            const newName = document.getElementById('edit-book-name').value;
            const newIcon = document.getElementById('edit-book-icon').value || '';
            
            const messageEl = document.getElementById('modal-edit-book-message');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = document.getElementById('edit-book-btn-text');
            const btnSpinner = document.getElementById('edit-book-spinner');

            if (!walletId || !newName) return;

            // Tampilkan loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            if (btnSpinner) btnSpinner.classList.add('active'); // Tampilkan spinner
            messageEl.textContent = '';
            messageEl.className = '';

            try {
                // Kirim data (nama DAN ikon) ke API
                await fetchApi(`/wallets/${walletId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        name: newName,
                        icon: newIcon 
                    }) 
                });

                // SUKSES:
                messageEl.textContent = 'Buku berhasil diperbarui.';
                messageEl.className = 'success';
                loadAllWalletsAndMembers(); // Muat ulang daftar di background
                
                // Biarkan spinner tetap berputar, lalu tutup modal & reset tombol
                setTimeout(() => {
                    closeEditBookModal();
                    
                    // Reset tombol SETELAH modal ditutup
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    if (btnSpinner) btnSpinner.classList.remove('active');
                }, 1000); // Tutup setelah 1 detik

            } catch (error) {
                // GAGAL:
                messageEl.textContent = `Gagal memperbarui: ${error.message}`;
                messageEl.className = 'error';
                
                // Reset tombol jika gagal
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                if (btnSpinner) btnSpinner.classList.remove('active');
            }
        }
        /* [BARU] Helper untuk tombol emoji di modal Edit */
        window.selectEditIcon = function(icon) {
            document.getElementById('edit-book-icon').value = icon;
        }

        /* [BARU] Fungsi untuk membuka modal Edit Buku */
        function openEditBookModal(walletId, currentName, currentIcon) {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (!modal) return;

            // Isi form dengan data yang ada
            document.getElementById('edit-book-id').value = walletId;
            document.getElementById('edit-book-name').value = currentName;
            document.getElementById('edit-book-icon').value = currentIcon || '';
            
            // Bersihkan pesan error/sukses
            document.getElementById('modal-edit-book-message').textContent = '';
            
            // Reset tombol submit
            const submitBtn = modal.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            modal.querySelector('#edit-book-btn-text').style.display = 'inline';
            modal.querySelector('#edit-book-spinner').classList.remove('active');

            modal.classList.add('visible');
        }

        /* [BARU] Fungsi untuk menutup modal Edit Buku */
        function closeEditBookModal() {
            const modal = document.getElementById('edit-book-modal-overlay');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        /* [BARU] Fungsi untuk submit edit buku (pengganti handleRenameBook) */
        async function handleModalEditSubmit(event) {
            event.preventDefault();
            const form = event.target;
            
            const walletId = document.getElementById('edit-book-id').value;
            const newName = document.getElementById('edit-book-name').value;
            const newIcon = document.getElementById('edit-book-icon').value || '';
            
            const messageEl = document.getElementById('modal-edit-book-message');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = document.getElementById('edit-book-btn-text');
            const btnSpinner = document.getElementById('edit-book-spinner');

            if (!walletId || !newName) return;

            // Tampilkan loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.classList.add('active');
            messageEl.textContent = '';
            messageEl.className = '';

            try {
                // Kirim data (nama DAN ikon) ke API
                await fetchApi(`/wallets/${walletId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        name: newName,
                        icon: newIcon // Kirim ikon yang baru
                    }) 
                });

                messageEl.textContent = 'Buku berhasil diperbarui.';
                messageEl.className = 'success';
                loadAllWalletsAndMembers(); // Muat ulang daftar buku di belakang
                
                // [PERBAIKAN 1] Reset tombol agar tidak "blank"
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                if (btnSpinner) btnSpinner.classList.remove('active');
                
                // [PERBAIKAN 2] Tutup modal lebih cepat (0.75 detik)
                setTimeout(closeEditBookModal, 750); 

            } catch (error) {
                messageEl.textContent = `Gagal memperbarui: ${error.message}`;
                messageEl.className = 'error';
                // Reset tombol jika gagal
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                if (btnSpinner) btnSpinner.classList.remove('active');
            }
        }

        // [BARU] Fungsi inisialisasi untuk create-wallet.html
        function initCreateWalletPage() {
            console.log("Halaman Create Wallet diinisialisasi.");
            const form = document.getElementById('create-wallet-form');
            if (!form) return; // Keluar jika form tidak ditemukan

            const errorContainer = document.getElementById('error-container');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('button-text');
            
            // 'fetchApi' sudah global, jadi kita bisa langsung pakai
            // 'token' dan 'apiUrl' tidak perlu dideklarasi ulang, sudah di handle 'fetchApi'

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const walletName = document.getElementById('wallet-name').value;
                const walletIcon = document.getElementById('wallet-icon').value || ''; // [BARU] Ambil nilai ikon
                const moduleType = document.getElementById('module-type').value;

                // Tampilkan loading
                if (errorContainer) errorContainer.classList.add('hidden');
                if (spinner) spinner.classList.add('active');
                if (buttonText) buttonText.style.display = 'none'; // Sembunyikan teks
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;

                try {
                    // Gunakan fetchApi global
                    const newWallet = await fetchApi('/wallets', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: walletName,
                            icon: walletIcon, // [PERBAIKAN] Kirim ikon ke API
                            moduleType: moduleType
                        })
                    });

                    // Sukses! Arahkan ke halaman /books
                    navigate('/books'); 

                } catch (error) {
                    // [DIUBAH] Gunakan dialog, bukan error-container
                    showDialog({ title: 'Gagal Membuat Buku', text: error.message });
                    if (errorContainer) errorContainer.classList.add('hidden'); // Sembunyikan lagi
                    // Reset tombol
                    if (spinner) spinner.classList.remove('active');
                    if (buttonText) {
                        buttonText.style.display = 'inline';
                        buttonText.textContent = 'Buat Buku';
                    }
                    if (submitBtn) submitBtn.disabled = false;
                }
            };
            
            form.addEventListener('submit', handleSubmit);
        }
// === [AKHIR FUNGSI-FUNGSI BARU] ===

/**
 * [DIUBAH] Menangani submit form undangan (versi global)
 */
async function handleInviteMember(event) {
    event.preventDefault();
    const form = event.target;
    const email = document.getElementById('invite-email').value;
    const role = document.getElementById('invite-role').value;
    const label = document.getElementById('invite-label').value;
    const walletId = document.getElementById('invite-wallet').value; // <-- [BARU]
    const messageEl = document.getElementById('invite-message');
    const submitBtn = form.querySelector('button[type="submit"]');

    if (!walletId) {
        messageEl.textContent = 'Silakan pilih buku terlebih dahulu.';
        messageEl.className = 'error';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Mengundang...';
    messageEl.textContent = '';
    messageEl.className = '';

    try {
        // [DIUBAH] walletId sekarang dinamis
        const result = await fetchApi(`/wallets/${walletId}/members`, {
            method: 'POST',
            body: JSON.stringify({ email, role, label }) 
        });

        messageEl.textContent = 'Berhasil mengundang!';
        messageEl.className = 'success';
        form.reset(); 
        loadAllWalletsAndMembers(); // Muat ulang seluruh daftar

    } catch (error) {
        messageEl.textContent = error.message; // Tampilkan error (misal: "User not found")
        messageEl.className = 'error';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Undangan';
    }
}

/**
 * [DIUBAH] Inisialisasi Halaman Buku
 */
function initBooksPage() {
            console.log("Halaman Buku (Global) diinisialisasi.");

            // Muat semua buku (TANPA anggota)
            loadAllWalletsAndMembers(); // <-- Panggil fungsi yang benar

            // [PERBAIKAN KUNCI] Pasang listener ke form MODAL
            const inviteForm = document.getElementById('modal-invite-form');
            if (inviteForm) {
                // Hapus listener lama jika ada (untuk mencegah duplikat)
                inviteForm.removeEventListener('submit', handleModalInviteSubmit);
                // Tambahkan listener baru
                inviteForm.addEventListener('submit', handleModalInviteSubmit);
            }

            // [BARU] Pasang listener ke form MODAL EDIT
            const editForm = document.getElementById('modal-edit-book-form');
            if (editForm) {
                editForm.removeEventListener('submit', handleModalEditSubmit);
                editForm.addEventListener('submit', handleModalEditSubmit);
            }
        }
// === [AKHIR FUNGSI-FUNGSI BARU] ===

        // === BAGIAN 3: LOGIKA SPA ROUTING (DENGAN PERBAIKAN) ===
        
        const pageContainer = document.getElementById('app-container');
        const isBlobEnvironment = window.location.protocol === 'blob:';

        function runPageInit(path) {
            if (path === '/') { initMainPage(); } 
            else if (path === '/wallet') { initWalletPage(); } 
            else if (path === '/create') { initCreatePage(); }
            else if (path === '/more') { initMorePage(); }
            else if (path === '/analysis') { initAnalysisPage(); }
            // [DIUBAH]
            else if (path === '/books') { initBooksPage(); } // <-- Ganti dari /member
            else if (path === '/create-wallet') { initCreateWalletPage(); }
        }

        function executePageScript(newContentElement) {
            const oldScript = document.getElementById('page-specific-script');
            if (oldScript) {
                oldScript.parentNode.removeChild(oldScript);
            }
            const scriptTemplate = newContentElement.querySelector('script[type="text/javascript-template"]');
            if (scriptTemplate) {
                try {
                    const newScript = document.createElement('script');
                    newScript.id = 'page-specific-script';
                    newScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(newScript);
                } catch (e) {
                    console.error("Error executing page script:", e);
                }
            }
        }
        
        async function navigate(path) {
            if (isBlobEnvironment) { 
                const targetUrl = new URL(path, window.location.origin);
                window.location.href = targetUrl.href;
                return; 
            }
            
            if (!pageContainer) return;
            try {
                const response = await fetch(path, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) { window.location.href = path; return; }
                const newContent = await response.text();
                
                history.pushState({ path }, '', path);
                pageContainer.innerHTML = newContent;
                executePageScript(pageContainer);
                // [PERBAIKAN] Beri browser waktu untuk me-render HTML baru
                setTimeout(() => runPageInit(path), 0); 

            } catch (error) {
                console.error("Gagal melakukan navigasi:", error);
                window.location.href = path;
            }
        }

        document.addEventListener('click', (event) => {
            const anchor = event.target.closest('a');
            if (anchor && anchor.href && new URL(anchor.href).origin === location.origin) {
                event.preventDefault();
                const path = new URL(anchor.href).pathname;
                if (path !== location.pathname) {
                    navigate(path);
                }
            }
        });

        window.addEventListener('popstate', (event) => {
            if (isBlobEnvironment) return; 
            if (event.state && event.state.path) {
                (async () => {
                    if (!pageContainer) return;
                    try {
                        const response = await fetch(event.state.path, { headers: { 'X-Requested-with': 'XMLHttpRequest' } });
                        if (!response.ok) { window.location.href = event.state.path; return; }
                        const newContent = await response.text();
                        pageContainer.innerHTML = newContent;
                        executePageScript(pageContainer);
                        // [PERBAIKAN] Beri browser waktu untuk me-render HTML baru
                        setTimeout(() => runPageInit(event.state.path), 0);
                    } catch (error) {
                         console.error("Gagal memuat state:", error);
                         window.location.href = event.state.path;
                    }
                })();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // [PERBAIKAN KUNCI] Pengecekan keamanan untuk session token
            const isAuthPage = window.location.pathname === '/login' || 
                               window.location.pathname === '/create-account' || 
                               window.location.pathname === '/two-step' ||
                               window.location.pathname === '/auth/callback';

            if (sessionToken && isAuthPage) {
                window.location.href = '/';
                return;
            }

            if (!sessionToken && !isAuthPage) {
                window.location.href = '/login';
                return;
            }
            document.getElementById('tx-modal-delete-btn')?.addEventListener('click', () => handleDeleteTransaction());
            document.getElementById('tx-modal-edit-btn')?.addEventListener('click', () => handleEditTransaction());

            if (!isBlobEnvironment) {
                history.replaceState({ path: location.pathname }, '', location.pathname);
            }
            
            applyTheme(getSettings().theme);
            applyMaskingState(getSettings().isBalanceMasked || false);
            executePageScript(pageContainer); 

            // [PERBAIKAN KUNCI]
            // Jika kita di halaman aplikasi (bukan login/register),
            // kita panggil 'initializeAppData' yang akan mengambil data
            // DAN BARU memanggil 'runPageInit' setelahnya.
            if (!isAuthPage) {
                initializeAppData(); // <-- PANGGIL FUNGSI BARU INI
            } else {
                runPageInit(location.pathname); // Halaman auth (login, dll) bisa langsung jalan
            }
        });</script>
</body>
</html>