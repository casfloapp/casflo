<!DOCTYPE html>
<!-- [PERBAIKAN] Tag <html> ditambahkan untuk mode gelap -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casflo</title>
    
    <!-- [PERBAIKAN KUNCI] Skrip CDN Tailwind HARUS dimuat SEBELUM skrip konfigurasi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind
        tailwind.config = {
            darkMode: 'class' // Memberitahu Tailwind untuk mencari class="dark" di <html>
        }; // <-- [PERBAIKAN KUNCI] TITIK KOMA DITAMBAHKAN DI SINI

        // Skrip ini harus ada di <head> untuk mencegah layar putih berkedip (flickering)
        // saat mode gelap aktif.
        (function() {
            const settingsKey = 'casflo';
            let theme = 'system';
            try {
                const settings = localStorage.getItem(settingsKey);
                if (settings) {
                    theme = JSON.parse(settings).theme || 'system';
                }
            } catch (e) {
                // Biarkan default 'system'
            }
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Global & Halaman Utama */
        :root {
            --primary-blue: #4A47A3;
            --light-purple: #E6E6FA;
            --text-dark: #333;
            --text-light: #888;
            --expense-red: #E84545;
            --income-green: #51CF66;
            --bg-gray: #f4f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html { height: -webkit-fill-available; }
        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            touch-action: manipulation; 
        }
        .app-container { 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        }

        /* [BARU] Aturan CSS untuk Mode Gelap */
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark .app-container {
            background-color: #111827; /* dark:bg-gray-800 */
        }
        .dark .card {
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            box-shadow: none;
        }
        .dark .main-content {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .dark .transaction-list, .dark .empty-transaction-list, .dark .category-list-card,
        .dark .account-list {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .transaction-item, .dark .account-item {
            border-bottom-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .overview-card .stat-item .label, .dark .transaction-item .info .account, 
        .dark .transaction-item .details .notes, .dark .account-section-header,
        .dark .account-item .balance-info .currency, .dark .filter-bar {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .overview-card .date-selector, .dark .header-title, .dark .header-top .left .fa-search {
            color: white;
        }
        .dark .calendar-card, .dark .calendar-summary-tabs .tab {
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .calendar-summary-tabs .tab.active {
            color: var(--primary-blue);
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .dark .bottom-nav {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border-top: 1px solid #374151;
        }
        .dark .nav-item {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .nav-item.active {
            color: #ffffff; /* Tetap biru agar menonjol */
        }
        .dark .fab {
            background-color: #374151;
            color: #ffffff;
            border: 1px solid #4b5563;
        }
        .dark .more-grid .grid-item {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-header, .dark .analysis-header, .dark .more-header {
             background: var(--primary-blue); /* Tetap biru */
             cursor: pointer;
        }
        .dark .account-list {
             background-color: #374151;
        }
        .dark .stats-container .amount, .dark .account-item .details, .dark .account-item .balance-info .amount {
            color: white;
        }
        .dark .stats-container .main-balance .amount {
             color: white;
        }
        .dark .account-item .balance-info .amount.expense,
        .dark .overview-card .stat-item .amount.expense {
            color: var(--expense-red);
        }
        .dark .donut-chart-card, .dark .category-list-card {
            background-color: #374151;
        }
        .dark .donut-chart-center .amount {
            color: white;
        }
        .dark .add-view-container {
            background-color: #1f2937;
        }
        .dark .add-header, .dark .categories-section {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .dark .type-selector-header {
            background: #1f2937;
        }
        .dark .type-btn-header {
            color: #9ca3af;
        }
        .dark .type-btn-header.active {
            background: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dark .type-btn-header.expense.active { color: var(--expense-red); }
        .dark .type-btn-header.income.active { color: var(--income-green); }
        .dark .calculator-section {
            background: #1f2937;
            border-top-color: #4b5563;
        }
        .dark .amount-display, .dark .action-btn, .dark .calc-btn {
            background: #374151;
            color: #d1d5db;
            box-shadow: none;
        }
        .dark .action-btn.personal {
            background: #111827;
        }
        .dark .calc-btn.operator {
            background: #ccc;
        }
        .dark .category-item:hover {
            background: #4b5563;
        }

        /* ... Sisa CSS Global Anda ... */
        .main-header { background: var(--primary-blue); color: white; padding: 20px 20px 20px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; flex-shrink: 0; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-top .left { display: flex; align-items: center; gap: 18px; }
        .view-toggle-group { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 4px; }
        .toggle-btn { background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 16px; display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .toggle-btn.active-view { background: rgba(255,255,255,0.2); }
        .toggle-btn span { display: inline-block; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out, margin-left 0.3s ease-in-out; max-width: 100px; opacity: 1; margin-left: 5px; overflow: hidden; }
        .toggle-btn:not(.active-view) span { max-width: 0; opacity: 0; margin-left: 0; }
        .toggle-btn:not(.active-view) { padding: 8px 10px; }
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .header-actions { display: flex; gap: 15px; }
        .action-box { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; flex: 1; }
        .action-box .icon { background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .action-box .text { font-size: 14px; }
        .main-content { flex: 1; overflow-y: auto; padding: 0 20px; position: relative; z-index: 5; padding-bottom: 100px; }
        .card { background: white; border-radius: 18px; margin-bottom: 20px; margin-top: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); padding: 18px; }
        .empty-transaction-list { text-align: center; color: #888; padding: 40px 0; }
        .view-hidden { display: none; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        
        /* PERBAIKAN: Tata letak untuk view Detail & Kalender disederhanakan */
        .view-hidden {
            display: none;
        }
        .overview-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overview-card .card-header .icon { width: 40px; height: 40px; background: var(--light-purple); color: var(--primary-blue); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .overview-card .date-selector { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .overview-card .date-selector i { cursor: pointer; }
        .overview-card .card-actions { display: flex; gap: 12px; }
        .overview-card .card-actions .icon { color: var(--text-light); }
        .overview-card .card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; padding-top: 5px; }
        .overview-card .stat-item .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .overview-card .stat-item .amount { font-size: 16px; font-weight: 700; }
        .overview-card .stat-item .amount.expense { color: var(--expense-red); }
        .calendar-card .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 600; }
        .calendar-card .calendar-header i { cursor: pointer; }
        .calendar-card .calendar-header .month-year { font-size: 16px; }
        .calendar-card .calendar-header .btn-month-toggle { background-color: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; }
        .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day { font-size: 14px; padding: 5px 0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; cursor: pointer; }
        .calendar-grid .day.weekend { color: var(--expense-red); }
        .calendar-grid .day.selected .date-number { background-color: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .calendar-grid .day .day-summary { font-size: 8px; color: white; background-color: var(--expense-red); border-radius: 5px; padding: 1px 3px; position: absolute; bottom: 0; }
        .calendar-summary-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid var(--bg-gray); padding-bottom: 20px; }
        .calendar-summary-tabs .tab { background: none; border: 1px solid #ddd; border-radius: 20px; padding: 6px 15px; font-size: 13px; color: var(--text-light); cursor: pointer; }
        .calendar-summary-tabs .tab.active { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-purple); }
        .calendar-summary-amounts { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .calendar-summary-amounts .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .calendar-summary-amounts .amount { font-size: 16px; font-weight: 700; }
        .calendar-summary-amounts .amount.expense { color: var(--expense-red); }
        .transaction-list .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .transaction-list .list-header .date-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .transaction-list .list-header .summary { font-size: 13px; color: var(--text-light); }
        .transaction-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid var(--bg-gray); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:first-of-type { padding-top: 5px; }
        .transaction-item .icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .category { font-weight: 600; font-size: 15px; }
        .transaction-item .details .notes { font-size: 12px; color: var(--text-light); }
        .transaction-item .info { text-align: right; }
        .transaction-item .info .amount { font-weight: 700; color: var(--expense-red); font-size: 15px; }
        .transaction-item .info .account { font-size: 12px; color: var(--text-light); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; color: var(--primary-blue); z-index: 15; text-decoration: none; }
        .fab i { font-size: 22px; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        .add-view { display: flex; flex-direction: column; height: 100svh;display: flex;
        flex-direction: column;
        height: 100vh;
        height: 100svh;
        background-color: white;
        max-width: 480px;
        margin: 0 auto;}
        .add-header { padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background-color: white; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .type-selector-header { display: flex; background: #f8f9fa; border-radius: 25px; padding: 3px; }
        .type-btn-header { padding: 8px 16px; border: none; background: transparent; border-radius: 22px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-light); }
        .type-btn-header.active { background: white; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .type-btn-header.expense.active { color: var(--expense-red); }
        .type-btn-header.income.active { color: var(--income-green); }
        .categories-section { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: white; min-height: 0; }
        .category-group { margin-bottom: 20px; }
        .group-title { font-size: 12px; color: var(--text-light); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .category-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; }
        .category-item:hover { background: #f8f9fa; }
        .category-item.selected { background: var(--primary-blue); color: white; }
        .category-item.selected .category-icon { background: rgba(255,255,255,0.2) !important; color: white !important; }
        .category-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 20px; }
        .category-name { font-size: 11px; text-align: center; }
        .calculator-section { background: #f8f9fa; padding: 15px; border-top: 1px solid #e9ecef; flex-shrink: 0; display: grid; grid-template-rows: repeat(6, 1fr); gap: 8px; }
        .amount-container { display: flex; gap: 8px; }
        .account-card { aspect-ratio: 1 / 1; height: 100%; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 102, 234, 0.3); }
        .account-card i { color: white; font-size: 24px; }
        .amount-display { flex-grow: 1; background: white; padding: 0 12px; border-radius: 10px; text-align: right; font-size: 28px; font-weight: 700; display: flex; align-items: center; justify-content: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 100%; }
        .top-action-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .action-btn { background: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 24px; }
        .action-btn.personal { background: #f8f9fa; color: #6c757d; }
        .action-btn.today { background: #e3f2fd; color: #1976d2; }
        .action-btn.add { background: var(--income-green); color: white; }
        .action-btn.check { background: var(--income-green); color: white; }
        .action-btn.equals { background: var(--primary-blue); color: white; }
        .calc-grid { grid-row: 3 / 7; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; grid-auto-rows: 1fr; }
        .calc-btn { background: white; border: none; border-radius: 10px; font-size: 24px; font-weight: 600; cursor: pointer; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .calc-btn .fas { font-size: 24px; }
        .calc-btn.operator { background: #f1f3f5; color: #495057; }
        .calc-btn.delete { background: #ffe3e3; color: var(--expense-red); }
        .wallet-header { background: white; padding: 20px; font-size: 18px; font-weight: 600; text-align: center;}
        .total-balance-card .label { font-size: 14px; color: var(--text-light); margin-bottom: 5px; text-align: center; }
        .total-balance-card .amount { font-size: 32px; font-weight: 700; text-align: center; color: var(--primary-blue); }
        .account-list-card .card-title { font-weight: 600; margin-bottom: 15px; }
        .wallet-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--bg-gray); }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item .icon-wrapper { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .wallet-item .details { flex-grow: 1; font-weight: 500; }
        .wallet-item .balance { font-weight: 600; }

        @media (min-width: 768px) {
            body { background-color: #e9ecef; }
            .app-container { max-width: 480px; margin: 0 auto; height: 100vh; }
            .add-view { max-width: 480px; }
            .calculator-section { padding: 20px; gap: 12px; }
            .amount-display { font-size: 36px; }
            .calc-btn, .action-btn { font-size: 28px; min-height: 50px; border-radius: 12px; }
            .calc-btn .fas { font-size: 28px; }
            .dark body { background-color: #111827; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        {{PAGE_CONTENT}}
    </div>

    <script>
        const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = '/login';
        }
        // === [BARU] BAGIAN 0: LOGIKA MODE GELAP/TERANG ===
        const settingsKey = 'casflo'; 
        const htmlEl = document.documentElement;

        function getSettings() {
            try {
                const settings = localStorage.getItem(settingsKey);
                // Default jika tidak ada settings: { theme: 'system' }
                return settings ? JSON.parse(settings) : { theme: 'system' };
            } catch (e) {
                return { theme: 'system' }; // Fallback jika JSON rusak
            }
        }

        function saveSettings(settingsObject) {
            try {
                // Ambil settings yang ada, lalu gabungkan dengan yang baru
                const existingSettings = getSettings();
                const newSettings = { ...existingSettings, ...settingsObject };
                localStorage.setItem(settingsKey, JSON.stringify(newSettings));
            } catch (e) {
                console.error("Gagal menyimpan settings:", e);
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else if (theme === 'light') {
                htmlEl.classList.remove('dark');
            } else {
                // Mode 'system' (default)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            }
        }

        // Terapkan tema segera saat skrip ini dimuat
        let currentSettings = getSettings();
        applyTheme(currentSettings.theme);
        
        // Fungsi ini dipanggil oleh init...Page()
        function attachThemeToggle(selector) {
            const themeToggleBtn = document.querySelector(selector);
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const isCurrentlyDark = htmlEl.classList.contains('dark');
                    const newTheme = isCurrentlyDark ? 'light' : 'dark';
                    applyTheme(newTheme); 
                    saveSettings({ theme: newTheme }); // Simpan pilihan baru
                });
            }
        }
        // --- [AKHIR BAGIAN 0] ---


        // === BAGIAN 1: VARIABEL & FUNGSI GLOBAL ===
        let currentDate = new Date();
        let selectedDate = new Date();
        let transactions = []; // Data dummy, ganti dengan API call
        let currentView = 'overview';
        let calendarFilter = 'expense';
        // Variabel global untuk 'create.html'
        let currentType = 'expense';
        let selectedCategory = null;
        let calcValue = '0';
        let waitingForEquals = false;

        const expenseCategories = [ { id: 1, name: 'Makanan', icon: 'ðŸ”', color: '#FEF3E2' }, { id: 2, name: 'Kebutuhan', icon: 'ðŸª´', color: '#E6F3F2' }, { id: 3, name: 'Transport', icon: 'ðŸš—', color: '#EBE9F9' }, { id: 4, name: 'Belanja', icon: 'ðŸ›ï¸', color: '#FCE8E7' }, { id: 5, name: 'Hiburan', icon: 'ðŸŽ®', color: '#D4EDDA' }, { id: 6, name: 'Kesehatan', icon: 'â¤ï¸', color: '#F8D7DA' }, { id: 7, name: 'Pendidikan', icon: 'ðŸŽ“', color: '#D1ECF1' }, { id: 8, name: 'Tagihan', icon: 'ðŸ§¾', color: '#FADBD8' }, { id: 9, name: 'Cicilan', icon: 'ðŸ ', color: '#D6EAF8' }, { id: 10, name: 'Listrik', icon: 'ðŸ’¡', color: '#FCF3CF' }, { id: 11, name: 'Air', icon: 'ðŸ’§', color: '#D4E6F1' }, { id: 12, name: 'Internet', icon: 'ðŸŒ', color: '#E8DAEF' }, { id: 13, name: 'Pakaian', icon: 'ðŸ‘•', color: '#D1F2EB' }, { id: 14, name: 'Langganan', icon: 'ðŸ”', color: '#FDEDEC' }, { id: 15, name: 'Hadiah', icon: 'ðŸŽ', color: '#FDEBD0' }, { id: 16, name: 'Donasi', icon: 'ðŸ’–', color: '#E6F3F2' }, { id: 17, name: 'Liburan', icon: 'âœˆï¸', color: '#EBE9F9' }, { id: 18, name: 'Anak', icon: 'ðŸ‘¶', color: '#FCE8E7' }, { id: 19, name: 'Pajak', icon: 'ðŸ›ï¸', color: '#D5DBDB' }, { id: 20, name: 'Asuransi', icon: 'ðŸ›¡ï¸', color: '#D6EAF8' }, { id: 21, name: 'Olahraga', icon: 'âš½ï¸', color: '#D4EDDA' }, { id: 22, name: 'Peliharaan', icon: 'ðŸ¾', color: '#FEF3E2' }, { id: 23, name: 'Perawatan', icon: 'ðŸ’…', color: '#F8D7DA' }, { id: 24, name: 'Perabotan', icon: 'ðŸ›‹ï¸', color: '#FDEBD0' }, { id: 25, name: 'Bensin', icon: 'â›½ï¸', color: '#FADBD8' }, { id: 26, name: 'Lainnya', icon: '...', color: '#F8F9FA' } ];
        const incomeCategories = [ { id: 101, name: 'Gaji', icon: 'ðŸ’°', color: '#D4EDDA' }, { id: 102, name: 'Bonus', icon: 'ðŸ†', color: '#D1ECF1' }, { id: 103, name: 'Investasi', icon: 'ðŸ“ˆ', color: '#E2E3E5' }, { id: 104, name: 'Freelance', icon: 'ðŸ’»', color: '#FCF3CF' }, { id: 105, name: 'Hadiah', icon: 'ðŸŽ', color: '#FDEBD0' }, { id: 106, name: 'Penjualan', icon: 'ðŸ·ï¸', color: '#E8DAEF' }, { id: 107, name: 'Sewa', icon: 'ðŸ”‘', color: '#D6EAF8' }, { id: 108, name: 'Lainnya', icon: '...', color: '#F8F9FA' } ];
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        function appendToCalc(value) { const operators = ['+', '-', '*', '/']; if (operators.includes(value)) { waitingForEquals = true; changeButtonToEquals(); } if (calcValue === '0' && !operators.includes(value)) calcValue = value; else { const lastChar = calcValue.slice(-1); if (operators.includes(lastChar) && operators.includes(value)) calcValue = calcValue.slice(0, -1) + value; else calcValue += value; } updateDisplay(); }
        function deleteLast() { calcValue = calcValue.slice(0, -1) || '0'; checkWaitingForEquals(); updateDisplay(); }
        function handleActionClick() { if (waitingForEquals) calculateResult(); else saveTransaction(); }
        function selectType(type) { currentType = type; document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active')); document.getElementById(type + 'Btn').classList.add('active'); selectedCategory = null; loadCategories(); }
        function updateDisplay() { const amountDisplay = document.getElementById('amountDisplay'); if(amountDisplay) amountDisplay.textContent = calcValue.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function checkWaitingForEquals() { const hasOperator = ['+', '-', '*', '/'].some(op => calcValue.includes(op)); if (!hasOperator) { waitingForEquals = false; changeButtonToCheck(); } }
        function changeButtonToEquals() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn equals'; actionBtn.innerHTML = '<i class="fas fa-equals"></i>'; }}
        function changeButtonToCheck() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn check'; actionBtn.innerHTML = '<i class="fas fa-check"></i>'; }}
        function calculateResult() { try { let expression = calcValue.replace(/Ã—/g, '*').replace(/Ã·/g, '/'); const result = eval(expression); calcValue = String(result); waitingForEquals = false; changeButtonToCheck(); updateDisplay(); } catch (e) { calcValue = '0'; updateDisplay(); } }
        function clearCalc() { calcValue = '0'; waitingForEquals = false; changeButtonToCheck(); updateDisplay(); }
        function loadCategories() { const categories = currentType === 'expense' ? expenseCategories : incomeCategories; const recommendedGrid = document.getElementById('recommendedGrid'); const uncategorizedGrid = document.getElementById('uncategorizedGrid'); if(!recommendedGrid || !uncategorizedGrid) return; recommendedGrid.innerHTML = ''; uncategorizedGrid.innerHTML = ''; categories.slice(0, 4).forEach(cat => recommendedGrid.appendChild(createCategoryElement(cat))); categories.slice(4).forEach(cat => uncategorizedGrid.appendChild(createCategoryElement(cat))); }
        function createCategoryElement(category) { const div = document.createElement('div'); div.className = 'category-item'; div.onclick = () => selectCategory(category, div); div.innerHTML = `<div class="category-icon" style="background: ${category.color}">${category.icon}</div><div class="category-name">${category.name}</div>`; return div; }
        function selectCategory(category, element) { selectedCategory = category; document.querySelectorAll('.category-item').forEach(item => item.classList.remove('selected')); element.classList.add('selected'); }
        async function saveTransaction() {
            try {
                const amount = parseFloat(calcValue); 
                if (isNaN(amount) || amount <= 0) {
                    alert('Masukkan jumlah yang valid'); // Ganti dengan modal custom
                    return;
                }
                if (!selectedCategory) {
                    alert('Pilih kategori terlebih dahulu'); // Ganti dengan modal custom
                    return;
                }

                // 1. Dapatkan Token & Data Penting dari localStorage
                //    (Kita asumsikan data ini disimpan setelah login/saat memilih dompet)
                const token = localStorage.getItem('sessionToken');
                
                // [PENTING] Anda perlu cara untuk menyimpan dan mengambil walletId dan accountId yang sedang aktif
                // Untuk contoh ini, kita asumsikan ID-nya di-hardcode atau diambil dari localStorage
                const walletId = localStorage.getItem('currentWalletId'); // GANTI INI: Anda harus implementasikan logika untuk ini
                const accountId = localStorage.getItem('selectedAccountId'); // GANTI INI: Anda harus implementasikan logika untuk ini

                if (!token) {
                    alert('Sesi tidak ditemukan. Silakan login ulang.');
                    navigate('/login');
                    return;
                }
                if (!walletId || !accountId) {
                    alert('Dompet atau akun aktif tidak ditemukan. Silakan muat ulang.');
                    // Di aplikasi nyata, Anda akan mengambil data ini dari API terlebih dahulu
                    // Untuk sementara, kita bisa hentikan di sini
                    console.error("currentWalletId atau selectedAccountId tidak ditemukan di localStorage.");
                    return; 
                }

                // 2. Siapkan Payload (Body) sesuai spesifikasi API Anda
                // Endpoint mengharapkan format YYYY-MM-DD untuk tanggal
                const transactionDate = new Date().toISOString().split('T')[0]; 
                
                const payload = {
                    wallet_id: walletId,
                    type: currentType.toUpperCase(), // API mengharapkan 'EXPENSE' atau 'INCOME'
                    amount: amount, // API Anda di 'queries.js' sudah menangani konversi ke sen
                    category_id: selectedCategory.id,
                    description: selectedCategory.name, // Anda bisa tambahkan input deskripsi terpisah nanti
                    transaction_date: transactionDate,
                };

                // API 'queries.js' Anda mengharapkan 'from_account_id' atau 'to_account_id'
                if (currentType === 'expense') {
                    payload.from_account_id = accountId;
                } else {
                    payload.to_account_id = accountId;
                }

                // (Opsional) Tampilkan loading state di tombol
                changeButtonToLoading(true); // Anda perlu membuat fungsi ini

                // 3. Kirim data ke API
                const response = await fetch(`https://api.casflo.id/api/v1/wallets/${walletId}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // [WAJIB] Kirim token otentikasi
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'Gagal menyimpan transaksi');
                }

                // 4. Sukses!
                console.log('Transaksi berhasil disimpan:', result.data);
                
                // Reset kalkulator & navigasi kembali ke halaman utama
                clearCalc(); 
                navigate('/'); 

            } catch (error) {
                console.error('Error saving transaction:', error);
                alert(`Terjadi kesalahan: ${error.message}`); // Tampilkan error ke user
            } finally {
                // (Opsional) Hilangkan loading state
                changeButtonToLoading(false); // Anda perlu membuat fungsi ini
            }
        }
        
        // (Opsional) Fungsi helper untuk loading state
        function changeButtonToLoading(isLoading) {
            const actionBtn = document.getElementById('actionBtn');
            if (!actionBtn) return;
            
            if (isLoading) {
                actionBtn.disabled = true;
                actionBtn.innerHTML = '<span class="loading-spinner-tombol"></span>'; // Anda perlu CSS untuk .loading-spinner-tombol
            } else {
                actionBtn.disabled = false;
                // Kembalikan ke tombol 'check' atau 'equals'
                checkWaitingForEquals(); 
            }
        }
        // --- [PERBAIKAN KALENDER] Fungsi Halaman Utama ---
        function setView(viewName) {
            currentView = viewName;
            localStorage.setItem('preferredView', viewName);
            const overviewCard = document.getElementById('overviewCard');
            const calendarCard = document.getElementById('calendarCard');
            const detailToggleBtn = document.getElementById('detailToggleBtn');
            const calendarToggleBtn = document.getElementById('calendarToggleBtn');

            if (detailToggleBtn) detailToggleBtn.classList.toggle('active-view', viewName === 'overview');
            if (calendarToggleBtn) calendarToggleBtn.classList.toggle('active-view', viewName === 'calendar');

            if (viewName === 'overview') {
                if (overviewCard) overviewCard.classList.remove('view-hidden');
                if (calendarCard) calendarCard.classList.add('view-hidden');
            } else {
                if (overviewCard) overviewCard.classList.add('view-hidden');
                if (calendarCard) calendarCard.classList.remove('view-hidden');
                renderCalendar(); 
            }
        }
        function updateMonthDisplay() { 
            const display = document.getElementById('currentMonthDisplay');
            const calendarDisplay = document.getElementById('calendarMonthYear');
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            if (display) {
                display.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;
            }
            if (calendarDisplay) {
                 calendarDisplay.textContent = `${monthNames[month]} ${year}`;
            }
            updateMainView(); 
        }
        function goToPrevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function goToNextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function setCalendarFilter(filter) { 
            calendarFilter = filter;
            if (document.getElementById('tabPengeluaran')) document.getElementById('tabPengeluaran').classList.toggle('active', filter === 'expense');
            if (document.getElementById('tabPenghasilan')) document.getElementById('tabPenghasilan').classList.toggle('active', filter === 'income');
            if (document.getElementById('tabTotal')) document.getElementById('tabTotal').classList.toggle('active', filter === 'total');
            renderCalendar();
        }
        function renderCalendar() { 
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            console.log("Merender kalender...");
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const date = new Date(year, month, i);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                dayEl.innerHTML = `<span class="date-number">${i}</span>`;
                
                let dailyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getDate() === i && tDate.getMonth() === month && tDate.getFullYear() === year;
                });
                if (calendarFilter === 'expense') { dailyTransactions = dailyTransactions.filter(t => t.type === 'expense'); } 
                else if (calendarFilter === 'income') { dailyTransactions = dailyTransactions.filter(t => t.type === 'income'); }
                
                const dailyTotal = dailyTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? -t.amount : t.amount), 0);
                
                if(dailyTotal !== 0){ 
                    const summaryEl = document.createElement('span'); 
                    summaryEl.className = 'day-summary'; 
                    summaryEl.style.backgroundColor = dailyTotal < 0 ? 'var(--expense-red)' : 'var(--income-green)'; 
                    if (calendarFilter === 'total' && dailyTotal > 0) summaryEl.style.backgroundColor = 'var(--income-green)'; 
                    summaryEl.textContent = `${dailyTotal < 0 ? '-' : ''}${Math.abs(dailyTotal/1000).toFixed(0)}k`; 
                    dayEl.appendChild(summaryEl); 
                }
                calendarGrid.appendChild(dayEl);
            }
        }
         function renderTransactionList(filteredTransactions) { 
            const transactionListEl = document.querySelector('.transaction-list');
            if (!transactionListEl) return;
            transactionListEl.innerHTML = '';
            
            // [PERBAIKAN] Mengelompokkan transaksi berdasarkan tanggal
            const grouped = filteredTransactions.reduce((acc, tx) => {
                const dateKey = new Date(tx.date).toDateString();
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(tx);
                return acc;
            }, {});

            if (Object.keys(grouped).length === 0) {
                transactionListEl.innerHTML = `<div class="empty-transaction-list">Belum ada transaksi di bulan ini</div>`;
                return;
            }

            // Urutkan grup tanggal
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            for (const dateKey of sortedDates) {
                const txsOnThisDate = grouped[dateKey];
                const date = new Date(dateKey);
                const totalExpense = txsOnThisDate
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const listHeader = document.createElement('div');
                listHeader.className = 'list-header';
                listHeader.innerHTML = `<div class="date-info"><i class="fas fa-chevron-down fa-xs"></i><span>${date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: '2-digit' })}</span></div><div class="summary">Pengeluaran: Rp${totalExpense.toLocaleString('id-ID')}</div>`;
                transactionListEl.appendChild(listHeader);

                txsOnThisDate.forEach(t => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    itemEl.innerHTML = `
                        <div class="icon" style="background-color: ${t.color};"><span>${t.icon}</span></div>
                        <div class="details"><div class="category">${t.category}</div><div class="notes">${t.notes}</div></div>
                        <div class="info">
                            <div class="amount" style="color: ${t.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)'}">
                                ${t.type === 'expense' ? '-' : ''}Rp${t.amount.toLocaleString('id-ID')}
                            </div>
                            <div class="account">${t.account}</div>
                        </div>`;
                    transactionListEl.appendChild(itemEl);
                });
            }
        }
        function updateMainView() { 
            console.log("Memuat data untuk", currentDate.toISOString().slice(0, 7));
            
            const filteredTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === currentDate.getMonth() && tDate.getFullYear() === currentDate.getFullYear();
            });

            const income = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const total = income - expense;
            const formatCurrency = (value) => { const sign = value < 0 ? '-' : ''; return `${sign}Rp${Math.abs(value).toLocaleString('id-ID')}`; };
            
            if(document.getElementById('totalAmount')) document.getElementById('totalAmount').textContent = formatCurrency(total);
            if(document.getElementById('incomeAmount')) document.getElementById('incomeAmount').textContent = formatCurrency(income);
            if(document.getElementById('expenseAmount')) document.getElementById('expenseAmount').textContent = formatCurrency(expense);
            if(document.getElementById('calendarTotalAmount')) document.getElementById('calendarTotalAmount').textContent = formatCurrency(total);
            if(document.getElementById('calendarIncomeAmount')) document.getElementById('calendarIncomeAmount').textContent = formatCurrency(income);
            if(document.getElementById('calendarExpenseAmount')) document.getElementById('calendarExpenseAmount').textContent = formatCurrency(expense);
            
            renderTransactionList(filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)));
            if(currentView === 'calendar') renderCalendar();
        }
        // --- [AKHIR PERBAIKAN KALENDER] ---


        // === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        
        function initMainPage() {
            console.log("Halaman Utama diinisialisasi.");
            document.getElementById('detailToggleBtn')?.addEventListener('click', () => setView('overview'));
            document.getElementById('calendarToggleBtn')?.addEventListener('click', () => setView('calendar'));
            document.getElementById('prevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('nextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('calendarPrevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('calendarNextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('tabPengeluaran')?.addEventListener('click', () => setCalendarFilter('expense'));
            document.getElementById('tabPenghasilan')?.addEventListener('click', () => setCalendarFilter('income'));
            document.getElementById('tabTotal')?.addEventListener('click', () => setCalendarFilter('total'));
            
            const savedView = localStorage.getItem('preferredView');
            if (document.getElementById('detailToggleBtn')) { 
                 setView(savedView || 'overview');
            }
            if (document.getElementById('currentMonthDisplay')) {
                updateMonthDisplay();
            }
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle'); 
        }
        
        function initCreatePage() {
            currentType = 'expense';
            selectedCategory = null;
            clearCalc();
            loadCategories();
            console.log("Halaman Create dimuat.");
        }

        function initWalletPage() { 
            console.log("Halaman dompet dimuat."); 
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }
        
        function initAnalysisPage() {
            console.log("Halaman Analisis dimuat.");

            const activePill = document.querySelector('.header-tabs .active-pill');
            const tabButtons = document.querySelectorAll('.header-tabs .tab-button');
            if (!activePill || !tabButtons.length) return;

            function movePill(targetButton) {
                requestAnimationFrame(() => {
                    if (targetButton) {
                        activePill.style.width = `${targetButton.offsetWidth}px`;
                        activePill.style.left = `${targetButton.offsetLeft}px`;
                    }
                });
            }

            function handleTabClick(event) {
                const clickedButton = event.currentTarget;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                movePill(clickedButton);

                const mode = clickedButton.dataset.mode;
                if (mode === 'pengeluaran') {
                    animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)');
                } else if (mode === 'penghasilan') {
                    animateChart(85, 850000000, 'Penghasilan', 'var(--income-green)');
                } else {
                    animateChart(0, 0, mode.charAt(0).toUpperCase() + mode.slice(1), '#ccc');
                }
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            // [PERBAIKAN KUNCI] Beri jeda sesaat sebelum menghitung posisi awal.
            // Ini memberi waktu bagi browser untuk menyelesaikan render animasi CSS.
            const initialActiveTab = document.querySelector('.header-tabs .tab-button.active');
            if (initialActiveTab) {
                setTimeout(() => {
                    movePill(initialActiveTab);
                }, 50); // Jeda 50 milidetik biasanya sudah cukup.
            }
            
            // Menambahkan listener untuk memperbaiki posisi saat layar dirotasi
            window.addEventListener('resize', () => {
                const currentActiveTab = document.querySelector('.header-tabs .tab-button.active');
                if (currentActiveTab) {
                    movePill(currentActiveTab);
                }
            });
            
                        function animateChart(percentage, totalAmount, label, color) {
                const segment = document.getElementById('chart-segment');
                const amountEl = document.getElementById('chart-total-amount');
                const labelEl = document.getElementById('chart-center-label');
                if (!segment || !amountEl || !labelEl) return;
                labelEl.textContent = label;
                segment.style.stroke = color;
                const radius = segment.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                segment.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (percentage / 100) * circumference;
                segment.style.strokeDashoffset = offset;
                let currentAmount = 0;
                const steps = 100;
                const increment = totalAmount / steps;
                if(window.chartCounter) clearInterval(window.chartCounter);
                window.chartCounter = setInterval(() => {
                    currentAmount += increment;
                    if (currentAmount >= totalAmount) {
                        currentAmount = totalAmount;
                        clearInterval(window.chartCounter);
                    }
                    amountEl.textContent = 'Rp' + Math.floor(currentAmount).toLocaleString('id-ID');
                }, 10);
            }


            setTimeout(() => {
                animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)'); 
            }, 100);
        }

        function initMorePage() {
            currentType = 'expense';
            selectedCategory = null;
            clearCalc();
            loadCategories();
            console.log("Halaman More dimuat.");

             const logoutButton = document.getElementById('logout-btn');
        
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    console.log("Tombol Logout diklik.");
                    
                    // Tampilkan konfirmasi sederhana
                    // NOTE: confirm() mungkin tidak berfungsi di beberapa lingkungan 'blob'
                    // Jika ini tidak muncul, kita harus membuat modal custom
                    if (confirm("Apakah Anda yakin ingin logout?")) {
                        // 1. Hapus session token dari localStorage
                        localStorage.removeItem('sessionToken');
                        
                        // 2. Arahkan pengguna kembali ke halaman login (reload penuh)
                        window.location.href = '/login';
                    }
                });
            }

            const gridItems = document.querySelectorAll('.more-grid .grid-item');
            if (gridItems.length > 0) {
                gridItems.forEach((item, index) => {
                    // Terapkan penundaan (delay) untuk setiap item
                    // 50ms * index = 0ms, 50ms, 100ms, dst.
                    setTimeout(() => {
                        item.classList.add('visible');
                    }, index * 50); // Penundaan 50ms per item
                });
            }

        }

        // === BAGIAN 3: LOGIKA SPA ROUTING (DENGAN PERBAIKAN) ===
        
        const pageContainer = document.getElementById('app-container');
        const isBlobEnvironment = window.location.protocol === 'blob:';

        function runPageInit(path) {
            if (path === '/') { initMainPage(); } 
            else if (path === '/wallet') { initWalletPage(); } 
            else if (path === '/create') { initCreatePage(); }
            else if (path === '/more') { initMorePage(); }
            else if (path === '/analysis') { initAnalysisPage(); }
        }

        function executePageScript(newContentElement) {
            const oldScript = document.getElementById('page-specific-script');
            if (oldScript) {
                oldScript.parentNode.removeChild(oldScript);
            }
            const scriptTemplate = newContentElement.querySelector('script[type="text/javascript-template"]');
            if (scriptTemplate) {
                try {
                    const newScript = document.createElement('script');
                    newScript.id = 'page-specific-script';
                    newScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(newScript);
                } catch (e) {
                    console.error("Error executing page script:", e);
                }
            }
        }
        
        async function navigate(path) {
            if (isBlobEnvironment) { 
                const targetUrl = new URL(path, window.location.origin);
                window.location.href = targetUrl.href;
                return; 
            }
            
            if (!pageContainer) return;
            try {
                const response = await fetch(path, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) { window.location.href = path; return; }
                const newContent = await response.text();
                
                history.pushState({ path }, '', path);
                pageContainer.innerHTML = newContent;
                executePageScript(pageContainer);
                runPageInit(path);

            } catch (error) {
                console.error("Gagal melakukan navigasi:", error);
                window.location.href = path;
            }
        }

        document.addEventListener('click', (event) => {
            const anchor = event.target.closest('a');
            if (anchor && anchor.href && new URL(anchor.href).origin === location.origin) {
                event.preventDefault();
                const path = new URL(anchor.href).pathname;
                if (path !== location.pathname) {
                    navigate(path);
                }
            }
        });

        window.addEventListener('popstate', (event) => {
            if (isBlobEnvironment) return; 
            if (event.state && event.state.path) {
                (async () => {
                    if (!pageContainer) return;
                    try {
                        const response = await fetch(event.state.path, { headers: { 'X-Requested-with': 'XMLHttpRequest' } });
                        if (!response.ok) { window.location.href = event.state.path; return; }
                        const newContent = await response.text();
                        pageContainer.innerHTML = newContent;
                        executePageScript(pageContainer);
                        runPageInit(event.state.path);
                    } catch (error) {
                         console.error("Gagal memuat state:", error);
                         window.location.href = event.state.path;
                    }
                })();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // [PERBAIKAN KUNCI] Pengecekan keamanan untuk session token
            const sessionToken = localStorage.getItem('sessionToken');
            const isAuthPage = window.location.pathname === '/login' || 
                               window.location.pathname === '/create-account' || 
                               window.location.pathname === '/two-step' ||
                               window.location.pathname === '/auth/callback';

            if (sessionToken && isAuthPage) {
                window.location.href = '/';
                return;
            }

            if (!sessionToken && !isAuthPage) {
                window.location.href = '/login';
                return;
            }
            // --- [Akhir Perbaikan Keamanan] ---


            if (!isBlobEnvironment) {
                history.replaceState({ path: location.pathname }, '', location.pathname);
            }
            
            // [PERBAIKAN] Terapkan tema saat halaman pertama kali dimuat
            applyTheme(getSettings().theme);
            executePageScript(pageContainer); 
            runPageInit(location.pathname);
        });
    </script>
</body>
</html>

