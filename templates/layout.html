<!DOCTYPE html>
<!-- [PERBAIKAN] Tag <html> ditambahkan untuk mode gelap -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casflo</title>
    
    <!-- [PERBAIKAN KUNCI] Skrip CDN Tailwind HARUS dimuat SEBELUM skrip konfigurasi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind
        tailwind.config = {
            darkMode: 'class' // Memberitahu Tailwind untuk mencari class="dark" di <html>
        }; // <-- [PERBAIKAN KUNCI] TITIK KOMA DITAMBAHKAN DI SINI

        // Skrip ini harus ada di <head> untuk mencegah layar putih berkedip (flickering)
        // saat mode gelap aktif.
        (function() {
            const settingsKey = 'casflo';
            let theme = 'system';
            try {
                const settings = localStorage.getItem(settingsKey);
                if (settings) {
                    theme = JSON.parse(settings).theme || 'system';
                }
            } catch (e) {
                // Biarkan default 'system'
            }
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Global & Halaman Utama */
        :root {
            --primary-blue: #4A47A3;
            --light-purple: #E6E6FA;
            --text-dark: #333;
            --text-light: #888;
            --expense-red: #E84545;
            --income-green: #51CF66;
            --bg-gray: #f4f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html { height: -webkit-fill-available; }
        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            touch-action: manipulation; 
        }
        .app-container { 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        }

        /* [BARU] Aturan CSS untuk Mode Gelap */
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark .app-container {
            background-color: #111827; /* dark:bg-gray-800 */
        }
        .dark .card {
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            box-shadow: none;
        }
        .dark .main-content {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .dark .transaction-list, .dark .empty-transaction-list, .dark .category-list-card,
        .dark .account-list {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .transaction-item, .dark .account-item {
            border-bottom-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .overview-card .stat-item .label, .dark .transaction-item .info .account, 
        .dark .transaction-item .details .notes, .dark .account-section-header,
        .dark .account-item .balance-info .currency, .dark .filter-bar {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .overview-card .date-selector, .dark .header-title, .dark .header-top .left .fa-search {
            color: white;
        }
        .dark .calendar-card, .dark .calendar-summary-tabs .tab {
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .calendar-summary-tabs .tab.active {
            color: var(--primary-blue);
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .dark .bottom-nav {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border-top: 1px solid #374151;
        }
        .dark .nav-item {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .nav-item.active {
            color: #ffffff; /* Tetap biru agar menonjol */
        }
        .dark .fab {
            background-color: #374151;
            color: #ffffff;
            border: 1px solid #4b5563;
        }
        .dark .more-grid .grid-item {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-header, .dark .analysis-header, .dark .more-header {
             background: var(--primary-blue); /* Tetap biru */
             cursor: pointer;
        }
        .dark .account-list {
             background-color: #374151;
        }
        .dark .stats-container .amount, .dark .account-item .details, .dark .account-item .balance-info .amount {
            color: white;
        }
        .dark .stats-container .main-balance .amount {
             color: white;
        }
        .dark .account-item .balance-info .amount.expense,
        .dark .overview-card .stat-item .amount.expense {
            color: var(--expense-red);
        }
        .dark .donut-chart-card, .dark .category-list-card {
            background-color: #374151;
        }
        .dark .donut-chart-center .amount {
            color: white;
        }
        .dark .add-view-container {
            background-color: #1f2937;
        }
        .dark .add-header, .dark .categories-section {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .dark .type-selector-header {
            background: #1f2937;
        }
        .dark .type-btn-header {
            color: #9ca3af;
        }
        .dark .type-btn-header.active {
            background: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dark .type-btn-header.expense.active { color: var(--expense-red); }
        .dark .type-btn-header.income.active { color: var(--income-green); }
        .dark .calculator-section {
            background: #1f2937;
            border-top-color: #4b5563;
        }
        .dark .amount-display, .dark .action-btn, .dark .calc-btn {
            background: #374151;
            color: #d1d5db;
            box-shadow: none;
        }
        .dark .action-btn.personal {
            background: #111827;
        }
        .dark .calc-btn.operator {
            background: #ccc;
        }
        .dark .category-item:hover {
            background: #4b5563;
        }

        /* ... Sisa CSS Global Anda ... */
        .main-header { background: var(--primary-blue); color: white; padding: 20px 20px 20px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; flex-shrink: 0; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-top .left { display: flex; align-items: center; gap: 18px; }
        .view-toggle-group { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 4px; }
        .toggle-btn { background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 16px; display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .toggle-btn.active-view { background: rgba(255,255,255,0.2); }
        .toggle-btn span { display: inline-block; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out, margin-left 0.3s ease-in-out; max-width: 100px; opacity: 1; margin-left: 5px; overflow: hidden; }
        .toggle-btn:not(.active-view) span { max-width: 0; opacity: 0; margin-left: 0; }
        .toggle-btn:not(.active-view) { padding: 8px 10px; }
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .header-actions { display: flex; gap: 15px; }
        .action-box { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; flex: 1; }
        .action-box .icon { background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .action-box .text { font-size: 14px; }
        .main-content { flex: 1; overflow-y: auto; padding: 0 20px; position: relative; z-index: 5; padding-bottom: 100px; }
        .card { background: white; border-radius: 18px; margin-bottom: 20px; margin-top: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); padding: 18px; }
        .empty-transaction-list { text-align: center; color: #888; padding: 40px 0; }
        .view-hidden { display: none; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        
        /* PERBAIKAN: Tata letak untuk view Detail & Kalender disederhanakan */
        .view-hidden {
            display: none;
        }
        .overview-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overview-card .card-header .icon { width: 40px; height: 40px; background: var(--light-purple); color: var(--primary-blue); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .overview-card .date-selector { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .overview-card .date-selector i { cursor: pointer; }
        .overview-card .card-actions { display: flex; gap: 12px; }
        .overview-card .card-actions .icon { color: var(--text-light); }
        .overview-card .card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; padding-top: 5px; }
        .overview-card .stat-item .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .overview-card .stat-item .amount { font-size: 16px; font-weight: 700; }
        .overview-card .stat-item .amount.expense { color: var(--expense-red); }
        .calendar-card .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 600; }
        .calendar-card .calendar-header i { cursor: pointer; }
        .calendar-card .calendar-header .month-year { font-size: 16px; }
        .calendar-card .calendar-header .btn-month-toggle { background-color: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; }
        .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day { font-size: 14px; padding: 5px 0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; cursor: pointer; }
        .calendar-grid .day.weekend { color: var(--expense-red); }
        .calendar-grid .day.selected .date-number { background-color: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .calendar-grid .day .day-summary { font-size: 8px; color: white; background-color: var(--expense-red); border-radius: 5px; padding: 1px 3px; position: absolute; bottom: 0; }
        .calendar-summary-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid var(--bg-gray); padding-bottom: 20px; }
        .calendar-summary-tabs .tab { background: none; border: 1px solid #ddd; border-radius: 20px; padding: 6px 15px; font-size: 13px; color: var(--text-light); cursor: pointer; }
        .calendar-summary-tabs .tab.active { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-purple); }
        .calendar-summary-amounts { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .calendar-summary-amounts .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .calendar-summary-amounts .amount { font-size: 16px; font-weight: 700; }
        .calendar-summary-amounts .amount.expense { color: var(--expense-red); }
        .transaction-list .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .transaction-list .list-header .date-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .transaction-list .list-header .summary { font-size: 13px; color: var(--text-light); }
        .transaction-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid var(--bg-gray); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:first-of-type { padding-top: 5px; }
        .transaction-item .icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .category { font-weight: 600; font-size: 15px; }
        .transaction-item .details .notes { font-size: 12px; color: var(--text-light); }
        .transaction-item .info { text-align: right; }
        .transaction-item .info .amount { font-weight: 700; color: var(--expense-red); font-size: 15px; }
        .transaction-item .info .account { font-size: 12px; color: var(--text-light); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; color: var(--primary-blue); z-index: 15; text-decoration: none; }
        .fab i { font-size: 22px; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        .add-view { display: flex; flex-direction: column; height: 100svh;display: flex;
        flex-direction: column;
        height: 100vh;
        height: 100svh;
        background-color: white;
        max-width: 480px;
        margin: 0 auto;}
        .add-header { padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background-color: white; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .type-selector-header { display: flex; background: #f8f9fa; border-radius: 25px; padding: 3px; }
        .type-btn-header { padding: 8px 16px; border: none; background: transparent; border-radius: 22px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-light); }
        .type-btn-header.active { background: white; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .type-btn-header.expense.active { color: var(--expense-red); }
        .type-btn-header.income.active { color: var(--income-green); }
        .categories-section { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: white; min-height: 0; }
        .category-group { margin-bottom: 20px; }
        .group-title { font-size: 12px; color: var(--text-light); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .category-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; }
        .category-item:hover { background: #f8f9fa; }
        .category-item.selected { background: var(--primary-blue); color: white; }
        .category-item.selected .category-icon { background: rgba(255,255,255,0.2) !important; color: white !important; }
        .category-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 20px; }
        .category-name { font-size: 11px; text-align: center; }
        .calculator-section { background: #f8f9fa; padding: 15px; border-top: 1px solid #e9ecef; flex-shrink: 0; display: grid; grid-template-rows: repeat(6, 1fr); gap: 8px; }
        .amount-container { display: flex; gap: 8px; }
        .account-card { aspect-ratio: 1 / 1; height: 100%; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 102, 234, 0.3); }
        .account-card i { color: white; font-size: 24px; }
        .amount-display { flex-grow: 1; background: white; padding: 0 12px; border-radius: 10px; text-align: right; font-size: 28px; font-weight: 700; display: flex; align-items: center; justify-content: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 100%; }
        .top-action-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .action-btn { background: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 24px; }
        .action-btn.personal { background: #f8f9fa; color: #6c757d; }
        .action-btn.today { background: #e3f2fd; color: #1976d2; }
        .action-btn.add { background: var(--income-green); color: white; }
        .action-btn.check { background: var(--income-green); color: white; }
        .action-btn.equals { background: var(--primary-blue); color: white; }
        .calc-grid { grid-row: 3 / 7; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; grid-auto-rows: 1fr; }
        .calc-btn { background: white; border: none; border-radius: 10px; font-size: 24px; font-weight: 600; cursor: pointer; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .calc-btn .fas { font-size: 24px; }
        .calc-btn.operator { background: #f1f3f5; color: #495057; }
        .calc-btn.delete { background: #ffe3e3; color: var(--expense-red); }
        .wallet-header { background: white; padding: 20px; font-size: 18px; font-weight: 600; text-align: center;}
        .total-balance-card .label { font-size: 14px; color: var(--text-light); margin-bottom: 5px; text-align: center; }
        .total-balance-card .amount { font-size: 32px; font-weight: 700; text-align: center; color: var(--primary-blue); }
        .account-list-card .card-title { font-weight: 600; margin-bottom: 15px; }
        .wallet-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--bg-gray); }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item .icon-wrapper { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .wallet-item .details { flex-grow: 1; font-weight: 500; }
        .wallet-item .balance { font-weight: 600; }
        /* [BARU] CSS untuk Grup Transaksi yang Bisa Di-collapse */
        .transaction-list .list-header {
            cursor: pointer;
            user-select: none; /* Mencegah teks terseleksi saat diklik */
        }
        .transaction-list .list-header .date-info i {
            transition: transform 0.2s ease-in-out;
        }
        .transaction-group.collapsed .list-header .date-info i {
            transform: rotate(-90deg); /* Putar ikon chevron saat ditutup */
        }
        .transaction-items-container {
            max-height: 1000px; /* Tinggi maks untuk animasi (bisa angka berapa saja) */
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out, transform 0.3s ease-out;
            opacity: 1;
            transform: translateY(0);
        }
        .transaction-group.collapsed .transaction-items-container {
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
        }
        /* [AKHIR BARU] */
        /* [BARU] CSS untuk Modal Pengganti Dompet */
        .wallet-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Sembunyi secara default */
            align-items: flex-end; /* Muncul dari bawah */
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .wallet-modal-overlay.visible {
            display: flex;
        }
        .wallet-modal-content {
            background: white;
            color: #333;
            width: 100%;
            max-width: 480px;
            padding: 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            animation: slideUp 0.3s ease-out;
            max-height: 50vh;
            overflow-y: auto;
        }
        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .wallet-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        .wallet-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
        }
        .wallet-list-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        .wallet-list-item:hover {
            background-color: #f4f5f9;
        }
        .wallet-list-item.active {
            background-color: var(--light-purple);
            color: var(--primary-blue);
            font-weight: 700;
        }
        /* Mode Gelap untuk Modal */
        .dark .wallet-modal-content {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-list-item:hover {
            background-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .wallet-list-item.active {
            background-color: var(--primary-blue);
            color: white;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* [AKHIR BARU] */

        @media (min-width: 768px) {
            body { background-color: #e9ecef; }
            .app-container { max-width: 480px; margin: 0 auto; height: 100vh; }
            .add-view { max-width: 480px; }
            .calculator-section { padding: 20px; gap: 12px; }
            .amount-display { font-size: 36px; }
            .calc-btn, .action-btn { font-size: 28px; min-height: 50px; border-radius: 12px; }
            .calc-btn .fas { font-size: 28px; }
            .dark body { background-color: #111827; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        {{PAGE_CONTENT}}
    </div>

    <div id="wallet-modal-overlay" class="wallet-modal-overlay" onclick="closeWalletSwitcher()">
        <div class="wallet-modal-content" onclick="event.stopPropagation()">
            <div class="wallet-modal-header">
                <h3>Pilih Dompet</h3>
                <button class="wallet-modal-close" onclick="closeWalletSwitcher()">&times;</button>
            </div>
            <div id="wallet-list-container">
                </div>
        </div>
    </div>

    <script>
        const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = '/login';
        }
        // === [BARU] BAGIAN 0: LOGIKA MODE GELAP/TERANG ===
        const settingsKey = 'casflo'; 
        const htmlEl = document.documentElement;

        // === [BARU] BAGIAN 0.5: API HELPER ===
        /**
         * Fungsi helper untuk memanggil API Anda dengan otentikasi.
         * @param {string} endpoint - Path API (cth: '/wallets')
         * @param {object} options - Opsi 'fetch' (method, body, dll.)
         * @returns {Promise<any>} - Properti 'data' dari respons JSON
         */
        async function fetchApi(endpoint, options = {}) {
            const token = localStorage.getItem('sessionToken');
            if (!token) {
                console.log("Token tidak ditemukan, mengarahkan ke login.");
                navigate('/login');
                throw new Error('Sesi tidak valid');
            }

            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // [PENTING] Sesuai middleware 'protect'
            };

            const config = {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            };

            // Ganti 'https://api.casflo.id' dengan URL API Anda jika berbeda
            const response = await fetch(`https://api.casflo.id/api/v1${endpoint}`, config);

            if (response.status === 401) { // Token expired atau invalid
                localStorage.removeItem('sessionToken');
                console.log("Sesi 401, token dihapus.");
                navigate('/login');
                throw new Error('Sesi kedaluwarsa');
            }

            if (!response.ok) {
                const errorResult = await response.json();
                console.error("API Error:", errorResult);
                throw new Error(errorResult.error?.message || 'Gagal mengambil data dari API');
            }
            
            // API Anda selalu mengembalikan { success: true, data: ... }
            const result = await response.json(); 
            return result.data; 
        }
        // --- [AKHIR BAGIAN 0.5] ---
// --- [AKHIR BAGIAN 0.5] ---

        // [BARU] Fungsi-fungsi untuk Modal Pengganti Dompet
        const walletModal = document.getElementById('wallet-modal-overlay');
        const walletListContainer = document.getElementById('wallet-list-container');
        
        async function openWalletSwitcher() {
            if (!walletModal || !walletListContainer) return;

            try {
                const currentWalletId = localStorage.getItem('currentWalletId');
                // 1. Ambil daftar dompet terbaru dari API
                const wallets = await fetchApi('/wallets');
                
                // 2. Bersihkan daftar sebelumnya
                walletListContainer.innerHTML = ''; 

                // 3. Isi daftar dengan dompet yang ada
                wallets.forEach(wallet => {
                    const item = document.createElement('div');
                    item.className = 'wallet-list-item';
                    item.textContent = wallet.name;
                    // Tandai dompet yang sedang aktif
                    if (wallet.id === currentWalletId) {
                        item.classList.add('active');
                    }
                    // Tambahkan aksi klik
                    item.onclick = () => selectWallet(wallet.id, wallet.name);
                    walletListContainer.appendChild(item);
                });
                
                // 4. Tampilkan modal
                walletModal.classList.add('visible');

            } catch (error) {
                console.error("Gagal membuka pengganti dompet:", error);
                alert("Gagal memuat daftar dompet.");
            }
        }

        function closeWalletSwitcher() {
            if (walletModal) {
                walletModal.classList.remove('visible');
            }
        }

        function selectWallet(walletId, walletName) {
            // 1. Simpan pilihan baru ke localStorage
            localStorage.setItem('currentWalletId', walletId);
            localStorage.setItem('currentWalletName', walletName);
            
            // 2. Tutup modal
            closeWalletSwitcher();
            
            // 3. Muat ulang halaman agar semua data (transaksi, akun, dll)
            //    diambil ulang untuk dompet yang baru dipilih.
            //    Ini adalah cara paling aman untuk memastikan data konsisten.
            window.location.href = '/';
        }
        // ... (setelah fungsi selectWallet)

        // [BARU] Helper untuk Collapsible Groups
        const COLLAPSED_KEY = 'casflo_collapsed_groups';
        function getCollapsedGroups() {
            try {
                const collapsed = localStorage.getItem(COLLAPSED_KEY);
                return collapsed ? JSON.parse(collapsed) : [];
            } catch (e) {
                return []; // Jika JSON rusak, reset
            }
        }
        function saveCollapsedGroups(groups) {
            localStorage.setItem(COLLAPSED_KEY, JSON.stringify(groups));
        }
        
        /**
         * Dipanggil saat header tanggal diklik
         * @param {string} dateKey - Kunci unik untuk grup tanggal (misal: "Tue Nov 05 2025")
         * @param {HTMLElement} headerElement - Elemen .list-header yang diklik
         */
        function toggleGroupCollapse(dateKey, headerElement) {
            const group = headerElement.closest('.transaction-group');
            if (!group) return;

            const isCollapsed = group.classList.toggle('collapsed');
            let collapsedGroups = getCollapsedGroups();
            
            if (isCollapsed) {
                // Baru saja DITUTUP, tambahkan ke daftar
                if (!collapsedGroups.includes(dateKey)) {
                    collapsedGroups.push(dateKey);
                }
            } else {
                // Baru saja DIBUKA, hapus dari daftar
                collapsedGroups = collapsedGroups.filter(key => key !== dateKey);
            }
            saveCollapsedGroups(collapsedGroups);
        }
        // [AKHIR BARU]

        // [AKHIR BARU]

        // [BARU] Fungsi untuk mengambil data awal (dompet & akun) saat aplikasi dimuat
       // [PERBAIKAN] Fungsi ini sekarang memprioritaskan dompet di localStorage
 

       // [PERBAIKAN KATEGORI] Ganti total fungsi ini
       async function initializeAppData() {
            try {
                // 1. Cek apakah sudah ada dompet yang dipilih sebelumnya
                const preferredWalletId = localStorage.getItem('currentWalletId');

                // 2. Ambil semua dompet milik user
                const wallets = await fetchApi('/wallets');
                if (!wallets || wallets.length === 0) {
                    console.warn('User tidak punya dompet. Mengarahkan ke /create-wallet');
                    window.location.href = '/create-wallet'; 
                    return;
                }

                // 3. Tentukan dompet aktif
                let activeWallet;
                if (preferredWalletId) {
                    // Cari dompet yang tersimpan di localStorage dari daftar API
                    activeWallet = wallets.find(w => w.id === preferredWalletId);
                }

                // Jika tidak ada dompet yang tersimpan (atau tidak valid), gunakan dompet pertama
                if (!activeWallet) {
                    activeWallet = wallets[0];
                }
                
                // 4. Simpan dompet aktif yang valid ke localStorage
                localStorage.setItem('currentWalletId', activeWallet.id);
                localStorage.setItem('currentWalletName', activeWallet.name); 
                console.log(`Dompet aktif diatur: ${activeWallet.name} (${activeWallet.id})`);

                // 5. [INI BAGIAN KUNCINYA] Ambil akun dan kategori untuk dompet aktif
                const [accounts, categories] = await Promise.all([
                    fetchApi(`/wallets/${activeWallet.id}/accounts`),
                    fetchApi(`/wallets/${activeWallet.id}/categories`)
                ]);

                // 6. Simpan Akun ke Global
                allAccounts = accounts;
                if (!accounts || accounts.length === 0) {
                    console.error('ERROR: Dompet ini tidak memiliki akun!');
                    // Di aplikasi nyata, ini idealnya tidak terjadi
                } else {
                    // Tetapkan akun default (utamakan ASET)
                    const defaultAccount = accounts.find(a => a.type === 'ASSET') || accounts[0];
                    selectedAccountId = defaultAccount.id; // Set var global
                    console.log(`Akun aktif diatur: ${defaultAccount.name} (${defaultAccount.id})`);
                }

                // 7. Simpan Kategori ke Global
                allCategories = categories; // <--- INI AKAN MENGISI ARRAY
                console.log(`Berhasil memuat ${allCategories.length} kategori.`);
                // [AKHIR BAGIAN KUNCI]


                // 8. Panggil 'runPageInit' SETELAH semua data siap
                runPageInit(location.pathname);

            } catch (error) {
                console.error("Gagal inisialisasi data aplikasi:", error);
                if (error.message !== 'Sesi kedaluwarsa') {
                    alert("Gagal inisialisasi data: " + error.message);
                }
            }
        }
        function getSettings() {
            try {
                const settings = localStorage.getItem(settingsKey);
                // Default jika tidak ada settings: { theme: 'system' }
                return settings ? JSON.parse(settings) : { theme: 'system' };
            } catch (e) {
                return { theme: 'system' }; // Fallback jika JSON rusak
            }
        }

        function saveSettings(settingsObject) {
            try {
                // Ambil settings yang ada, lalu gabungkan dengan yang baru
                const existingSettings = getSettings();
                const newSettings = { ...existingSettings, ...settingsObject };
                localStorage.setItem(settingsKey, JSON.stringify(newSettings));
            } catch (e) {
                console.error("Gagal menyimpan settings:", e);
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else if (theme === 'light') {
                htmlEl.classList.remove('dark');
            } else {
                // Mode 'system' (default)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            }
        }

        // Terapkan tema segera saat skrip ini dimuat
        let currentSettings = getSettings();
        applyTheme(currentSettings.theme);
        
        // Fungsi ini dipanggil oleh init...Page()
        function attachThemeToggle(selector) {
            const themeToggleBtn = document.querySelector(selector);
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const isCurrentlyDark = htmlEl.classList.contains('dark');
                    const newTheme = isCurrentlyDark ? 'light' : 'dark';
                    applyTheme(newTheme); 
                    saveSettings({ theme: newTheme }); // Simpan pilihan baru
                });
            }
        }
        // --- [AKHIR BAGIAN 0] ---


        // === BAGIAN 1: VARIABEL & FUNGSI GLOBAL ===
        let currentDate = new Date();
        let selectedDate = new Date();
        let transactions = []; // Data dummy, ganti dengan API call
        let currentView = 'overview';
        let calendarFilter = 'expense';
        // Variabel global untuk 'create.html'
        let currentType = 'expense';
        let selectedCategory = null;
        let calcValue = '0';
        let waitingForEquals = false;

        let allCategories = [];
        let allAccounts = [];
        let selectedAccountId = null; // Kita akan kelola ini secara global
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        function appendToCalc(value) {
            const operators = ['+', '-', '*', '/'];
            
            if (operators.includes(value)) {
                waitingForEquals = true;
                changeButtonToEquals();
            }
            
            // [PERBAIKAN] Mencegah duplikat titik/koma
            if (value === '.' && calcValue.includes('.')) {
                return; // Jangan lakukan apa-apa jika sudah ada titik
            }

            if (calcValue === '0' && !operators.includes(value) && value !== '.') {
                calcValue = value;
            } else {
                const lastChar = calcValue.slice(-1);
                if (operators.includes(lastChar) && operators.includes(value)) {
                    calcValue = calcValue.slice(0, -1) + value;
                } else {
                    calcValue += value;
                }
            }
            updateDisplay();
        }
        function deleteLast() { calcValue = calcValue.slice(0, -1) || '0'; checkWaitingForEquals(); updateDisplay(); }
        function handleActionClick() { if (waitingForEquals) calculateResult(); else saveTransaction(); }
        function selectType(type) { currentType = type; document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active')); document.getElementById(type + 'Btn').classList.add('active'); selectedCategory = null; loadCategories(); }
        function updateDisplay() {
            const amountDisplay = document.getElementById('amountDisplay');
            if (!amountDisplay) return;

            // Pisahkan bagian integer dan desimal
            let parts = calcValue.split('.');
            
            // Format bagian integer (sebelum koma) dengan titik pemisah ribuan
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            let displayValue;
            if (parts.length > 1) {
                // Jika ada desimal, gabungkan dengan KOMA
                displayValue = integerPart + ',' + (parts[1] || '');
            } else {
                // Jika tidak ada desimal
                displayValue = integerPart;
            }
            
            amountDisplay.textContent = displayValue;
        }
        function checkWaitingForEquals() { const hasOperator = ['+', '-', '*', '/'].some(op => calcValue.includes(op)); if (!hasOperator) { waitingForEquals = false; changeButtonToCheck(); } }
        function changeButtonToEquals() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn equals'; actionBtn.innerHTML = '<i class="fas fa-equals"></i>'; }}
        function changeButtonToCheck() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn check'; actionBtn.innerHTML = '<i class="fas fa-check"></i>'; }}
        function calculateResult() { try { let expression = calcValue.replace(/ร/g, '*').replace(/รท/g, '/'); const result = eval(expression); calcValue = String(result); waitingForEquals = false; changeButtonToCheck(); updateDisplay(); } catch (e) { calcValue = '0'; updateDisplay(); } }
        function clearCalc() { calcValue = '0'; waitingForEquals = false; changeButtonToCheck(); updateDisplay(); }
        function loadCategories() {
            // [PERBAIKAN] Filter dari 'allCategories' global, sesuaikan 'type'
            const typeToFilter = currentType.toUpperCase(); // 'expense' -> 'EXPENSE'
            const categories = allCategories.filter(cat => cat.type === typeToFilter);

            const recommendedGrid = document.getElementById('recommendedGrid');
            const uncategorizedGrid = document.getElementById('uncategorizedGrid');
            if(!recommendedGrid || !uncategorizedGrid) return;
            
            recommendedGrid.innerHTML = '';
            uncategorizedGrid.innerHTML = '';
            
            // Logika slice dan render tetap sama
            categories.slice(0, 4).forEach(cat => recommendedGrid.appendChild(createCategoryElement(cat)));
            categories.slice(4).forEach(cat => uncategorizedGrid.appendChild(createCategoryElement(cat)));
        }
        
        
        
        function createCategoryElement(category) {
            const div = document.createElement('div');
            div.className = 'category-item';
            div.onclick = () => selectCategory(category, div);
            
            // [PERBAIKAN] Gunakan 'category.icon' dari database.
            // Jika icon-nya null, gunakan huruf pertama sebagai cadangan.
            const icon = category.icon || category.name.charAt(0).toUpperCase();
            const defaultColor = 'var(--light-purple)'; // Warna default

            div.innerHTML = `<div class="category-icon" style="background: ${defaultColor}">${icon}</div><div class="category-name">${category.name}</div>`;
            return div;
        }
        
        
        function selectCategory(category, element) { selectedCategory = category; document.querySelectorAll('.category-item').forEach(item => item.classList.remove('selected')); element.classList.add('selected'); }
        async function saveTransaction() {
            try {
                const amount = parseFloat(calcValue); 
                if (isNaN(amount) || amount <= 0) {
                    alert('Masukkan jumlah yang valid'); // Ganti dengan modal custom
                    return;
                }
                if (!selectedCategory) {
                    alert('Pilih kategori terlebih dahulu'); // Ganti dengan modal custom
                    return;
                }

                // 1. Dapatkan Token & Data Penting dari localStorage
                //    (Kita asumsikan data ini disimpan setelah login/saat memilih dompet)
                const token = localStorage.getItem('sessionToken');
                
                // [PENTING] Anda perlu cara untuk menyimpan dan mengambil walletId dan accountId yang sedang aktif
                // Untuk contoh ini, kita asumsikan ID-nya di-hardcode atau diambil dari localStorage
                const walletId = localStorage.getItem('currentWalletId'); // GANTI INI: Anda harus implementasikan logika untuk ini
                const accountId = selectedAccountId;


                if (!token) {
                    alert('Sesi tidak ditemukan. Silakan login ulang.');
                    navigate('/login');
                    return;
                }
                if (!walletId || !accountId) {
                    alert('Dompet atau akun aktif tidak ditemukan. Silakan muat ulang.');
                    // Di aplikasi nyata, Anda akan mengambil data ini dari API terlebih dahulu
                    // Untuk sementara, kita bisa hentikan di sini
                    console.error("currentWalletId atau selectedAccountId tidak ditemukan di localStorage.");
                    return; 
                }

                // 2. Siapkan Payload (Body) sesuai spesifikasi API Anda
                // Endpoint mengharapkan format YYYY-MM-DD untuk tanggal
                const transactionDate = new Date().toISOString().split('T')[0]; 
                
                const payload = {
                    wallet_id: walletId,
                    type: currentType.toUpperCase(), // API mengharapkan 'EXPENSE' atau 'INCOME'
                    amount: amount, // API Anda di 'queries.js' sudah menangani konversi ke sen
                    category_id: selectedCategory.id,
                    description: selectedCategory.name, // Anda bisa tambahkan input deskripsi terpisah nanti
                    transaction_date: transactionDate,
                };

                // API 'queries.js' Anda mengharapkan 'from_account_id' atau 'to_account_id'
                if (currentType === 'expense') {
                    payload.from_account_id = accountId;
                } else {
                    payload.to_account_id = accountId;
                }

                // (Opsional) Tampilkan loading state di tombol
                changeButtonToLoading(true); // Anda perlu membuat fungsi ini

                // 3. Kirim data ke API
                const response = await fetch(`https://api.casflo.id/api/v1/wallets/${walletId}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // [WAJIB] Kirim token otentikasi
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'Gagal menyimpan transaksi');
                }

                // 4. Sukses!
                console.log('Transaksi berhasil disimpan:', result.data);
                
                // Reset kalkulator & navigasi kembali ke halaman utama
                clearCalc(); 
                navigate('/'); 

            } catch (error) {
                console.error('Error saving transaction:', error);
                alert(`Terjadi kesalahan: ${error.message}`); // Tampilkan error ke user
            } finally {
                // (Opsional) Hilangkan loading state
                changeButtonToLoading(false); // Anda perlu membuat fungsi ini
            }
        }
        
        // (Opsional) Fungsi helper untuk loading state
        function changeButtonToLoading(isLoading) {
            const actionBtn = document.getElementById('actionBtn');
            if (!actionBtn) return;
            
            if (isLoading) {
                actionBtn.disabled = true;
                actionBtn.innerHTML = '<span class="loading-spinner-tombol"></span>'; // Anda perlu CSS untuk .loading-spinner-tombol
            } else {
                actionBtn.disabled = false;
                // Kembalikan ke tombol 'check' atau 'equals'
                checkWaitingForEquals(); 
            }
        }
        // --- [PERBAIKAN KALENDER] Fungsi Halaman Utama ---
        function setView(viewName) {
            currentView = viewName;
            localStorage.setItem('preferredView', viewName);
            const overviewCard = document.getElementById('overviewCard');
            const calendarCard = document.getElementById('calendarCard');
            const detailToggleBtn = document.getElementById('detailToggleBtn');
            const calendarToggleBtn = document.getElementById('calendarToggleBtn');

            if (detailToggleBtn) detailToggleBtn.classList.toggle('active-view', viewName === 'overview');
            if (calendarToggleBtn) calendarToggleBtn.classList.toggle('active-view', viewName === 'calendar');

            if (viewName === 'overview') {
                if (overviewCard) overviewCard.classList.remove('view-hidden');
                if (calendarCard) calendarCard.classList.add('view-hidden');
            } else {
                if (overviewCard) overviewCard.classList.add('view-hidden');
                if (calendarCard) calendarCard.classList.remove('view-hidden');
                renderCalendar(); 
            }
        }
        function updateMonthDisplay() { 
            const display = document.getElementById('currentMonthDisplay');
            const calendarDisplay = document.getElementById('calendarMonthYear');
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            if (display) {
                display.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;
            }
            if (calendarDisplay) {
                 calendarDisplay.textContent = `${monthNames[month]} ${year}`;
            }
            updateMainView(); 
        }
        function goToPrevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function goToNextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function setCalendarFilter(filter) { 
            calendarFilter = filter;
            if (document.getElementById('tabPengeluaran')) document.getElementById('tabPengeluaran').classList.toggle('active', filter === 'expense');
            if (document.getElementById('tabPenghasilan')) document.getElementById('tabPenghasilan').classList.toggle('active', filter === 'income');
            if (document.getElementById('tabTotal')) document.getElementById('tabTotal').classList.toggle('active', filter === 'total');
            renderCalendar();
        }
        function renderCalendar() { 
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            console.log("Merender kalender...");
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const date = new Date(year, month, i);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                dayEl.innerHTML = `<span class="date-number">${i}</span>`;
                
                let dailyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getDate() === i && tDate.getMonth() === month && tDate.getFullYear() === year;
                });
                if (calendarFilter === 'expense') { dailyTransactions = dailyTransactions.filter(t => t.type === 'expense'); } 
                else if (calendarFilter === 'income') { dailyTransactions = dailyTransactions.filter(t => t.type === 'income'); }
                
                const dailyTotal = dailyTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? -t.amount : t.amount), 0);
                
                if(dailyTotal !== 0){ 
                    const summaryEl = document.createElement('span'); 
                    summaryEl.className = 'day-summary'; 
                    summaryEl.style.backgroundColor = dailyTotal < 0 ? 'var(--expense-red)' : 'var(--income-green)'; 
                    if (calendarFilter === 'total' && dailyTotal > 0) summaryEl.style.backgroundColor = 'var(--income-green)'; 
                    summaryEl.textContent = `${dailyTotal < 0 ? '-' : ''}${Math.abs(dailyTotal/1000).toFixed(0)}k`; 
                    dayEl.appendChild(summaryEl); 
                }
                calendarGrid.appendChild(dayEl);
            }
        }
        function renderTransactionList(filteredTransactions) { 
            const transactionListEl = document.querySelector('.transaction-list');
            if (!transactionListEl) return;
            transactionListEl.innerHTML = '';
            
            // [BARU] Ambil status collapsed dari localStorage
            const collapsedGroups = getCollapsedGroups();
            
            // [SAMA] Mengelompokkan transaksi berdasarkan tanggal
            const grouped = filteredTransactions.reduce((acc, tx) => {
                const dateKey = new Date(tx.date).toDateString(); // Ini akan jadi ID unik kita
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(tx);
                return acc;
            }, {});

            if (Object.keys(grouped).length === 0) {
                transactionListEl.innerHTML = `<div class="empty-transaction-list">Belum ada transaksi di bulan ini</div>`;
                return;
            }

            // [SAMA] Urutkan grup tanggal
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            for (const dateKey of sortedDates) {
                const txsOnThisDate = grouped[dateKey];
                const date = new Date(dateKey);
                
                // [DIUBAH] Hitung total pengeluaran (dalam sen)
                const totalExpenseOnDate = txsOnThisDate
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                // [BARU] 1. Buat wrapper grup
                const groupEl = document.createElement('div');
                groupEl.className = 'transaction-group';

                // [BARU] 2. Buat header dan tambahkan event listener
                const listHeader = document.createElement('div');
                listHeader.className = 'list-header';
                
                // [DIUBAH] Tampilkan total (dibagi 100) dan tambahkan onclick
                listHeader.innerHTML = `<div class="date-info"><i class="fas fa-chevron-down fa-xs"></i><span>${date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: '2-digit' })}</span></div><div class="summary">Pengeluaran: Rp${(totalExpenseOnDate / 100).toLocaleString('id-ID')}</div>`;
                listHeader.onclick = () => toggleGroupCollapse(dateKey, listHeader);
                
                // [BARU] 3. Buat kontainer untuk item
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'transaction-items-container';

                // [BARU] 4. Cek apakah grup ini harus ditutup saat render
                if (collapsedGroups.includes(dateKey)) {
                    groupEl.classList.add('collapsed');
                }
                
                // [BARU] 5. Append header ke grup
                groupEl.appendChild(listHeader);

                txsOnThisDate.forEach(t => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'transaction-item';
                    
                    // [DIUBAH] Ambil ikon dari data (tx.icon) dan bagi amount dengan 100
                    const icon = t.icon || t.category.charAt(0);
                    itemEl.innerHTML = `
                        <div class="icon" style="background-color: ${t.color};"><span>${icon}</span></div>
                        <div class="details"><div class="category">${t.category}</div><div class="notes">${t.notes}</div></div>
                        <div class="info">
                            <div class="amount" style="color: ${t.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)'}">
                                ${t.type === 'expense' ? '-' : ''}Rp${(t.amount).toLocaleString('id-ID')}
                            </div>
                            <div class="account">${t.account}</div>
                        </div>`;
                    
                    // [DIUBAH] Append item ke kontainer, BUKAN ke list utama
                    itemsContainer.appendChild(itemEl);
                });
                
                // [BARU] 6. Append kontainer item ke grup
                groupEl.appendChild(itemsContainer);

                // [BARU] 7. Append grup ke list utama
                transactionListEl.appendChild(groupEl);
            }
        }

       // [PERBAIKAN] Fungsi diubah menjadi async untuk mengambil data dari API
        async function updateMainView() { 
            console.log("Memuat data API untuk", currentDate.toISOString().slice(0, 7));
            
            const walletId = localStorage.getItem('currentWalletId');
            if (!walletId) {
                console.warn("updateMainView: Menunggu walletId...");
                return; // Berhenti jika data awal (dari initializeAppData) belum dimuat
            }

            // Tentukan rentang tanggal untuk filter API
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            // Format YYYY-MM-DD
            const startDate = new Date(year, month, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

            try {
                // Ambil transaksi dari API, BUKAN dari array global
                // [MEMANGGIL API] GET /api/v1/wallets/:walletId/transactions
                const fetchedTransactions = await fetchApi(
                    `/wallets/${walletId}/transactions?startDate=${startDate}&endDate=${endDate}`
                );
                
                // [PENTING] Konversi data API ke format yang diharapkan oleh renderTransactionList()
                // BLOK BARU YANG BENAR:
                transactions = fetchedTransactions.map(tx => {
                    // API mengirim: 'EXPENSE' (amount positif) atau 'INCOME' (amount negatif)
                    const isExpense = tx.category_type === 'EXPENSE'; 
                    return {
                        id: tx.id,
                        type: isExpense ? 'expense' : 'income',
                        // [FIX 1] Ambil nilai absolut dan bagi 100 (karena API kirim sen)
                        amount: Math.abs(tx.amount),
                        category: tx.category_name,
                        notes: tx.description || 'Tanpa catatan',
                        // [FIX 2] Ambil account_name dari API
                        account: tx.account_name, 
                        // [FIX 3] Ganti icon '...?' dengan inisial kategori
                        icon: tx.category_name.charAt(0).toUpperCase(), 
                        color: 'var(--light-purple)', // Warna default
                        date: tx.transaction_date
                    };
                });

                // Sisa fungsi ini SAMA seperti sebelumnya
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const total = income - expense;
                const formatCurrency = (value) => { const sign = value < 0 ? '-' : ''; return `${sign}Rp${Math.abs(value).toLocaleString('id-ID')}`; };
                
                // [BARU] Fungsi helper untuk update ikon akun di halaman /create
                function updateAccountIcon(accountId) {
                    const account = allAccounts.find(acc => acc.id === accountId);
                    if (!account) return;

                    const accountCard = document.querySelector('.account-card');
                    if (accountCard) {
                        // Tampilkan 2 huruf inisial nama akun
                        const initial = account.name.substring(0, 2).toUpperCase();
                        accountCard.innerHTML = `<span style="font-size: 1.2rem; font-weight: 600;">${initial}</span>`;
                    }
                }

                // [BARU] Implementasi fungsi selectAccount()
                function selectAccount() {
                    if (allAccounts.length === 0) return; // Belum dimuat

                    // 1. Cari indeks akun yang sedang dipilih
                    const currentIndex = allAccounts.findIndex(acc => acc.id === selectedAccountId);
                    // 2. Dapatkan indeks berikutnya, kembali ke 0 jika sudah di akhir
                    const nextIndex = (currentIndex + 1) % allAccounts.length;
                    
                    const nextAccount = allAccounts[nextIndex];
                    selectedAccountId = nextAccount.id; // 3. Set akun baru secara global

                    // 4. Update UI
                    updateAccountIcon(selectedAccountId);
                    console.log(`Akun diubah ke: ${nextAccount.name}`);
                }
                
                
                
                if(document.getElementById('totalAmount')) document.getElementById('totalAmount').textContent = formatCurrency(total);
                if(document.getElementById('incomeAmount')) document.getElementById('incomeAmount').textContent = formatCurrency(income);
                if(document.getElementById('expenseAmount')) document.getElementById('expenseAmount').textContent = formatCurrency(expense);
                if(document.getElementById('calendarTotalAmount')) document.getElementById('calendarTotalAmount').textContent = formatCurrency(total);
                if(document.getElementById('calendarIncomeAmount')) document.getElementById('calendarIncomeAmount').textContent = formatCurrency(income);
                if(document.getElementById('calendarExpenseAmount')) document.getElementById('calendarExpenseAmount').textContent = formatCurrency(expense);
                
                renderTransactionList(transactions.sort((a, b) => new Date(b.date) - new Date(a.date)));
                if(currentView === 'calendar') renderCalendar();
            
            } catch (error) {
                console.error("Gagal memuat transaksi:", error);
                if (error.message !== 'Sesi kedaluwarsa') {
                   alert("Gagal memuat transaksi: " + error.message);
                }
            }
        }
        // === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        // Fungsi helper untuk update ikon akun di halaman /create
        function updateAccountIcon(accountId) {
            const account = allAccounts.find(acc => acc.id === accountId);
            if (!account) return;

            const accountCard = document.querySelector('.account-card');
            if (accountCard) {
                // Tampilkan 2 huruf inisial nama akun
                const initial = account.name.substring(0, 2).toUpperCase();
                accountCard.innerHTML = `<span style="font-size: 1.2rem; font-weight: 600;">${initial}</span>`;
            }
        }

        // Implementasi fungsi selectAccount()
        function selectAccount() {
            if (allAccounts.length === 0) return; // Belum dimuat

            // 1. Cari indeks akun yang sedang dipilih
            const currentIndex = allAccounts.findIndex(acc => acc.id === selectedAccountId);
            // 2. Dapatkan indeks berikutnya, kembali ke 0 jika sudah di akhir
            const nextIndex = (currentIndex + 1) % allAccounts.length;
            
            const nextAccount = allAccounts[nextIndex];
            selectedAccountId = nextAccount.id; // 3. Set akun baru secara global

            // 4. Update UI
            updateAccountIcon(selectedAccountId);
            console.log(`Akun diubah ke: ${nextAccount.name}`);
        }

        // === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        function initMainPage() {
            console.log("Halaman Utama diinisialisasi.");
            document.getElementById('detailToggleBtn')?.addEventListener('click', () => setView('overview'));
            document.getElementById('calendarToggleBtn')?.addEventListener('click', () => setView('calendar'));
            document.getElementById('prevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('nextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('calendarPrevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('calendarNextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('tabPengeluaran')?.addEventListener('click', () => setCalendarFilter('expense'));
            document.getElementById('tabPenghasilan')?.addEventListener('click', () => setCalendarFilter('income'));
            document.getElementById('tabTotal')?.addEventListener('click', () => setCalendarFilter('total'));

            const savedView = localStorage.getItem('preferredView');
            if (document.getElementById('detailToggleBtn')) { 
                setView(savedView || 'overview');
            }
            if (document.getElementById('currentMonthDisplay')) {
                updateMonthDisplay(); 
            }

            // [PERBAIKAN] Ambil nama dompet dari localStorage
            const walletName = localStorage.getItem('currentWalletName');
            if (walletName) {
                // 1. Update header utama
                const walletNameEl = document.getElementById('currentWalletNameDisplay');
                if (walletNameEl) {
                    walletNameEl.textContent = walletName;
                }

                // 2. Update kotak aksi
                const walletShortNameEl = document.getElementById('currentWalletNameShort');
                if (walletShortNameEl) {
                    // Tampilkan 6 karakter pertama + ...
                    walletShortNameEl.textContent = walletName.length > 6 ? walletName.substring(0, 6) + '...' : walletName;
                }
            }
            // [PERBAIKAN] Tambahkan listener untuk tombol pengganti dompet
            document.getElementById('walletSwitcherBtn')?.addEventListener('click', openWalletSwitcher);
            
            // [PERBAIKAN] Fungsikan tombol "Baru B..."
            document.getElementById('createNewWalletBtn')?.addEventListener('click', () => {
                navigate('/create-wallet');
            });

            // Pasang listener untuk tombol mode gelap/terang
            attachThemeToggle('.theme-toggle'); 
        }
        
        function initCreatePage() {
            currentType = 'expense';
            selectedCategory = null;
            clearCalc();
            loadCategories(); // Sekarang akan memuat dari API (via allCategories)
            
            // [BARU] Tampilkan ikon akun yang sedang aktif saat halaman dimuat
            updateAccountIcon(selectedAccountId); 
            
            console.log("Halaman Create dimuat.");
        }

        function initWalletPage() { 
            console.log("Halaman dompet dimuat."); 
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }
        
        function initAnalysisPage() {
            console.log("Halaman Analisis dimuat.");

            const activePill = document.querySelector('.header-tabs .active-pill');
            const tabButtons = document.querySelectorAll('.header-tabs .tab-button');
            if (!activePill || !tabButtons.length) return;

            function movePill(targetButton) {
                requestAnimationFrame(() => {
                    if (targetButton) {
                        activePill.style.width = `${targetButton.offsetWidth}px`;
                        activePill.style.left = `${targetButton.offsetLeft}px`;
                    }
                });
            }

            function handleTabClick(event) {
                const clickedButton = event.currentTarget;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                movePill(clickedButton);

                const mode = clickedButton.dataset.mode;
                if (mode === 'pengeluaran') {
                    animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)');
                } else if (mode === 'penghasilan') {
                    animateChart(85, 850000000, 'Penghasilan', 'var(--income-green)');
                } else {
                    animateChart(0, 0, mode.charAt(0).toUpperCase() + mode.slice(1), '#ccc');
                }
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            // [PERBAIKAN KUNCI] Beri jeda sesaat sebelum menghitung posisi awal.
            // Ini memberi waktu bagi browser untuk menyelesaikan render animasi CSS.
            const initialActiveTab = document.querySelector('.header-tabs .tab-button.active');
            if (initialActiveTab) {
                setTimeout(() => {
                    movePill(initialActiveTab);
                }, 50); // Jeda 50 milidetik biasanya sudah cukup.
            }
            
            // Menambahkan listener untuk memperbaiki posisi saat layar dirotasi
            window.addEventListener('resize', () => {
                const currentActiveTab = document.querySelector('.header-tabs .tab-button.active');
                if (currentActiveTab) {
                    movePill(currentActiveTab);
                }
            });
            
                        function animateChart(percentage, totalAmount, label, color) {
                const segment = document.getElementById('chart-segment');
                const amountEl = document.getElementById('chart-total-amount');
                const labelEl = document.getElementById('chart-center-label');
                if (!segment || !amountEl || !labelEl) return;
                labelEl.textContent = label;
                segment.style.stroke = color;
                const radius = segment.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                segment.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (percentage / 100) * circumference;
                segment.style.strokeDashoffset = offset;
                let currentAmount = 0;
                const steps = 100;
                const increment = totalAmount / steps;
                if(window.chartCounter) clearInterval(window.chartCounter);
                window.chartCounter = setInterval(() => {
                    currentAmount += increment;
                    if (currentAmount >= totalAmount) {
                        currentAmount = totalAmount;
                        clearInterval(window.chartCounter);
                    }
                    amountEl.textContent = 'Rp' + Math.floor(currentAmount).toLocaleString('id-ID');
                }, 10);
            }


            setTimeout(() => {
                animateChart(99.9, 1000204542, 'Pengeluaran', 'var(--expense-red)'); 
            }, 100);
        }

        function initMorePage() {
            currentType = 'expense';
            selectedCategory = null;
            clearCalc();
            loadCategories();
            console.log("Halaman More dimuat.");

             const logoutButton = document.getElementById('logout-btn');
        
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    console.log("Tombol Logout diklik.");
                    
                    // Tampilkan konfirmasi sederhana
                    // NOTE: confirm() mungkin tidak berfungsi di beberapa lingkungan 'blob'
                    // Jika ini tidak muncul, kita harus membuat modal custom
                    if (confirm("Apakah Anda yakin ingin logout?")) {
                        // 1. Hapus session token dari localStorage
                        localStorage.removeItem('sessionToken');
                        
                        // 2. Arahkan pengguna kembali ke halaman login (reload penuh)
                        window.location.href = '/login';
                    }
                });
            }

            const gridItems = document.querySelectorAll('.more-grid .grid-item');
            if (gridItems.length > 0) {
                gridItems.forEach((item, index) => {
                    // Terapkan penundaan (delay) untuk setiap item
                    // 50ms * index = 0ms, 50ms, 100ms, dst.
                    setTimeout(() => {
                        item.classList.add('visible');
                    }, index * 50); // Penundaan 50ms per item
                });
            }

        }

        // === BAGIAN 3: LOGIKA SPA ROUTING (DENGAN PERBAIKAN) ===
        
        const pageContainer = document.getElementById('app-container');
        const isBlobEnvironment = window.location.protocol === 'blob:';

        function runPageInit(path) {
            if (path === '/') { initMainPage(); } 
            else if (path === '/wallet') { initWalletPage(); } 
            else if (path === '/create') { initCreatePage(); }
            else if (path === '/more') { initMorePage(); }
            else if (path === '/analysis') { initAnalysisPage(); }
        }

        function executePageScript(newContentElement) {
            const oldScript = document.getElementById('page-specific-script');
            if (oldScript) {
                oldScript.parentNode.removeChild(oldScript);
            }
            const scriptTemplate = newContentElement.querySelector('script[type="text/javascript-template"]');
            if (scriptTemplate) {
                try {
                    const newScript = document.createElement('script');
                    newScript.id = 'page-specific-script';
                    newScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(newScript);
                } catch (e) {
                    console.error("Error executing page script:", e);
                }
            }
        }
        
        async function navigate(path) {
            if (isBlobEnvironment) { 
                const targetUrl = new URL(path, window.location.origin);
                window.location.href = targetUrl.href;
                return; 
            }
            
            if (!pageContainer) return;
            try {
                const response = await fetch(path, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) { window.location.href = path; return; }
                const newContent = await response.text();
                
                history.pushState({ path }, '', path);
                pageContainer.innerHTML = newContent;
                executePageScript(pageContainer);
                runPageInit(path);

            } catch (error) {
                console.error("Gagal melakukan navigasi:", error);
                window.location.href = path;
            }
        }

        document.addEventListener('click', (event) => {
            const anchor = event.target.closest('a');
            if (anchor && anchor.href && new URL(anchor.href).origin === location.origin) {
                event.preventDefault();
                const path = new URL(anchor.href).pathname;
                if (path !== location.pathname) {
                    navigate(path);
                }
            }
        });

        window.addEventListener('popstate', (event) => {
            if (isBlobEnvironment) return; 
            if (event.state && event.state.path) {
                (async () => {
                    if (!pageContainer) return;
                    try {
                        const response = await fetch(event.state.path, { headers: { 'X-Requested-with': 'XMLHttpRequest' } });
                        if (!response.ok) { window.location.href = event.state.path; return; }
                        const newContent = await response.text();
                        pageContainer.innerHTML = newContent;
                        executePageScript(pageContainer);
                        runPageInit(event.state.path);
                    } catch (error) {
                         console.error("Gagal memuat state:", error);
                         window.location.href = event.state.path;
                    }
                })();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // [PERBAIKAN KUNCI] Pengecekan keamanan untuk session token
            const sessionToken = localStorage.getItem('sessionToken');
            const isAuthPage = window.location.pathname === '/login' || 
                               window.location.pathname === '/create-account' || 
                               window.location.pathname === '/two-step' ||
                               window.location.pathname === '/auth/callback';

            if (sessionToken && isAuthPage) {
                window.location.href = '/';
                return;
            }

            if (!sessionToken && !isAuthPage) {
                window.location.href = '/login';
                return;
            }
            // --- [Akhir Perbaikan Keamanan] ---


            if (!isBlobEnvironment) {
                history.replaceState({ path: location.pathname }, '', location.pathname);
            }
            
            applyTheme(getSettings().theme);
            executePageScript(pageContainer); 

            // [PERBAIKAN KUNCI]
            // Jika kita di halaman aplikasi (bukan login/register),
            // kita panggil 'initializeAppData' yang akan mengambil data
            // DAN BARU memanggil 'runPageInit' setelahnya.
            if (!isAuthPage) {
                initializeAppData(); // <-- PANGGIL FUNGSI BARU INI
            } else {
                runPageInit(location.pathname); // Halaman auth (login, dll) bisa langsung jalan
            }
        });
    </script>
</body>
</html>

