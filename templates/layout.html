<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casflo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        };

        (function() {
            const settingsKey = 'casflo';
            let theme = 'system';
            try {
                const settings = localStorage.getItem(settingsKey);
                if (settings) {
                    theme = JSON.parse(settings).theme || 'system';
                }
            } catch (e) {}
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === CSS GLOBAL === */
        :root {
            --primary-blue: #4A47A3;
            --light-purple: #E6E6FA;
            --text-dark: #333;
            --text-light: #888;
            --expense-red: #E84545;
            --income-green: #51CF66;
            --bg-gray: #f4f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html { height: -webkit-fill-available; }
        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            touch-action: manipulation; 
        }
        .app-container { 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        }
        .main-header { background: var(--primary-blue); color: white; padding: 20px 20px 20px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; flex-shrink: 0; z-index: 10; margin-bottom: -20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-top .left { display: flex; align-items: center; gap: 18px; }
        .view-toggle-group { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 4px; }
        .toggle-btn { background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 16px; display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .toggle-btn.active-view { background: rgba(255,255,255,0.2); }
        .toggle-btn span { display: inline-block; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out, margin-left 0.3s ease-in-out; max-width: 100px; opacity: 1; margin-left: 5px; overflow: hidden; }
        .toggle-btn:not(.active-view) span { max-width: 0; opacity: 0; margin-left: 0; }
        .toggle-btn:not(.active-view) { padding: 8px 10px; }
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .header-actions { display: flex; gap: 15px; }
        .action-box { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; flex: 1; }
        .action-box .icon { background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .action-box .text { font-size: 14px; }
        .main-content { flex: 1; overflow-y: auto; padding: 0 20px; position: relative; z-index: 5; padding-bottom: 100px; }
        .card { background: white; border-radius: 18px; margin-bottom: 20px; margin-top: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); padding: 18px; }
        .empty-transaction-list { text-align: center; color: #888; padding: 40px 0; }
        .view-hidden { display: none; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }
        .overview-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overview-card .card-header .icon { width: 40px; height: 40px; background: var(--light-purple); color: var(--primary-blue); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .overview-card .date-selector { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .overview-card .date-selector i { cursor: pointer; }
        .overview-card .card-actions { display: flex; gap: 12px; }
        .overview-card .card-actions .icon { color: var(--text-light); }
        .overview-card .card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; padding-top: 5px; }
        .overview-card .stat-item .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .overview-card .stat-item .amount { font-size: 16px; font-weight: 700; }
        .overview-card .stat-item .amount.expense { color: var(--expense-red); }
        .calendar-card .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 600; }
        .calendar-card .calendar-header i { cursor: pointer; }
        .calendar-card .calendar-header .month-year { font-size: 16px; }
        .calendar-card .calendar-header .btn-month-toggle { background-color: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; }
        .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day { font-size: 14px; padding: 5px 0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; cursor: pointer; }
        .calendar-grid .day.weekend { color: var(--expense-red); }
        .calendar-grid .day.selected .date-number { background-color: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .calendar-grid .day .day-summary { font-size: 8px; color: white; background-color: var(--expense-red); border-radius: 5px; padding: 1px 3px; position: absolute; bottom: 0; }
        .calendar-summary-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid var(--bg-gray); padding-bottom: 20px; }
        .calendar-summary-tabs .tab { background: none; border: 1px solid #ddd; border-radius: 20px; padding: 6px 15px; font-size: 13px; color: var(--text-light); cursor: pointer; }
        .calendar-summary-tabs .tab.active { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-purple); }
        .calendar-summary-amounts { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .calendar-summary-amounts .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .calendar-summary-amounts .amount { font-size: 16px; font-weight: 700; }
        .calendar-summary-amounts .amount.expense { color: var(--expense-red); }
        .transaction-list .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer; user-select: none; }
        .transaction-list .list-header .date-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .transaction-list .list-header .summary { font-size: 13px; color: var(--text-light); }
        .transaction-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid var(--bg-gray); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:first-of-type { padding-top: 5px; }
        .transaction-item .icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .category { font-weight: 600; font-size: 15px; }
        .transaction-item .details .notes { font-size: 12px; color: var(--text-light); }
        .transaction-item .info { text-align: right; }
        .transaction-item .info .amount { font-weight: 700; color: var(--expense-red); font-size: 15px; }
        .transaction-item .info .account { font-size: 12px; color: var(--text-light); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; color: var(--primary-blue); z-index: 15; text-decoration: none; }
        .fab i { font-size: 22px; }
        .add-view-container { background-color: #f8f9fa; }
        .add-view { display: flex; flex-direction: column; height: 100svh;display: flex; flex-direction: column; height: 100vh; height: 100svh; background-color: white; max-width: 480px; margin: 0 auto;}
        .add-header { padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background-color: white; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .type-selector-header { display: flex; background: #f8f9fa; border-radius: 25px; padding: 3px; }
        .type-btn-header { padding: 8px 16px; border: none; background: transparent; border-radius: 22px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-light); }
        .type-btn-header.active { background: white; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .type-btn-header.expense.active { color: var(--expense-red); }
        .type-btn-header.income.active { color: var(--income-green); }
        .categories-section { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: white; min-height: 0; }
        .category-group { margin-bottom: 20px; }
        .group-title { font-size: 12px; color: var(--text-light); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .category-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; }
        .category-item:hover { background: #f8f9fa; }
        .category-item.selected { background: var(--primary-blue); color: white; }
        .category-item.selected .category-icon { background: rgba(255,255,255,0.2) !important; color: white !important; }
        .category-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 20px; }
        .category-name { font-size: 11px; text-align: center; }
        .calculator-section { background: #f8f9fa; padding: 15px; border-top: 1px solid #e9ecef; flex-shrink: 0; display: grid; grid-template-rows: repeat(6, 1fr); gap: 8px; }
        .amount-container { display: flex; gap: 8px; }
        .account-card { aspect-ratio: 1 / 1; height: 100%; background: var(--primary-blue); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 102, 234, 0.3); }
        .account-card i { color: white; font-size: 24px; }
        .amount-display { flex-grow: 1; background: white; padding: 0 12px; border-radius: 10px; text-align: right; font-size: 28px; font-weight: 700; display: flex; align-items: center; justify-content: flex-end; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 100%; }
        .top-action-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .action-btn { background: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 24px; }
        .action-btn.personal { background: #f8f9fa; color: #6c757d; }
        .action-btn.today { background: #e3f2fd; color: #1976d2; }
        .action-btn.add { background: var(--income-green); color: white; }
        .action-btn.check { background: var(--income-green); color: white; }
        .action-btn.equals { background: var(--primary-blue); color: white; }
        .calc-grid { grid-row: 3 / 7; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; grid-auto-rows: 1fr; }
        .calc-btn { background: white; border: none; border-radius: 10px; font-size: 24px; font-weight: 600; cursor: pointer; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .calc-btn .fas { font-size: 24px; }
        .calc-btn.operator { background: #f1f3f5; color: #495057; }
        .calc-btn.delete { background: #ffe3e3; color: var(--expense-red); }
        .transaction-list .list-header .date-info i { transition: transform 0.2s ease-in-out; }
        .transaction-group.collapsed .list-header .date-info i { transform: rotate(-90deg); }
        .transaction-items-container { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.2s ease-out, transform 0.3s ease-out; opacity: 1; transform: translateY(0); }
        .transaction-group.collapsed .transaction-items-container { max-height: 0; opacity: 0; transform: translateY(-10px); }
        .wallet-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: flex-end; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .wallet-modal-overlay.visible { display: flex; }
        .wallet-modal-content { background: white; color: #333; width: 100%; max-width: 480px; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; animation: slideUp 0.3s ease-out; max-height: 50vh; overflow-y: auto; }
        .wallet-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .wallet-modal-header h3 { font-size: 18px; font-weight: 600; }
        .wallet-modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #888; }
        .wallet-list-item { display: flex; align-items: center; padding: 15px 10px; border-radius: 12px; cursor: pointer; font-weight: 500; }
        .wallet-list-item:hover { background-color: #f4f5f9; }
        .wallet-list-item.active { background-color: var(--light-purple); color: var(--primary-blue); font-weight: 700; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        #toggleMaskBtn { transition: background-color 0.2s, opacity 0.2s; border-radius: 50%; }
        #toggleMaskBtn:hover { opacity: 0.7; }
        .balance-masked #toggleMaskBtn { background-color: rgba(0,0,0,0.2); }
        .icon-eye-closed, .balance-masked .icon-eye-open { display: none; }
        .balance-masked .icon-eye-closed { display: inline-block; }
        .balance-masked .data-maskable-amount { color: transparent !important; position: relative; transition: all 0.1s; }
        .balance-masked .data-maskable-amount::before { content: "Rp******"; color: var(--text-dark); position: absolute; left: 0; right: 0; }
        .balance-masked .data-maskable-amount.expense::before { color: var(--expense-red); }
        .balance-masked .transaction-item .info .amount { color: transparent !important; position: relative; }
        .balance-masked .transaction-item .info .amount::before { content: "Rp******"; position: absolute; right: 0; }
        .balance-masked .transaction-item .info .amount[data-masked-color="income"]::before { color: var(--income-green); }
        .balance-masked .transaction-item .info .amount[data-masked-color="expense"]::before { color: var(--expense-red); }
        .tx-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1001; animation: fadeIn 0.3s ease; padding: 20px; }
        .tx-modal-overlay.visible { display: flex; }
        .tx-modal-content { background: white; color: var(--text-dark); width: 100%; max-width: 400px; border-radius: 20px; animation: slideUp 0.3s ease-out; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .tx-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8f9fa; }
        .tx-modal-header button { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-light); padding: 5px; }
        .tx-modal-header .tx-modal-actions { display: flex; gap: 20px; }
        .tx-modal-header .tx-modal-actions button { color: var(--primary-blue); }
        .tx-modal-header .tx-modal-actions #tx-modal-delete-btn { color: var(--expense-red); }
        .tx-modal-body { padding: 20px 25px 30px 25px; }
        .tx-modal-category { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
        .tx-modal-category #tx-modal-icon { width: 50px; height: 50px; font-size: 24px; }
        .tx-modal-category #tx-modal-category-name { font-size: 20px; font-weight: 600; color: var(--text-dark); }
        .tx-modal-amount { font-size: 28px; font-weight: 700; margin-bottom: 20px; }
        .tx-modal-details .detail-item { display: flex; justify-content: space-between; font-size: 14px; padding: 10px 0; border-bottom: 1px solid var(--bg-gray); }
        .tx-modal-details .detail-item span:first-child { color: var(--text-light); }
        .tx-modal-details .detail-item span:last-child { font-weight: 500; }
        .tx-modal-details .detail-item.notes { flex-direction: column; align-items: flex-start; gap: 5px; border-bottom: none; }
        .transaction-group { overflow: hidden; }
        .transaction-item-wrapper { position: relative; background-color: var(--expense-red); border-radius: 12px; margin-bottom: 1px; }
        .transaction-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 1; width: 80px; }
        .transaction-item-actions .delete-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 100%; height: 100%; }
        .transaction-item-content { position: relative; background-color: white; border-radius: 12px; transition: transform 0.3s ease-out; z-index: 2; cursor: pointer; }
        
        /* === [BARU] CSS UNTUK SKELETON LOADER === */
        /* 1. Base style untuk SEMUA bar skeleton */
        .skeleton-bar {
            background-color: #e0e0e0;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        /* 2. Animasi Shimmer (Kilap) */
        .skeleton-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6),
                transparent
            );
            animation: shimmer 1.5s infinite linear;
        }
        /* 3. Keyframes untuk animasi */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        /* 4. Ukuran Teks (untuk konsistensi) */
        .skeleton-text-kecil { height: 14px; margin-top: 6px; }
        .skeleton-text-sedang { height: 18px; }
        .skeleton-text-besar { height: 24px; }
        /* 5. SKELETON HEADER ("Manda") */
        .skeleton-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: var(--primary-blue);
            gap: 18px;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: -20px; /* Menarik konten ke atas */
        }
        .skeleton-header-left { display: flex; align-items: center; gap: 18px; }
        .skeleton-icon-small { width: 20px; height: 20px; }
        .skeleton-header-title { width: 100px; height: 20px; }
        .skeleton-header-right { display: flex; align-items: center; gap: 10px; }
        .skeleton-toggle-btn { width: 150px; height: 36px; border-radius: 20px; }
        .skeleton-theme-btn { width: 32px; height: 32px; border-radius: 50%; }
        .skeleton-header-wrapper .skeleton-bar {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .skeleton-header-wrapper .skeleton-bar::before {
            background: linear-gradient(
                90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent
            );
        }
        /* 6. SKELETON RINGKASAN (Total, Pemasukan, dll) */
        .skeleton-ringkasan-wrapper {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
            padding: 18px;
            background-color: #ffffff;
            border-radius: 18px;
            margin-top: 20px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.06);
        }
        .skeleton-ringkasan-kolom {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        /* 7. SKELETON DAFTAR TRANSAKSI (Pendidikan, Makan) */
        .skeleton-transaksi-wrapper {
            background-color: #ffffff;
            border-radius: 18px;
            padding: 18px;
            margin-top: 20px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.06);
        }
        .skeleton-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .skeleton-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .skeleton-list-item:last-child { border-bottom: none; }
        .skeleton-icon-kategori {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            flex-shrink: 0;
        }
        .skeleton-item-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .skeleton-item-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }
        
        /* === [BARU] CSS MODE GELAP UNTUK SEMUA === */
        .dark body { background-color: #111827; color: #d1d5db; }
        .dark .app-container { background-color: #111827; }
        .dark .card { background-color: #374151; border: 1px solid #4b5563; box-shadow: none; }
        .dark .main-content { background-color: #111827; }
        .dark .transaction-list, .dark .empty-transaction-list { background-color: #374151; color: #d1d5db; }
        .dark .transaction-item { border-bottom-color: #4b5563; }
        .dark .overview-card .stat-item .label, .dark .transaction-item .info .account, .dark .transaction-item .details .notes { color: #9ca3af; }
        .dark .overview-card .date-selector, .dark .header-title, .dark .header-top .left .fa-search { color: white; }
        .dark .calendar-card, .dark .calendar-summary-tabs .tab { color: #d1d5db; border-color: #4b5563; }
        .dark .calendar-summary-tabs .tab.active { color: var(--primary-blue); background-color: var(--light-purple); border-color: var(--primary-blue); }
        .dark .bottom-nav { background-color: #1f2937; border-top: 1px solid #374151; }
        .dark .nav-item { color: #9ca3af; }
        .dark .nav-item.active { color: #ffffff; }
        .dark .fab { background-color: #374151; color: #ffffff; border: 1px solid #4b5563; }
        .dark .overview-card .stat-item .amount, .dark .transaction-item .details .category { color: white; }
        .dark .overview-card .stat-item .amount.expense { color: var(--expense-red); }
        .dark .add-view-container { background-color: #1f2937; }
        .dark .add-header, .dark .categories-section { background-color: #374151; border-bottom-color: #4b5563; }
        .dark .type-selector-header { background: #1f2937; }
        .dark .type-btn-header { color: #9ca3af; }
        .dark .type-btn-header.active { background: #374151; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .dark .type-btn-header.expense.active { color: var(--expense-red); }
        .dark .type-btn-header.income.active { color: var(--income-green); }
        .dark .calculator-section { background: #1f2937; border-top-color: #4b5563; }
        .dark .amount-display, .dark .action-btn, .dark .calc-btn { background: #374151; color: #d1d5db; box-shadow: none; }
        .dark .action-btn.personal { background: #111827; }
        .dark .calc-btn.operator { background: #4b5563; color: #d1d5db; }
        .dark .calc-btn.delete { background: #5a2a2a; color: var(--expense-red); }
        .dark .category-item:hover { background: #4b5563; }
        .dark .wallet-modal-content { background-color: #374151; color: #d1d5db; }
        .dark .wallet-list-item:hover { background-color: #4b5563; }
        .dark .wallet-list-item.active { background-color: var(--primary-blue); color: white; }
        .dark .balance-masked .data-maskable-amount::before { color: #d1d5db; }
        .dark .balance-masked .data-maskable-amount.expense::before { color: var(--expense-red); }
        .dark .balance-masked .transaction-item .info .amount[data-masked-color="income"]::before { color: var(--income-green); }
        .dark .balance-masked .transaction-item .info .amount[data-masked-color="expense"]::before { color: var(--expense-red); }
        .dark .tx-modal-content { background-color: #374151; color: #d1d5db; }
        .dark .tx-modal-header { background-color: #1f2937; }
        .dark .tx-modal-category #tx-modal-category-name { color: white; }
        .dark .tx-modal-details .detail-item { border-bottom-color: #4b5563; }
        .dark .tx-modal-details .detail-item span:first-child { color: #9ca3af; }
        .dark .tx-modal-details .detail-item.notes span:first-child { color: #9ca3af; }
        .dark .tx-modal-details .detail-item.notes span:last-child { color: #d1d5db; }
        .dark .transaction-item-wrapper { background-color: var(--expense-red); }
        .dark .transaction-item-content { background-color: #374151; }
        
        /* [BARU] CSS Mode Gelap untuk SKELETON */
        .dark .skeleton-bar {
            background-color: #4b5563; /* dark:bg-gray-600 */
        }
        .dark .skeleton-bar::before {
            background: linear-gradient(
                90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), /* Shimmer lebih gelap */
                transparent
            );
        }
        .dark .skeleton-ringkasan-wrapper,
        .dark .skeleton-transaksi-wrapper {
            background-color: #374151; /* dark:bg-gray-700 */
            border-color: #4b5563;
        }
        .dark .skeleton-list-header {
            border-bottom-color: #4b5563;
        }
        .dark .skeleton-list-item {
            border-bottom-color: #4b5563;
        }

        /* CSS Media Query (Tidak Berubah) */
        @media (min-width: 768px) {
            body { background-color: #e9ecef; }
            .app-container { max-width: 480px; margin: 0 auto; height: 100vh; }
            .add-view { max-width: 480px; }
            .calculator-section { padding: 20px; gap: 12px; }
            .amount-display { font-size: 36px; }
            .calc-btn, .action-btn { font-size: 28px; min-height: 50px; border-radius: 12px; }
            .calc-btn .fas { font-size: 28px; }
            .dark body { background-color: #111827; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        {{PAGE_CONTENT}}
    </div>

    <div id="wallet-modal-overlay" class="wallet-modal-overlay" onclick="closeWalletSwitcher()">
        <div class="wallet-modal-content" onclick="event.stopPropagation()">
            <div class="wallet-modal-header">
                <h3>Pilih Dompet</h3>
                <button class="wallet-modal-close" onclick="closeWalletSwitcher()">&times;</button>
            </div>
            <div id="wallet-list-container"></div>
        </div>
    </div>
    <div id="tx-modal-overlay" class="tx-modal-overlay" onclick="closeTransactionModal()">
        <div class="tx-modal-content" onclick="event.stopPropagation()">
            <div class="tx-modal-header">
                <button class="tx-modal-close" onclick="closeTransactionModal()"><i class="fas fa-times"></i></button>
                <div class="tx-modal-actions">
                    <button id="tx-modal-delete-btn"><i class="fas fa-trash"></i></button>
                    <button id="tx-modal-edit-btn"><i class="fas fa-edit"></i></button>
                </div>
            </div>
            <div class="tx-modal-body">
                <div class="tx-modal-category">
                    <span id="tx-modal-icon" class="category-icon" style="background: var(--light-purple);">üçî</span>
                    <span id="tx-modal-category-name">Nama Kategori</span>
                </div>
                <div class="tx-modal-amount" id="tx-modal-amount">-Rp8.000</div>
                <div class="tx-modal-details">
                    <div class="detail-item">
                        <span>Tanggal:</span>
                        <span id="tx-modal-date">5/11/2025 15.40.19</span>
                    </div>
                    <div class="detail-item">
                        <span>Akun:</span>
                        <span id="tx-modal-account">akun bawaan</span>
                    </div>
                    <div class="detail-item">
                        <span>Buku:</span>
                        <span id="tx-modal-wallet">Manda</span>
                    </div>
                    <div class="detail-item notes">
                        <span>Catatan:</span>
                        <span id="tx-modal-notes">Belanja</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Cek token di awal
        const sessionToken = localStorage.getItem('sessionToken');
        // Pengecekan halaman autentikasi diperluas
        const isAuthPage = ['/login', '/create-account', '/two-step', '/auth/callback', '/create-wallet'].includes(window.location.pathname);
        
        if (!sessionToken && !isAuthPage) {
            window.location.href = '/login';
        }
        if (sessionToken && isAuthPage) {
            window.location.href = '/';
        }
        
        // === BAGIAN 0: LOGIKA MODE GELAP & PENGATURAN ===
        const settingsKey = 'casflo'; 
        const htmlEl = document.documentElement;
        
        function getSettings() { try { const settings = localStorage.getItem(settingsKey); return settings ? JSON.parse(settings) : { theme: 'system' }; } catch (e) { return { theme: 'system' }; } }
        function saveSettings(settingsObject) { try { const existingSettings = getSettings(); const newSettings = { ...existingSettings, ...settingsObject }; localStorage.setItem(settingsKey, JSON.stringify(newSettings)); } catch (e) { console.error("Gagal menyimpan settings:", e); } }
        function applyTheme(theme) { if (theme === 'dark') { htmlEl.classList.add('dark'); } else if (theme === 'light') { htmlEl.classList.remove('dark'); } else { if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { htmlEl.classList.add('dark'); } else { htmlEl.classList.remove('dark'); } } }
        function applyMaskingState(isMasked) { const container = document.getElementById('app-container'); if (container) { container.classList.toggle('balance-masked', isMasked); } }
        function toggleBalanceMasking() { let settings = getSettings(); const newMaskedState = !settings.isBalanceMasked; saveSettings({ isBalanceMasked: newMaskedState }); applyMaskingState(newMaskedState); console.log(`Masking saldo: ${newMaskedState}`); }
        function attachThemeToggle(selector) { const themeToggleBtn = document.querySelector(selector); if (themeToggleBtn) { themeToggleBtn.addEventListener('click', () => { const isCurrentlyDark = htmlEl.classList.contains('dark'); const newTheme = isCurrentlyDark ? 'light' : 'dark'; applyTheme(newTheme); saveSettings({ theme: newTheme }); }); } }


        // === BAGIAN 1: VARIABEL & FUNGSI GLOBAL ===
        let currentDate = new Date();
        let selectedDate = new Date();
        let allCategories = []; // Akan diisi oleh loadHeaderData
        let allAccounts = []; // Akan diisi oleh loadHeaderData
        let selectedAccountId = null;
        let transactions = []; // Akan diisi oleh loadMonthlyData
        let currentView = 'overview';
        let calendarFilter = 'expense';
        let currentType = 'expense';
        let calcValue = '0';
        let waitingForEquals = false;
        let currentTransactionId = null;
        let activeSwipeElement = null;
        let touchStartX = 0, touchCurrentX = 0, touchStartY = 0, isSwiping = false, swipeThreshold = -60;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        
        // === [BARU] BAGIAN 2: LOGIKA PEMUATAN DATA INDEPENDEN ===

        /**
         * Fungsi helper untuk memanggil API Anda dengan otentikasi.
         */
        async function fetchApi(endpoint, options = {}) {
            const token = localStorage.getItem('sessionToken');
            if (!token) {
                console.log("Token tidak ditemukan, mengarahkan ke login.");
                navigate('/login');
                throw new Error('Sesi tidak valid');
            }
            const defaultHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };
            const response = await fetch(`https://api.casflo.id/api/v1${endpoint}`, config);

            if (response.status === 401) {
                localStorage.removeItem('sessionToken');
                console.log("Sesi 401, token dihapus.");
                navigate('/login');
                throw new Error('Sesi kedaluwarsa');
            }
            if (!response.ok) {
                const errorResult = await response.json();
                console.error("API Error:", errorResult);
                throw new Error(errorResult.error?.message || 'Gagal mengambil data dari API');
            }
            const result = await response.json(); 
            return result.data; 
        }

        /**
         * [BARU] 1. Memuat data Header (Dompet) & dependensi (Akun, Kategori).
         * Ini adalah fungsi pertama yang dijalankan.
         */
        async function loadHeaderData() {
            try {
                // 1. Ambil semua dompet milik user
                const wallets = await fetchApi('/wallets');
                if (!wallets || wallets.length === 0) {
                    console.warn('User tidak punya dompet. Mengarahkan ke /create-wallet');
                    window.location.href = '/create-wallet'; 
                    return;
                }

                // 2. Tentukan dompet aktif (dari localStorage atau ambil yang pertama)
                const preferredWalletId = localStorage.getItem('currentWalletId');
                let activeWallet = wallets.find(w => w.id === preferredWalletId) || wallets[0];
                
                // 3. Simpan dompet aktif yang valid ke localStorage
                localStorage.setItem('currentWalletId', activeWallet.id);
                localStorage.setItem('currentWalletName', activeWallet.name); 
                console.log(`Dompet aktif diatur: ${activeWallet.name} (${activeWallet.id})`);

                // 4. [INDEPENDEN] Ganti skeleton header dengan data asli
                renderHeader(activeWallet.name);

                // 5. [DEPENDENSI] Ambil akun dan kategori untuk dompet aktif INI SEKALI SAJA
                const [accounts, categories] = await Promise.all([
                    fetchApi(`/wallets/${activeWallet.id}/accounts`),
                    fetchApi(`/wallets/${activeWallet.id}/categories`)
                ]);

                allAccounts = accounts;
                allCategories = categories;

                if (allAccounts.length > 0) {
                    selectedAccountId = allAccounts.find(a => a.type === 'ASSET')?.id || allAccounts[0].id;
                }
                console.log(`Memuat ${allAccounts.length} akun dan ${allCategories.length} kategori.`);

                // 6. [PENTING] Picu pemuatan data bulanan (Ringkasan & Transaksi)
                // Ini akan berjalan secara independen SETELAH header dimuat.
                // Hanya panggil ini jika kita di halaman utama
                if (window.location.pathname === '/') {
                    loadMonthlyData();
                }

            } catch (error) {
                console.error("Gagal memuat data header:", error);
                // Tampilkan error di tempat skeleton header
                const headerContainer = document.getElementById('header-container');
                if (headerContainer) headerContainer.innerHTML = `<div style="padding: 20px; background: #E84545; color: white; text-align: center;">Gagal memuat dompet.</div>`;
            }
        }
        
        /**
         * [BARU] 2. Memuat data bulanan (Ringkasan & Transaksi).
         * Dipanggil oleh loadHeaderData() dan saat bulan diubah.
         */
        async function loadMonthlyData() {
            const walletId = localStorage.getItem('currentWalletId');
            if (!walletId) return; // Menunggu header dimuat

            // Tampilkan kembali skeleton saat berganti bulan
            renderSummaryCard(null); // 'null' akan merender skeleton
            renderTransactionList(null); // 'null' akan merender skeleton
            updateMonthDisplay(); // Perbarui tampilan tanggal

            console.log("Memuat data bulanan untuk", currentDate.toISOString().slice(0, 7));
            
            // Tentukan rentang tanggal
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const startDate = new Date(year, month, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

            try {
                // 1. Ambil transaksi dari API (HANYA SATU PANGGILAN API)
                const fetchedTransactions = await fetchApi(
                    `/wallets/${walletId}/transactions?startDate=${startDate}&endDate=${endDate}`
                );

                // 2. Konversi data API ke format 'transactions' global
                transactions = fetchedTransactions.map(tx => {
                    const isExpense = tx.category_type === 'EXPENSE'; 
                    return {
                        id: tx.id,
                        type: isExpense ? 'expense' : 'income',
                        amount: Math.abs(tx.amount),
                        category: tx.category_name,
                        notes: tx.description || 'Tanpa catatan',
                        account: tx.account_name, 
                        icon: tx.category_icon,
                        color: 'var(--light-purple)',
                        date: tx.transaction_date,
                        category_id: tx.category_id,
                        account_id: tx.account_id
                    };
                });
                
                // 3. Hitung ringkasan dari data transaksi
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const total = income - expense;
                const summaryData = { total, income, expense };

                // 4. [INDEPENDEN] Ganti skeleton ringkasan dengan data asli
                renderSummaryCard(summaryData);

                // 5. [INDEPENDEN] Ganti skeleton transaksi dengan data asli
                renderTransactionList(transactions.sort((a, b) => new Date(b.date) - new Date(a.date)));
                
                // 6. [PERBAIKAN] Update kalender jika sedang ditampilkan
                if (currentView === 'calendar') {
                    renderCalendar();
                }

            } catch (error) {
                console.error("Gagal memuat data bulanan:", error);
                // Tampilkan error di tempat skeleton
                renderSummaryCard({ error: true });
                renderTransactionList({ error: true });
            }
        }


        // === [BARU] BAGIAN 3: FUNGSI RENDER (PENGGANTI SKELETON) ===

        /**
         * [BARU] Mengganti skeleton header dengan HTML header asli.
         */
        function renderHeader(walletName) {
            const headerContainer = document.getElementById('header-container');
            if (!headerContainer) return;

            const shortName = walletName.length > 6 ? walletName.substring(0, 6) + '...' : walletName;

            headerContainer.innerHTML = `
                <header class="main-header">
                    <div class="header-top">
                        <div class="left">
                            <i class="fas fa-search"></i>
                            <div class="header-title" id="walletSwitcherBtn" style="cursor: pointer;">
                                <span id="currentWalletNameDisplay">${walletName}</span>
                                <i class="fas fa-chevron-down fa-xs"></i>
                            </div>
                        </div>
                        <div class="right" style="display: flex; align-items: center; gap: 10px;">
                            <button class="theme-toggle inline-flex h-8 w-8 items-center justify-center overflow-hidden rounded-full text-white transition-all *:pointer-events-none" style="background: rgba(0,0,0,0.2);">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 dark:hidden">
                                    <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="hidden h-5 dark:block">
                                    <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"></path>
                                </svg>
                            </button>
                            <div class="view-toggle-group">
                                <button class="toggle-btn" id="detailToggleBtn">
                                    <i class="fas fa-store"></i>
                                    <span>Detail</span>
                                </button>
                                <button class="toggle-btn" id="calendarToggleBtn">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Kalender</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <div class="action-box">
                            <div class="icon"><i class="fas fa-book"></i></div>
                            <span class="text" id="currentWalletNameShort">${shortName}</span>
                        </div>
                        <div class="action-box" id="createNewWalletBtn" style="cursor: pointer;">
                            <div class="icon"><i class="fas fa-plus"></i></div>
                            <span class="text">Baru B...</span>
                        </div>
                    </div>
                </header>
            `;
            
            // [PENTING] Pasang ulang listener ke elemen-elemen baru
            attachThemeToggle('.theme-toggle');
            document.getElementById('walletSwitcherBtn')?.addEventListener('click', openWalletSwitcher);
            document.getElementById('createNewWalletBtn')?.addEventListener('click', () => navigate('/create-wallet'));
            document.getElementById('detailToggleBtn')?.addEventListener('click', () => setView('overview'));
            document.getElementById('calendarToggleBtn')?.addEventListener('click', () => setView('calendar'));
            
            // Terapkan view yang benar (terakhir disimpan)
            const savedView = localStorage.getItem('preferredView');
            setView(savedView || 'overview');
        }

        /**
         * [BARU] Mengganti skeleton ringkasan dengan HTML asli (atau skeleton lagi).
         */
        function renderSummaryCard(data) {
            const summaryContainer = document.getElementById('summary-card-container');
            if (!summaryContainer) return;

            let htmlToRender;
            if (data === null) {
                // Tampilkan Skeleton (saat ganti bulan)
                htmlToRender = `
                <div class="card overview-card skeleton-ringkasan-wrapper">
                    <div class="skeleton-ringkasan-kolom">
                        <div class="skeleton-bar skeleton-text-kecil" style="width: 50px;"></div>
                        <div class="skeleton-bar skeleton-text-besar" style="width: 100px;"></div>
                    </div>
                    <div class="skeleton-ringkasan-kolom">
                        <div class="skeleton-bar skeleton-text-kecil" style="width: 80px;"></div>
                        <div class="skeleton-bar skeleton-text-besar" style="width: 100px;"></div>
                    </div>
                    <div class="skeleton-ringkasan-kolom">
                        <div class="skeleton-bar skeleton-text-kecil" style="width: 80px;"></div>
                        <div class="skeleton-bar skeleton-text-besar" style="width: 100px;"></div>
                    </div>
                </div>`;
            } else if (data.error) {
                // Tampilkan Error
                htmlToRender = `<div class="card overview-card" style="color: var(--expense-red); text-align: center;">Gagal memuat ringkasan.</div>`;
            } else {
                // Tampilkan Data Asli
                const formatCurrency = (value) => { 
                    const num = Number(value) || 0;
                    const sign = num < 0 ? '-' : ''; 
                    return `${sign}Rp${Math.abs(num).toLocaleString('id-ID')}`; 
                };
                
                htmlToRender = `
                <div class="card overview-card" id="overviewCard">
                    <div class="card-header">
                        <div class="icon" id="mainBookIconBtn" style="cursor: pointer;"><i class="fas fa-book-open"></i></div>
                        <div class="date-selector">
                            <i class="fas fa-chevron-left" id="prevMonthBtn"></i>
                            <span id="currentMonthDisplay">...</span>
                            <i class="fas fa-chevron-right" id="nextMonthBtn"></i>
                        </div>
                        <div class="card-actions">
                            <div class="icon"><i class="fas fa-envelope"></i></div>
                            <div class="icon" id="toggleMaskBtn" style="cursor: pointer;">
                                <i class="fas fa-eye icon-eye-open"></i>
                                <i class="fas fa-eye-slash icon-eye-closed"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="stat-item">
                            <div class="label"><i class="fas fa-wallet fa-xs"></i><span>Total</span></div>
                            <div class="amount expense data-maskable-amount" id="totalAmount">${formatCurrency(data.total)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label"><i class="fas fa-arrow-down fa-xs"></i><span>Penghasilan</span></div>
                            <div class="amount data-maskable-amount" id="incomeAmount">${formatCurrency(data.income)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label"><i class="fas fa-arrow-up fa-xs"></i><span>Pengeluaran</span></div>
                            <div class="amount expense data-maskable-amount" id="expenseAmount">${formatCurrency(data.expense)}</div>
                        </div>
                    </div>
                </div>`;
            }

            summaryContainer.innerHTML = htmlToRender;
            
            // Pasang ulang listener untuk elemen-elemen baru
            if (data && !data.error) {
                document.getElementById('prevMonthBtn')?.addEventListener('click', goToPrevMonth);
                document.getElementById('nextMonthBtn')?.addEventListener('click', goToNextMonth);
                document.getElementById('mainBookIconBtn')?.addEventListener('click', openWalletSwitcher);
                document.getElementById('toggleMaskBtn')?.addEventListener('click', toggleBalanceMasking);
            }
            
            // Terapkan status masking & view yang ada
            applyMaskingState(getSettings().isBalanceMasked || false);
            setView(currentView);
        }
        
        /**
         * [BARU] Mengganti skeleton transaksi dengan daftar asli (atau skeleton lagi).
         */
        function renderTransactionList(data) {
            const listContainer = document.getElementById('transaction-list-container');
            if (!listContainer) return;
            
            let htmlToRender;

            if (data === null) {
                // Tampilkan Skeleton (saat ganti bulan)
                htmlToRender = `
                <div class="card transaction-list skeleton-transaksi-wrapper">
                    <div class="skeleton-list-header">
                        <div class="skeleton-bar skeleton-text-sedang" style="width: 120px;"></div>
                        <div class="skeleton-bar skeleton-text-kecil" style="width: 150px;"></div>
                    </div>
                    <div class="skeleton-list-item">
                        <div class="skeleton-bar skeleton-icon-kategori"></div>
                        <div class="skeleton-item-details">
                            <div class="skeleton-bar skeleton-text-sedang" style="width: 60%;"></div>
                            <div class="skeleton-bar skeleton-text-kecil" style="width: 40%;"></div>
                        </div>
                        <div class="skeleton-item-info">
                            <div class="skeleton-bar skeleton-text-sedang" style="width: 90px;"></div>
                            <div class="skeleton-bar skeleton-text-kecil" style="width: 60px;"></div>
                        </div>
                    </div>
                    <div class="skeleton-list-item">
                        <div class="skeleton-bar skeleton-icon-kategori"></div>
                        <div class="skeleton-item-details">
                            <div class="skeleton-bar skeleton-text-sedang" style="width: 50%;"></div>
                            <div class="skeleton-bar skeleton-text-kecil" style="width: 30%;"></div>
                        </div>
                        <div class="skeleton-item-info">
                            <div class="skeleton-bar skeleton-text-sedang" style="width: 80px;"></div>
                            <div class="skeleton-bar skeleton-text-kecil" style="width: 50px;"></div>
                        </div>
                    </div>
                </div>`;
            
            } else if (data.error) {
                // Tampilkan Error
                htmlToRender = `<div class="card transaction-list empty-transaction-list" style="color: var(--expense-red);">Gagal memuat transaksi.</div>`;
            
            } else if (data.length === 0) {
                // Tampilkan Pesan Kosong
                htmlToRender = `<div class="card transaction-list empty-transaction-list">Belum ada transaksi di bulan ini</div>`;
            
            } else {
                // Tampilkan Data Asli
                const collapsedGroups = getCollapsedGroups();
                const grouped = data.reduce((acc, tx) => {
                    const dateKey = new Date(tx.date).toDateString();
                    if (!acc[dateKey]) acc[dateKey] = [];
                    acc[dateKey].push(tx);
                    return acc;
                }, {});
                const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

                htmlToRender = `<div class="card transaction-list">`;
                for (const dateKey of sortedDates) {
                    const txsOnThisDate = grouped[dateKey];
                    const date = new Date(dateKey);
                    const totalExpenseOnDate = txsOnThisDate.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    
                    const isCollapsed = collapsedGroups.includes(dateKey);
                    
                    htmlToRender += `
                    <div class="transaction-group ${isCollapsed ? 'collapsed' : ''}">
                        <div class="list-header" onclick="toggleGroupCollapse('${dateKey}', this)">
                            <div class="date-info">
                                <i class="fas fa-chevron-down fa-xs"></i>
                                <span>${date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: '2-digit' })}</span>
                            </div>
                            <div class="summary">Pengeluaran: Rp${(totalExpenseOnDate).toLocaleString('id-ID')}</div>
                        </div>
                        <div class="transaction-items-container">
                    `;
                    
                    txsOnThisDate.forEach(t => {
                        const icon = t.icon || t.category.charAt(0).toUpperCase();
                        const amountColor = t.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)';
                        const amountPrefix = t.type === 'expense' ? '-' : '';
                        
                        // [PENTING] Simpan data JSON di elemen untuk modal & swipe
                        const txDataString = JSON.stringify(t).replace(/"/g, '&quot;');

                        htmlToRender += `
                        <div class="transaction-item-wrapper">
                            <div class="transaction-item-actions">
                                <button class="delete-btn" onclick="event.stopPropagation(); handleDeleteTransaction('${t.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="transaction-item-content transaction-item" 
                                 data-tx-json="${txDataString}"
                                 ontouchstart="handleTouchStart(event)"
                                 ontouchmove="handleTouchMove(event)"
                                 ontouchend="handleTouchEnd(event)"
                                 ontouchcancel="handleTouchEnd(event)"
                                 onclick="handleItemClick(this)">
                                
                                <div class="icon" style="background-color: ${t.color};"><span>${icon}</span></div>
                                <div class="details">
                                    <div class="category">${t.category}</div>
                                    <div class="notes">${t.notes}</div>
                                </div>
                                <div class="info">
                                    <div class="amount data-maskable-amount" 
                                         style="color: ${amountColor}" 
                                         data-masked-color="${t.type}">
                                        ${amountPrefix}Rp${(t.amount).toLocaleString('id-ID')}
                                    </div>
                                    <div class="account">${t.account}</div>
                                </div>
                            </div>
                        </div>`;
                    });

                    htmlToRender += `</div></div>`; // Tutup items-container & transaction-group
                }
                htmlToRender += `</div>`; // Tutup transaction-list
            }

            listContainer.innerHTML = htmlToRender;
            
            // Terapkan status masking
            applyMaskingState(getSettings().isBalanceMasked || false);
        }


        // === BAGIAN 4: FUNGSI UTILITAS & FUNGSI HALAMAN LAMA (DIMODIFIKASI) ===

        function updateMonthDisplay() { 
            const display = document.getElementById('currentMonthDisplay');
            const calendarDisplay = document.getElementById('calendarMonthYear');
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            if (display) {
                display.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;
            }
            if (calendarDisplay) {
                 calendarDisplay.textContent = `${monthNames[month]} ${year}`;
            }
        }
        function goToPrevMonth() { 
            currentDate.setMonth(currentDate.getMonth() - 1); 
            loadMonthlyData(); // [PENTING] Panggil pemuat data baru
        }
        function goToNextMonth() { 
            currentDate.setMonth(currentDate.getMonth() + 1); 
            loadMonthlyData(); // [PENTING] Panggil pemuat data baru
        }
        
        function setView(viewName) { 
            currentView = viewName;
            localStorage.setItem('preferredView', viewName);
            const overviewContainer = document.getElementById('summary-card-container');
            const calendarCard = document.getElementById('calendarCard');
            const detailToggleBtn = document.getElementById('detailToggleBtn');
            const calendarToggleBtn = document.getElementById('calendarToggleBtn');

            if (detailToggleBtn) detailToggleBtn.classList.toggle('active-view', viewName === 'overview');
            if (calendarToggleBtn) calendarToggleBtn.classList.toggle('active-view', viewName === 'calendar');

            // [PERBAIKAN] Cek null sebelum mengubah kelas
            if (viewName === 'overview') {
                if (overviewContainer) overviewContainer.classList.remove('view-hidden');
                if (calendarCard) calendarCard.classList.add('view-hidden');
            } else {
                if (overviewContainer) overviewContainer.classList.add('view-hidden');
                if (calendarCard) calendarCard.classList.remove('view-hidden');
                renderCalendar(); 
            }
        }
        function setCalendarFilter(filter) { 
            calendarFilter = filter;
            document.getElementById('tabPengeluaran')?.classList.toggle('active', filter === 'expense');
            document.getElementById('tabPenghasilan')?.classList.toggle('active', filter === 'income');
            document.getElementById('tabTotal')?.classList.toggle('active', filter === 'total');
            renderCalendar();
        }
        function renderCalendar() { 
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const date = new Date(year, month, i);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                dayEl.innerHTML = `<span class="date-number">${i}</span>`;
                
                let dailyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date); // Asumsi t.date adalah "YYYY-MM-DD"
                    const tDateLocal = new Date(tDate.getUTCFullYear(), tDate.getUTCMonth(), tDate.getUTCDate());
                    return tDateLocal.getDate() === i && tDateLocal.getMonth() === month && tDateLocal.getFullYear() === year;
                });

                if (calendarFilter === 'expense') { dailyTransactions = dailyTransactions.filter(t => t.type === 'expense'); } 
                else if (calendarFilter === 'income') { dailyTransactions = dailyTransactions.filter(t => t.type === 'income'); }
                
                const dailyTotal = dailyTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? -t.amount : t.amount), 0);
                
                if(dailyTotal !== 0){ 
                    const summaryEl = document.createElement('span'); 
                    summaryEl.className = 'day-summary'; 
                    summaryEl.style.backgroundColor = dailyTotal < 0 ? 'var(--expense-red)' : 'var(--income-green)'; 
                    if (calendarFilter === 'total' && dailyTotal > 0) summaryEl.style.backgroundColor = 'var(--income-green)'; 
                    summaryEl.textContent = `${dailyTotal < 0 ? '-' : ''}${Math.abs(dailyTotal/1000).toFixed(0)}k`; 
                    dayEl.appendChild(summaryEl); 
                }
                calendarGrid.appendChild(dayEl);
            }
            // Update total kalender
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const total = income - expense;
            const formatCurrency = (value) => { const num = Number(value) || 0; const sign = num < 0 ? '-' : ''; return `${sign}Rp${Math.abs(num).toLocaleString('id-ID')}`; };
            if(document.getElementById('calendarTotalAmount')) document.getElementById('calendarTotalAmount').textContent = formatCurrency(total);
            if(document.getElementById('calendarIncomeAmount')) document.getElementById('calendarIncomeAmount').textContent = formatCurrency(income);
            if(document.getElementById('calendarExpenseAmount')) document.getElementById('calendarExpenseAmount').textContent = formatCurrency(expense);
        }

        // --- (Fungsi Modal, Swipe, Collapse, Aksi, Navigasi, Kalkulator) ---
        
        // [Fungsi Modal Dompet]
        const walletModal = document.getElementById('wallet-modal-overlay');
        const walletListContainer = document.getElementById('wallet-list-container');
        async function openWalletSwitcher() {
            if (!walletModal || !walletListContainer) return;
            try {
                const currentWalletId = localStorage.getItem('currentWalletId');
                const wallets = await fetchApi('/wallets');
                walletListContainer.innerHTML = ''; 
                wallets.forEach(wallet => {
                    const item = document.createElement('div');
                    item.className = 'wallet-list-item';
                    item.textContent = wallet.name;
                    if (wallet.id === currentWalletId) {
                        item.classList.add('active');
                    }
                    item.onclick = () => selectWallet(wallet.id, wallet.name);
                    walletListContainer.appendChild(item);
                });
                walletModal.classList.add('visible');
            } catch (error) { console.error("Gagal membuka pengganti dompet:", error); alert("Gagal memuat daftar dompet."); }
        }
        function closeWalletSwitcher() { if (walletModal) { walletModal.classList.remove('visible'); } }
        function selectWallet(walletId, walletName) {
            localStorage.setItem('currentWalletId', walletId);
            localStorage.setItem('currentWalletName', walletName);
            closeWalletSwitcher();
            window.location.href = '/'; // Muat ulang untuk dompet baru
        }
        
        // [Fungsi Modal Transaksi]
        const txModal = document.getElementById('tx-modal-overlay');
        function openTransactionModal(tx) {
            if (!txModal) return;
            currentTransactionId = tx.id;
            document.getElementById('tx-modal-icon').textContent = tx.icon || tx.category.charAt(0);
            document.getElementById('tx-modal-category-name').textContent = tx.category;
            const amountEl = document.getElementById('tx-modal-amount');
            const amount = Number(tx.amount) || 0;
            const amountString = `${tx.type === 'expense' ? '-' : ''}Rp${amount.toLocaleString('id-ID')}`;
            amountEl.textContent = amountString;
            amountEl.style.color = tx.type === 'expense' ? 'var(--expense-red)' : 'var(--income-green)';
            const date = new Date(tx.date + 'T00:00:00');
            document.getElementById('tx-modal-date').textContent = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('tx-modal-account').textContent = tx.account;
            document.getElementById('tx-modal-notes').textContent = tx.notes;
            document.getElementById('tx-modal-wallet').textContent = localStorage.getItem('currentWalletName') || '...';
            txModal.classList.add('visible');
        }
        function closeTransactionModal() { if (txModal) { txModal.classList.remove('visible'); currentTransactionId = null; } }
        
        // [Fungsi Collapse]
        const COLLAPSED_KEY = 'casflo_collapsed_groups';
        function getCollapsedGroups() { try { const collapsed = localStorage.getItem(COLLAPSED_KEY); return collapsed ? JSON.parse(collapsed) : []; } catch (e) { return []; } }
        function saveCollapsedGroups(groups) { localStorage.setItem(COLLAPSED_KEY, JSON.stringify(groups)); }
        function toggleGroupCollapse(dateKey, headerElement) {
            const group = headerElement.closest('.transaction-group');
            if (!group) return;
            const isCollapsed = group.classList.toggle('collapsed');
            let collapsedGroups = getCollapsedGroups();
            if (isCollapsed) { if (!collapsedGroups.includes(dateKey)) { collapsedGroups.push(dateKey); } }
            else { collapsedGroups = collapsedGroups.filter(key => key !== dateKey); }
            saveCollapsedGroups(collapsedGroups);
        }
        
        // [Fungsi Swipe]
        function closeActiveSwipe() { if (activeSwipeElement) { activeSwipeElement.style.transform = 'translateX(0)'; activeSwipeElement = null; } }
        function handleTouchStart(e) { const targetContent = e.currentTarget; if (targetContent !== activeSwipeElement) { closeActiveSwipe(); } touchStartX = e.touches[0].clientX; touchCurrentX = touchStartX; touchStartY = e.touches[0].clientY; isSwiping = false; targetContent.style.transition = 'none'; }
        function handleTouchMove(e) { if (e.touches.length > 1) return; touchCurrentX = e.touches[0].clientX; const deltaX = touchCurrentX - touchStartX; if (!isSwiping) { const deltaY = e.touches[0].clientY - touchStartY; if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 10) { return; } } isSwiping = true; try { e.preventDefault(); } catch(err) {} let newTransform = deltaX; if (deltaX > 0) newTransform = 0; if (deltaX < -100) newTransform = -100; e.currentTarget.style.transform = `translateX(${newTransform}px)`; }
        function handleTouchEnd(e) { const targetContent = e.currentTarget; const actionWidth = 80; targetContent.style.transition = 'transform 0.3s ease-out'; if (isSwiping) { const deltaX = touchCurrentX - touchStartX; if (deltaX < swipeThreshold) { targetContent.style.transform = `translateX(-${actionWidth}px)`; activeSwipeElement = targetContent; } else { targetContent.style.transform = 'translateX(0)'; if (targetContent === activeSwipeElement) { activeSwipeElement = null; } } } }
        
        // [Aksi Klik Item]
        function handleItemClick(element) {
            if (!isSwiping && !activeSwipeElement) {
                const txData = JSON.parse(element.getAttribute('data-tx-json'));
                openTransactionModal(txData);
            } else if (activeSwipeElement) {
                closeActiveSwipe();
            }
            isSwiping = false; 
        }

        // [Fungsi Aksi Transaksi]
        async function handleDeleteTransaction(txId) {
            const transactionIdToDelete = txId || currentTransactionId;
            if (!transactionIdToDelete) return;
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;
            const walletId = localStorage.getItem('currentWalletId');
            try {
                await fetchApi(`/wallets/${walletId}/transactions/${transactionIdToDelete}`, { method: 'DELETE' });
                closeTransactionModal();
                closeActiveSwipe();
                loadMonthlyData(); // Muat ulang data bulanan
            } catch (error) { console.error('Gagal menghapus transaksi:', error); alert('Gagal menghapus: ' + error.message); }
        }
        function handleEditTransaction(txId) {
            const transactionIdToEdit = txId || currentTransactionId;
            if (!transactionIdToEdit) return;
            const tx = transactions.find(t => t.id === transactionIdToEdit);
            if (tx) {
                sessionStorage.setItem('tx_for_edit', JSON.stringify(tx));
                closeTransactionModal();
                closeActiveSwipe();
                navigate('/create');
            } else { alert('Gagal menemukan data transaksi untuk diedit.'); }
        }
        
        // [Fungsi Kalkulator & Halaman Create]
        function appendToCalc(value) { const operators = ['+', '-', '*', '/']; if (operators.includes(value)) { waitingForEquals = true; changeButtonToEquals(); } if (value === '.' && calcValue.includes('.')) { return; } if (calcValue === '0' && !operators.includes(value) && value !== '.') { calcValue = value; } else { const lastChar = calcValue.slice(-1); if (operators.includes(lastChar) && operators.includes(value)) { calcValue = calcValue.slice(0, -1) + value; } else { calcValue += value; } } updateDisplay(); }
        function deleteLast() { calcValue = calcValue.slice(0, -1) || '0'; checkWaitingForEquals(); updateDisplay(); }
        function handleActionClick() { if (waitingForEquals) { calculateResult(); } else if (currentTransactionId) { updateTransaction(); } else { saveTransaction(); } }
        function selectType(type) { currentType = type; document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active')); document.getElementById(type + 'Btn').classList.add('active'); selectedCategory = null; loadCategories(); }
        function updateDisplay() { const amountDisplay = document.getElementById('amountDisplay'); if (!amountDisplay) return; let parts = calcValue.split('.'); let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "."); let displayValue; if (parts.length > 1) { displayValue = integerPart + ',' + (parts[1] || ''); } else { displayValue = integerPart; } amountDisplay.textContent = displayValue; }
        function checkWaitingForEquals() { const hasOperator = ['+', '-', '*', '/'].some(op => calcValue.includes(op)); if (!hasOperator) { waitingForEquals = false; changeButtonToCheck(); } }
        function changeButtonToEquals() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn equals'; actionBtn.innerHTML = '<i class="fas fa-equals"></i>'; }}
        function changeButtonToCheck() { const actionBtn = document.getElementById('actionBtn'); if(actionBtn) { actionBtn.className = 'action-btn check'; actionBtn.innerHTML = '<i class="fas fa-check"></i>'; }}
        function calculateResult() { try { let expression = calcValue.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/,/g, '.'); const result = eval(expression); calcValue = String(result); waitingForEquals = false; changeButtonToCheck(); updateDisplay(); } catch (e) { calcValue = '0'; updateDisplay(); } }
        function clearCalc() { calcValue = '0'; waitingForEquals = false; changeButtonToCheck(); updateDisplay(); }
        function loadCategories() { const typeToFilter = currentType.toUpperCase(); const categories = allCategories.filter(cat => cat.type === typeToFilter); const recommendedGrid = document.getElementById('recommendedGrid'); const uncategorizedGrid = document.getElementById('uncategorizedGrid'); if(!recommendedGrid || !uncategorizedGrid) return; recommendedGrid.innerHTML = ''; uncategorizedGrid.innerHTML = ''; categories.slice(0, 4).forEach(cat => recommendedGrid.appendChild(createCategoryElement(cat))); categories.slice(4).forEach(cat => uncategorizedGrid.appendChild(createCategoryElement(cat))); }
        function createCategoryElement(category) { const div = document.createElement('div'); div.className = 'category-item'; div.onclick = () => selectCategory(category, div); const icon = category.icon || category.name.charAt(0).toUpperCase(); const defaultColor = 'var(--light-purple)'; div.innerHTML = `<div class="category-icon" style="background: ${defaultColor}">${icon}</div><div class="category-name">${category.name}</div>`; if (selectedCategory && category.id === selectedCategory.id) { div.classList.add('selected'); } return div; }
        function selectCategory(category, element) { selectedCategory = category; document.querySelectorAll('.category-item').forEach(item => item.classList.remove('selected')); element.classList.add('selected'); }
        async function saveTransaction() { try { const amount = parseFloat(calcValue.replace(/\./g, '').replace(',', '.')); if (isNaN(amount) || amount <= 0) { alert('Masukkan jumlah yang valid'); return; } if (!selectedCategory) { alert('Pilih kategori terlebih dahulu'); return; } const walletId = localStorage.getItem('currentWalletId'); const accountId = selectedAccountId; if (!walletId || !accountId) { console.error("currentWalletId atau selectedAccountId tidak ditemukan."); return; } const transactionDate = new Date().toISOString().split('T')[0]; const payload = { wallet_id: walletId, type: currentType.toUpperCase(), amount: amount, category_id: selectedCategory.id, description: selectedCategory.name, transaction_date: transactionDate, }; if (currentType === 'expense') { payload.from_account_id = accountId; } else { payload.to_account_id = accountId; } changeButtonToLoading(true); await fetchApi(`/wallets/${walletId}/transactions`, { method: 'POST', body: JSON.stringify(payload) }); clearCalc(); navigate('/'); } catch (error) { console.error('Error saving transaction:', error); alert(`Terjadi kesalahan: ${error.message}`); } finally { changeButtonToLoading(false); } }
        async function updateTransaction() { try { const amount = parseFloat(calcValue.replace(/\./g, '').replace(',', '.')); if (isNaN(amount) || amount <= 0) { alert('Masukkan jumlah yang valid'); return; } if (!selectedCategory) { alert('Pilih kategori terlebih dahulu'); return; } const walletId = localStorage.getItem('currentWalletId'); const accountId = selectedAccountId; if (!walletId || !accountId || !currentTransactionId) { alert('Data tidak lengkap untuk memperbarui transaksi.'); return; } const transactionDate = new Date().toISOString().split('T')[0]; const payload = { wallet_id: walletId, type: currentType.toUpperCase(), amount: amount, category_id: selectedCategory.id, description: selectedCategory.name, transaction_date: transactionDate, }; if (currentType === 'expense') { payload.from_account_id = accountId; } else { payload.to_account_id = accountId; } changeButtonToLoading(true); await fetchApi(`/wallets/${walletId}/transactions/${currentTransactionId}`, { method: 'PUT', body: JSON.stringify(payload) }); clearCalc(); currentTransactionId = null; navigate('/'); } catch (error) { console.error('Error updating transaction:', error); alert(`Terjadi kesalahan: ${error.message}`); } finally { changeButtonToLoading(false); } }
        function changeButtonToLoading(isLoading) { const actionBtn = document.getElementById('actionBtn'); if (!actionBtn) return; if (isLoading) { actionBtn.disabled = true; actionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; } else { actionBtn.disabled = false; checkWaitingForEquals(); } }
        function updateAccountIcon(accountId) { const account = allAccounts.find(acc => acc.id === accountId); if (!account) return; const accountCard = document.querySelector('.account-card'); if (accountCard) { const initial = account.name.substring(0, 2).toUpperCase(); accountCard.innerHTML = `<span style="font-size: 1.2rem; font-weight: 600;">${initial}</span>`; } }
        function selectAccount() { if (allAccounts.length === 0) return; const currentIndex = allAccounts.findIndex(acc => acc.id === selectedAccountId); const nextIndex = (currentIndex + 1) % allAccounts.length; const nextAccount = allAccounts[nextIndex]; selectedAccountId = nextAccount.id; updateAccountIcon(selectedAccountId); console.log(`Akun diubah ke: ${nextAccount.name}`); }

        // === BAGIAN 5: INISIALISASI HALAMAN & ROUTING ===
        function initMainPage() {
            console.log("Halaman Utama diinisialisasi (hanya listener statis).");
            // Pasang listener HANYA untuk elemen yang PASTI ADA saat skeleton dimuat
            document.getElementById('calendarPrevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('calendarNextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('tabPengeluaran')?.addEventListener('click', () => setCalendarFilter('expense'));
            document.getElementById('tabPenghasilan')?.addEventListener('click', () => setCalendarFilter('income'));
            document.getElementById('tabTotal')?.addEventListener('click', () => setCalendarFilter('total'));
        }
        function initCreatePage() { 
            // [PERBAIKAN] Cek apakah allCategories sudah dimuat
            if (allCategories.length === 0) {
                console.warn("Kategori belum dimuat. Coba lagi dalam 500ms");
                // Coba lagi setelah data (mungkin) selesai dimuat
                setTimeout(initCreatePage, 500);
                return;
            }
            const txToEditJSON = sessionStorage.getItem('tx_for_edit'); 
            if (txToEditJSON) { const tx = JSON.parse(txToEditJSON); currentTransactionId = tx.id; currentType = tx.type; calcValue = String(tx.amount); selectedAccountId = tx.account_id; selectedCategory = allCategories.find(c => c.id === tx.category_id); document.querySelectorAll('.type-btn-header').forEach(btn => btn.classList.remove('active')); document.getElementById(currentType + 'Btn').classList.add('active'); loadCategories(); updateDisplay(); updateAccountIcon(selectedAccountId); sessionStorage.removeItem('tx_for_edit'); } 
            else { currentTransactionId = null; currentType = 'expense'; document.getElementById('expenseBtn').classList.add('active'); document.getElementById('incomeBtn').classList.remove('active'); selectedCategory = null; clearCalc(); loadCategories(); updateAccountIcon(selectedAccountId); } 
            console.log(`Halaman Create dimuat (Mode: ${currentTransactionId ? 'Edit' : 'Baru'})`); 
        }
        function initWalletPage() { console.log("Halaman dompet dimuat."); attachThemeToggle('.theme-toggle'); /* ... (Logika load data dompet Anda) ... */ }
        function initAnalysisPage() { console.log("Halaman Analisis dimuat."); /* ... (Logika halaman analisis Anda) ... */ }
        function initMorePage() { 
            console.log("Halaman More dimuat."); 
            document.getElementById('logout-btn')?.addEventListener('click', () => { 
                if (confirm("Apakah Anda yakin ingin logout?")) { 
                    localStorage.removeItem('sessionToken'); 
                    window.location.href = '/login'; 
                } 
            }); 
            // [PERBAIKAN] Panggil attachThemeToggle di sini
            attachThemeToggle('.theme-toggle'); 
            
            // Logika animasi grid
            const gridItems = document.querySelectorAll('.more-grid .grid-item');
            if (gridItems.length > 0) {
                gridItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('visible');
                    }, index * 50);
                });
            }
        }
        
        // [Fungsi Routing SPA]
        const pageContainer = document.getElementById('app-container');
        const isBlobEnvironment = window.location.protocol === 'blob:';
        
        function runPageInit(path) {
            // [PERBAIKAN] Inisialisasi data header/bulanan HANYA di halaman utama
            if (path === '/') { 
                initMainPage();
                // Jika data global (akun, kategori) sudah ada, panggil loadMonthlyData
                // Jika belum (load pertama), loadHeaderData akan memanggilnya
                if (allAccounts.length > 0) {
                    loadMonthlyData();
                }
            } 
            else if (path === '/wallet') { initWalletPage(); } 
            else if (path === '/create') { initCreatePage(); }
            else if (path === '/more') { initMorePage(); }
            else if (path === '/analysis') { initAnalysisPage(); }
            
            // [PERBAIKAN] Selalu panggil applyTheme dan applyMaskingState setelah navigasi
            applyTheme(getSettings().theme);
            applyMaskingState(getSettings().isBalanceMasked || false);
        }
        
        function executePageScript(newContentElement) { /* ... (fungsi ini tidak berubah) ... */ }
        
        async function navigate(path) {
            if (isBlobEnvironment) { 
                const targetUrl = new URL(path, window.location.origin);
                window.location.href = targetUrl.href;
                return; 
            }
            
            if (!pageContainer) return;
            try {
                // [PERBAIKAN] Tampilkan skeleton header saat navigasi
                if (path !== '/') {
                    renderHeader(localStorage.getItem('currentWalletName') || '...');
                }

                const response = await fetch(path, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) { window.location.href = path; return; }
                const newContent = await response.text();
                
                // [PERBAIKAN] Logika navigasi yang benar
                // 1. Ganti konten
                const mainContentEl = document.querySelector('.main-content');
                const headerContainerEl = document.getElementById('header-container');
                const bottomNavEl = document.querySelector('.bottom-nav');
                const fabEl = document.querySelector('.fab');

                if (path === '/') {
                    // Jika kembali ke home, ganti seluruh isi app-container
                    pageContainer.innerHTML = newContent;
                } else {
                    // Jika ke halaman lain (create, wallet, dll)
                    // Hapus header, main-content, nav, fab
                    if (headerContainerEl) headerContainerEl.innerHTML = '';
                    if (mainContentEl) mainContentEl.innerHTML = '';
                    if (bottomNavEl) bottomNavEl.remove();
                    if (fabEl) fabEl.remove();
                    
                    // Masukkan konten halaman baru (cth: <div class="add-view ...">)
                    pageContainer.innerHTML = newContent; 
                }

                // 2. Update URL
                history.pushState({ path }, '', path);
                
                // 3. Jalankan skrip inisialisasi untuk halaman BARU
                runPageInit(path);

            } catch (error) {
                console.error("Gagal melakukan navigasi:", error);
                window.location.href = path;
            }
        }

        // [Fungsi Navigasi] - Tidak berubah
        document.addEventListener('click', (event) => { const anchor = event.target.closest('a'); if (anchor && anchor.href && new URL(anchor.href).origin === location.origin) { event.preventDefault(); const path = new URL(anchor.href).pathname; if (path !== location.pathname) { navigate(path); } } });
        window.addEventListener('popstate', (event) => { if (isBlobEnvironment) return; if (event.state && event.state.path) { (async () => { if (!pageContainer) return; try { const response = await fetch(event.state.path, { headers: { 'X-Requested-with': 'XMLHttpRequest' } }); if (!response.ok) { window.location.href = event.state.path; return; } const newContent = await response.text(); pageContainer.innerHTML = newContent; executePageScript(pageContainer); runPageInit(event.state.path); } catch (error) { console.error("Gagal memuat state:", error); window.location.href = event.state.path; } })(); } });

        // [FUNGSI UTAMA YANG DIROMBAK]
        // Ini adalah "bootloader" aplikasi Anda
        document.addEventListener('DOMContentLoaded', () => {
            // Cek Auth dipindahkan ke atas (sebelum script)
            
            // Pasang listener modal global
            document.getElementById('tx-modal-delete-btn')?.addEventListener('click', () => handleDeleteTransaction());
            document.getElementById('tx-modal-edit-btn')?.addEventListener('click', () => handleEditTransaction());

            if (!isBlobEnvironment) {
                history.replaceState({ path: location.pathname }, '', location.pathname);
            }
            
            // Terapkan tema & masking dari localStorage
            applyTheme(getSettings().theme);
            applyMaskingState(getSettings().isBalanceMasked || false);
            
            executePageScript(pageContainer); 

            // [PERUBAHAN UTAMA]
            if (!isAuthPage) {
                // 1. Panggil 'runPageInit' DULU untuk memasang listener dasar
                runPageInit(window.location.pathname);
                // 2. MULAI memuat data header (dan turunannya) secara asinkron
                //    Ini akan memuat data untuk halaman APAPUN
                loadHeaderData(); 
            } else {
                // Halaman auth (login, dll) bisa langsung jalan
                runPageInit(window.location.pathname); 
            }
        });

    </script>
</body>
</html>