<!DOCTYPE html>
<!-- [PERBAIKAN] Tag <html> ditambahkan untuk mode gelap -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casflo</title>
    
    <!-- [PERBAIKAN KUNCI] Skrip CDN Tailwind HARUS dimuat SEBELUM skrip konfigurasi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind
        tailwind.config = {
            darkMode: 'class' // Memberitahu Tailwind untuk mencari class="dark" di <html>
        }; // <-- [PERBAIKAN KUNCI] TITIK KOMA DITAMBAHKAN DI SINI

        // Skrip ini harus ada di <head> untuk mencegah layar putih berkedip (flickering)
        // saat mode gelap aktif.
        (function() {
            const settingsKey = 'casflo';
            let theme = 'system';
            try {
                const settings = localStorage.getItem(settingsKey);
                if (settings) {
                    theme = JSON.parse(settings).theme || 'system';
                }
            } catch (e) {
                // Biarkan default 'system'
            }
            
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Global & Halaman Utama */
        :root {
            --primary-blue: #4A47A3;
            --light-purple: #E6E6FA;
            --text-dark: #333;
            --text-light: #888;
            --expense-red: #E84545;
            --income-green: #51CF66;
            --bg-gray: #f4f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html { height: -webkit-fill-available; }
        body { 
            background: var(--bg-gray); 
            color: var(--text-dark); 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            touch-action: manipulation; 
        }
        .app-container { 
            width: 100%; 
            min-height: 100vh; 
            min-height: 100svh; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        }

        /* [BARU] Aturan CSS untuk Mode Gelap */
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark .app-container {
            background-color: #1f2937; /* dark:bg-gray-800 */
        }
        .dark .card {
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            box-shadow: none;
        }
        .dark .main-content {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .dark .transaction-list, .dark .empty-transaction-list, .dark .category-list-card,
        .dark .account-list {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .transaction-item, .dark .account-item {
            border-bottom-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark .overview-card .stat-item .label, .dark .transaction-item .info .account, 
        .dark .transaction-item .details .notes, .dark .account-section-header,
        .dark .account-item .balance-info .currency, .dark .filter-bar {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .overview-card .date-selector, .dark .header-title, .dark .header-top .left .fa-search {
            color: white;
        }
        .dark .calendar-card, .dark .calendar-summary-tabs .tab {
            color: #d1d5db;
            border-color: #4b5563;
        }
        .dark .calendar-summary-tabs .tab.active {
            color: var(--primary-blue);
            background-color: var(--light-purple);
            border-color: var(--primary-blue);
        }
        .dark .bottom-nav {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border-top: 1px solid #374151;
        }
        .dark .nav-item {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark .nav-item.active {
            color: var(--primary-blue); /* Tetap biru agar menonjol */
        }
        .dark .fab {
            background-color: #374151;
            color: var(--primary-blue);
            border: 1px solid #4b5563;
        }
        .dark .more-grid .grid-item {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db;
        }
        .dark .wallet-header, .dark .analysis-header, .dark .more-header {
             background: var(--primary-blue); /* Tetap biru */
        }
        .dark .account-list {
             background-color: #374151;
        }
        .dark .stats-container .amount, .dark .account-item .details, .dark .account-item .balance-info .amount {
            color: white;
        }
        .dark .stats-container .main-balance .amount {
             color: white;
        }
        .dark .account-item .balance-info .amount.expense,
        .dark .overview-card .stat-item .amount.expense {
            color: var(--expense-red);
        }
        .dark .donut-chart-card, .dark .category-list-card {
            background-color: #374151;
        }
        .dark .donut-chart-center .amount {
            color: white;
        }
        .dark .add-view-container {
            background-color: #1f2937;
        }
        .dark .add-header, .dark .categories-section {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .dark .type-selector-header {
            background: #1f2937;
        }
        .dark .type-btn-header {
            color: #9ca3af;
        }
        .dark .type-btn-header.active {
            background: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dark .type-btn-header.expense.active { color: var(--expense-red); }
        .dark .type-btn-header.income.active { color: var(--income-green); }
        .dark .calculator-section {
            background: #1f2937;
            border-top-color: #4b5563;
        }
        .dark .amount-display, .dark .action-btn, .dark .calc-btn {
            background: #374151;
            color: #d1d5db;
            box-shadow: none;
        }
        .dark .action-btn.personal {
            background: #111827;
        }
        .dark .calc-btn.operator {
            background: #4b5563;
        }
        .dark .category-item:hover {
            background: #4b5563;
        }

        /* ... Sisa CSS Global Anda ... */
        .main-header { background: var(--primary-blue); color: white; padding: 20px 20px 20px 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; flex-shrink: 0; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-top .left { display: flex; align-items: center; gap: 18px; }
        .view-toggle-group { display: flex; align-items: center; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 4px; }
        .toggle-btn { background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 16px; display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .toggle-btn.active-view { background: rgba(255,255,255,0.2); }
        .toggle-btn span { display: inline-block; transition: max-width 0.3s ease-in-out, opacity 0.2s ease-in-out, margin-left 0.3s ease-in-out; max-width: 100px; opacity: 1; margin-left: 5px; overflow: hidden; }
        .toggle-btn:not(.active-view) span { max-width: 0; opacity: 0; margin-left: 0; }
        .toggle-btn:not(.active-view) { padding: 8px 10px; }
        .header-title { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .header-actions { display: flex; gap: 15px; }
        .action-box { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; flex: 1; }
        .action-box .icon { background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .action-box .text { font-size: 14px; }
        .main-content { flex: 1; overflow-y: auto; padding: 0 20px; position: relative; z-index: 5; padding-bottom: 100px; background-color: var(--bg-gray); }
        .card { background: white; border-radius: 18px; margin-bottom: 20px; margin-top: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); padding: 18px; }
        .empty-transaction-list { text-align: center; color: #888; padding: 40px 0; }
        .view-hidden { display: none; }
        .overview-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overview-card .card-header .icon { width: 40px; height: 40px; background: var(--light-purple); color: var(--primary-blue); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .overview-card .date-selector { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .overview-card .date-selector i { cursor: pointer; }
        .overview-card .card-actions { display: flex; gap: 12px; }
        .overview-card .card-actions .icon { color: var(--text-light); }
        .overview-card .card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; padding-top: 5px; }
        .overview-card .stat-item .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .overview-card .stat-item .amount { font-size: 16px; font-weight: 700; }
        .overview-card .stat-item .amount.expense { color: var(--expense-red); }
        .calendar-card .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 600; }
        .calendar-card .calendar-header i { cursor: pointer; }
        .calendar-card .calendar-header .month-year { font-size: 16px; }
        .calendar-card .calendar-header .btn-month-toggle { background-color: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; }
        .calendar-weekdays .day-name.weekend { color: var(--expense-red); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day { font-size: 14px; padding: 5px 0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; cursor: pointer; }
        .calendar-grid .day.weekend { color: var(--expense-red); }
        .calendar-grid .day.selected .date-number { background-color: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .calendar-grid .day .day-summary { font-size: 8px; color: white; background-color: var(--expense-red); border-radius: 5px; padding: 1px 3px; position: absolute; bottom: 0; }
        .calendar-summary-tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; border-bottom: 1px solid var(--bg-gray); padding-bottom: 20px; }
        .calendar-summary-tabs .tab { background: none; border: 1px solid #ddd; border-radius: 20px; padding: 6px 15px; font-size: 13px; color: var(--text-light); cursor: pointer; }
        .calendar-summary-tabs .tab.active { border-color: var(--primary-blue); color: var(--primary-blue); background-color: var(--light-purple); }
        .calendar-summary-amounts { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .calendar-summary-amounts .label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .calendar-summary-amounts .amount { font-size: 16px; font-weight: 700; }
        .calendar-summary-amounts .amount.expense { color: var(--expense-red); }
        .transaction-list .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .transaction-list .list-header .date-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .transaction-list .list-header .summary { font-size: 13px; color: var(--text-light); }
        .transaction-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid var(--bg-gray); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:first-of-type { padding-top: 5px; }
        .transaction-item .icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .category { font-weight: 600; font-size: 15px; }
        .transaction-item .details .notes { font-size: 12px; color: var(--text-light); }
        .transaction-item .info { text-align: right; }
        .transaction-item .info .amount { font-weight: 700; color: var(--expense-red); font-size: 15px; }
        .transaction-item .info .account { font-size: 12px; color: var(--text-light); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; color: var(--primary-blue); z-index: 15; text-decoration: none; }
        .fab i { font-size: 22px; }
        .bottom-nav { position: fixed; max-width: 480px; margin: 0 auto; bottom: 0; left: 0; right: 0; width: 100%; background: white; height: 80px; display: flex; justify-content: space-around; align-items: center; padding-bottom: 0px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); text-decoration: none; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary-blue); }

        @media (min-width: 768px) {
            body { background-color: #e9ecef; }
            .app-container { max-width: 480px; margin: 0 auto; height: 100vh; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            /* [BARU] Aturan mode gelap untuk desktop */
            .dark body { background-color: #111827; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        {{PAGE_CONTENT}}
    </div>

    <script>
        // === [BARU] BAGIAN 0: LOGIKA MODE GELAP/TERANG ===
        const settingsKey = 'casflo'; 
        const htmlEl = document.documentElement;

        function getSettings() {
            try {
                const settings = localStorage.getItem(settingsKey);
                // Default jika tidak ada settings: { theme: 'system' }
                return settings ? JSON.parse(settings) : { theme: 'system' };
            } catch (e) {
                return { theme: 'system' }; // Fallback jika JSON rusak
            }
        }

        function saveSettings(settingsObject) {
            try {
                // Ambil settings yang ada, lalu gabungkan dengan yang baru
                const existingSettings = getSettings();
                const newSettings = { ...existingSettings, ...settingsObject };
                localStorage.setItem(settingsKey, JSON.stringify(newSettings));
            } catch (e) {
                console.error("Gagal menyimpan settings:", e);
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else if (theme === 'light') {
                htmlEl.classList.remove('dark');
            } else {
                // Mode 'system' (default)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            }
        }
        
        // Fungsi ini dipanggil oleh init...Page()
        function attachThemeToggle(selector) {
            const themeToggleBtn = document.querySelector(selector);
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const isCurrentlyDark = htmlEl.classList.contains('dark');
                    const newTheme = isCurrentlyDark ? 'light' : 'dark';
                    applyTheme(newTheme); 
                    saveSettings({ theme: newTheme }); // Simpan pilihan baru
                });
            }
        }
        // --- [AKHIR BAGIAN 0] ---


        // === BAGIAN 1: VARIABEL & FUNGSI GLOBAL ===
        let currentDate = new Date();
        let selectedDate = new Date();
        let transactions = []; // Data dummy, ganti dengan API call
        let currentView = 'overview';
        let calendarFilter = 'expense';
        // Variabel global untuk 'create.html'
        let currentType = 'expense';
        let selectedCategory = null;
        let calcValue = '0';
        let waitingForEquals = false;

        const expenseCategories = [ { id: 1, name: 'Makanan', icon: 'üçî', color: '#FEF3E2' }, { id: 2, name: 'Kebutuhan', icon: 'ü™¥', color: '#E6F3F2' }, { id: 3, name: 'Transport', icon: 'üöó', color: '#EBE9F9' }, { id: 4, name: 'Belanja', icon: 'üõçÔ∏è', color: '#FCE8E7' }, { id: 5, name: 'Hiburan', icon: 'üéÆ', color: '#D4EDDA' }, { id: 6, name: 'Kesehatan', icon: '‚ù§Ô∏è', color: '#F8D7DA' }, { id: 7, name: 'Pendidikan', icon: 'üéì', color: '#D1ECF1' }, { id: 8, name: 'Tagihan', icon: 'üßæ', color: '#FADBD8' }, { id: 9, name: 'Cicilan', icon: 'üè†', color: '#D6EAF8' }, { id: 10, name: 'Listrik', icon: 'üí°', color: '#FCF3CF' }, { id: 11, name: 'Air', icon: 'üíß', color: '#D4E6F1' }, { id: 12, name: 'Internet', icon: 'üåê', color: '#E8DAEF' }, { id: 13, name: 'Pakaian', icon: 'üëï', color: '#D1F2EB' }, { id: 14, name: 'Langganan', icon: 'üîÅ', color: '#FDEDEC' }, { id: 15, name: 'Hadiah', icon: 'üéÅ', color: '#FDEBD0' }, { id: 16, name: 'Donasi', icon: 'üíñ', color: '#E6F3F2' }, { id: 17, name: 'Liburan', icon: '‚úàÔ∏è', color: '#EBE9F9' }, { id: 18, name: 'Anak', icon: 'üë∂', color: '#FCE8E7' }, { id: 19, name: 'Pajak', icon: 'üèõÔ∏è', color: '#D5DBDB' }, { id: 20, name: 'Asuransi', icon: 'üõ°Ô∏è', color: '#D6EAF8' }, { id: 21, name: 'Olahraga', icon: '‚öΩÔ∏è', color: '#D4EDDA' }, { id: 22, name: 'Peliharaan', icon: 'üêæ', color: '#FEF3E2' }, { id: 23, name: 'Perawatan', icon: 'üíÖ', color: '#F8D7DA' }, { id: 24, name: 'Perabotan', icon: 'üõãÔ∏è', color: '#FDEBD0' }, { id: 25, name: 'Bensin', icon: '‚õΩÔ∏è', color: '#FADBD8' }, { id: 26, name: 'Lainnya', icon: '...', color: '#F8F9FA' } ];
        const incomeCategories = [ { id: 101, name: 'Gaji', icon: 'üí∞', color: '#D4EDDA' }, { id: 102, name: 'Bonus', icon: 'üèÜ', color: '#D1ECF1' }, { id: 103, name: 'Investasi', icon: 'üìà', color: '#E2E3E5' }, { id: 104, name: 'Freelance', icon: 'üíª', color: '#FCF3CF' }, { id: 105, name: 'Hadiah', icon: 'üéÅ', color: '#FDEBD0' }, { id: 106, name: 'Penjualan', icon: 'üè∑Ô∏è', color: '#E8DAEF' }, { id: 107, name: 'Sewa', icon: 'üîë', color: '#D6EAF8' }, { id: 108, name: 'Lainnya', icon: '...', color: '#F8F9FA' } ];
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // --- [PERBAIKAN KALENDER] Fungsi Halaman Utama ---
        function setView(viewName) {
            currentView = viewName;
            localStorage.setItem('preferredView', viewName);
            const overviewCard = document.getElementById('overviewCard');
            const calendarCard = document.getElementById('calendarCard');
            const detailToggleBtn = document.getElementById('detailToggleBtn');
            const calendarToggleBtn = document.getElementById('calendarToggleBtn');

            if (detailToggleBtn) detailToggleBtn.classList.toggle('active-view', viewName === 'overview');
            if (calendarToggleBtn) calendarToggleBtn.classList.toggle('active-view', viewName === 'calendar');

            if (viewName === 'overview') {
                if (overviewCard) overviewCard.classList.remove('view-hidden');
                if (calendarCard) calendarCard.classList.add('view-hidden');
            } else {
                if (overviewCard) overviewCard.classList.add('view-hidden');
                if (calendarCard) calendarCard.classList.remove('view-hidden');
                renderCalendar(); 
            }
        }
        function updateMonthDisplay() { 
            const display = document.getElementById('currentMonthDisplay');
            const calendarDisplay = document.getElementById('calendarMonthYear');
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            if (display) {
                display.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;
            }
            if (calendarDisplay) {
                 calendarDisplay.textContent = `${monthNames[month]} ${year}`;
            }
            updateMainView(); 
        }
        function goToPrevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function goToNextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); if(currentView === 'calendar') { renderCalendar(); } updateMonthDisplay(); }
        function setCalendarFilter(filter) { 
            calendarFilter = filter;
            if (document.getElementById('tabPengeluaran')) document.getElementById('tabPengeluaran').classList.toggle('active', filter === 'expense');
            if (document.getElementById('tabPenghasilan')) document.getElementById('tabPenghasilan').classList.toggle('active', filter === 'income');
            if (document.getElementById('tabTotal')) document.getElementById('tabTotal').classList.toggle('active', filter === 'total');
            renderCalendar();
        }
        function renderCalendar() { 
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            console.log("Merender kalender..."); // Log untuk debugging
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.insertAdjacentHTML('beforeend', `<div></div>`); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const date = new Date(year, month, i);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) dayEl.classList.add('weekend');
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                dayEl.innerHTML = `<span class="date-number">${i}</span>`;
                // ... (logika dummy summary)
                calendarGrid.appendChild(dayEl);
            }
        }
        function renderTransactionList(filteredTransactions) { 
            const transactionListEl = document.querySelector('.transaction-list');
            if (!transactionListEl) return;
            transactionListEl.innerHTML = '';
            if (filteredTransactions.length === 0) {
                transactionListEl.innerHTML = `<div class="empty-transaction-list">Belum ada transaksi di bulan ini</div>`;
                return;
            }
            // ... (logika dummy render)
            const listHeader = document.createElement('div');
            listHeader.className = 'list-header';
            listHeader.innerHTML = `<div class="date-info"><i class="fas fa-chevron-down fa-xs"></i><span>04/11</span></div><div class="summary">Pengeluaran: Rp0</div>`;
            transactionListEl.appendChild(listHeader);
        }
        function updateMainView() { 
            console.log("Memuat data untuk", currentDate.toISOString().slice(0, 7));
            // Di sini Anda akan memanggil API...
            // Untuk saat ini, kita gunakan data dummy:
            const filteredTransactions = transactions.filter(t => new Date(t.date).getMonth() === currentDate.getMonth() && new Date(t.date).getFullYear() === currentDate.getFullYear());
            const income = 0;
            const expense = 0;
            const total = income - expense;
            const formatCurrency = (value) => { const sign = value < 0 ? '-' : ''; return `${sign}Rp${Math.abs(value).toLocaleString('id-ID')}`; };
            
            if(document.getElementById('totalAmount')) document.getElementById('totalAmount').textContent = formatCurrency(total);
            if(document.getElementById('incomeAmount')) document.getElementById('incomeAmount').textContent = formatCurrency(income);
            if(document.getElementById('expenseAmount')) document.getElementById('expenseAmount').textContent = formatCurrency(expense);
            if(document.getElementById('calendarTotalAmount')) document.getElementById('calendarTotalAmount').textContent = formatCurrency(total);
            if(document.getElementById('calendarIncomeAmount')) document.getElementById('calendarIncomeAmount').textContent = formatCurrency(income);
            if(document.getElementById('calendarExpenseAmount')) document.getElementById('calendarExpenseAmount').textContent = formatCurrency(expense);
            
            renderTransactionList(filteredTransactions.sort((a, b) => b.id - a.id));
            if(currentView === 'calendar') renderCalendar();
        }
        // --- [AKHIR PERBAIKAN KALENDER] ---


        // === BAGIAN 2: KUMPULAN SEMUA FUNGSI INISIALISASI HALAMAN ===
        
        function initMainPage() {
            console.log("Halaman Utama diinisialisasi.");
            document.getElementById('detailToggleBtn')?.addEventListener('click', () => setView('overview'));
            document.getElementById('calendarToggleBtn')?.addEventListener('click', () => setView('calendar'));
            document.getElementById('prevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('nextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('calendarPrevMonthBtn')?.addEventListener('click', goToPrevMonth);
            document.getElementById('calendarNextMonthBtn')?.addEventListener('click', goToNextMonth);
            document.getElementById('tabPengeluaran')?.addEventListener('click', () => setCalendarFilter('expense'));
            document.getElementById('tabPenghasilan')?.addEventListener('click', () => setCalendarFilter('income'));
            document.getElementById('tabTotal')?.addEventListener('click', () => setCalendarFilter('total'));
            
            const savedView = localStorage.getItem('preferredView');
            if (document.getElementById('detailToggleBtn')) { 
                 setView(savedView || 'overview');
            }
            if (document.getElementById('currentMonthDisplay')) {
                updateMonthDisplay();
            }
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle'); 
        }
        
        function initCreatePage() {
            console.log("Halaman Create diinisialisasi.");
            if (typeof initCreatePageInternal === 'function') {
                initCreatePageInternal();
            }
        }

        function initWalletPage() { 
            console.log("Halaman dompet dimuat."); 
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }
        
        function initMorePage() {
             console.log("Halaman Lebih diinisialisasi.");
             if (typeof initMorePageInternal === 'function') {
                initMorePageInternal();
            }
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }
        
        function initAnalysisPage() {
             console.log("Halaman Analisis diinisialisasi!");
             if (typeof initAnalysisPageInternal === 'function') {
                initAnalysisPageInternal();
            }
            // [BARU] Pasang listener untuk tombol mode gelap/terang di halaman ini
            attachThemeToggle('.theme-toggle');
        }

        // === BAGIAN 3: LOGIKA SPA ROUTING (DENGAN PERBAIKAN) ===
        
        const pageContainer = document.getElementById('app-container');
        const isBlobEnvironment = window.location.protocol === 'blob:';

        function runPageInit(path) {
            if (path === '/') { initMainPage(); } 
            else if (path === '/wallet') { initWalletPage(); } 
            else if (path === '/create') { initCreatePage(); }
            else if (path === '/more') { initMorePage(); }
            else if (path === '/analysis') { initAnalysisPage(); }
        }

        function executePageScript(newContentElement) {
            const oldScript = document.getElementById('page-specific-script');
            if (oldScript) {
                oldScript.parentNode.removeChild(oldScript);
            }
            const scriptTemplate = newContentElement.querySelector('script[type="text/javascript-template"]');
            if (scriptTemplate) {
                try {
                    const newScript = document.createElement('script');
                    newScript.id = 'page-specific-script';
                    newScript.textContent = scriptTemplate.textContent;
                    document.body.appendChild(newScript);
                } catch (e) {
                    console.error("Error executing page script:", e);
                }
            }
        }
        
        async function navigate(path) {
            if (isBlobEnvironment) { 
                const targetUrl = new URL(path, window.location.origin);
                window.location.href = targetUrl.href;
                return; 
            }
            
            if (!pageContainer) return;
            try {
                const response = await fetch(path, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) { window.location.href = path; return; }
                const newContent = await response.text();
                
                history.pushState({ path }, '', path);
                pageContainer.innerHTML = newContent;
                executePageScript(pageContainer);
                runPageInit(path);

            } catch (error) {
                console.error("Gagal melakukan navigasi:", error);
                window.location.href = path;
            }
        }

        document.addEventListener('click', (event) => {
            const anchor = event.target.closest('a');
            if (anchor && anchor.href && new URL(anchor.href).origin === location.origin) {
                event.preventDefault();
                const path = new URL(anchor.href).pathname;
                if (path !== location.pathname) {
                    navigate(path);
                }
            }
        });

        window.addEventListener('popstate', (event) => {
            if (isBlobEnvironment) return; 
            if (event.state && event.state.path) {
                (async () => {
                    if (!pageContainer) return;
                    try {
                        const response = await fetch(event.state.path, { headers: { 'X-Requested-with': 'XMLHttpRequest' } });
                        if (!response.ok) { window.location.href = event.state.path; return; }
                        const newContent = await response.text();
                        pageContainer.innerHTML = newContent;
                        executePageScript(pageContainer);
                        runPageInit(event.state.path);
                    } catch (error) {
                         console.error("Gagal memuat state:", error);
                         window.location.href = event.state.path;
                    }
                })();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // [PERBAIKAN KUNCI] Pengecekan keamanan untuk session token
            const sessionToken = localStorage.getItem('sessionToken');
            const isAuthPage = window.location.pathname === '/login' || 
                               window.location.pathname === '/create-account' || 
                               window.location.pathname === '/two-step' ||
                               window.location.pathname === '/auth/callback';

            if (sessionToken && isAuthPage) {
                window.location.href = '/';
                return;
            }

            if (!sessionToken && !isAuthPage) {
                window.location.href = '/login';
                return;
            }
            // --- [Akhir Perbaikan Keamanan] ---


            if (!isBlobEnvironment) {
                history.replaceState({ path: location.pathname }, '', location.pathname);
            }
            
            // [PERBAIKAN] Terapkan tema saat halaman pertama kali dimuat
            applyTheme(getSettings().theme);
            executePageScript(pageContainer); 
            runPageInit(location.pathname);
        });
    </script>
</body>
</html>

